<script>
// SkyWalk Application

// Copyright (c) 2025 Erdogan Taskesen
// Author: Erdogan Taskesen

// License: Non-Commercial Source-Available License

// Permission is hereby granted for non-commercial purposes only.
// Non-commercial use includes academic, educational, and personal use.

// Commercial use is strictly prohibited without prior written permission
// from the author. Commercial use includes, but is not limited to:
// - Use by for-profit entities
// - Internal business use
// - Software-as-a-Service (SaaS)
// - Consulting, client work, or service delivery
// - Redistribution as part of a paid product
// - Resale or monetization in any form

// Any commercial use requires an explicit, separate commercial license
// obtained from the author.

// DISCLAIMER OF WARRANTY AND LIABILITY

// This software is provided "AS IS", without warranty of any kind,
// express or implied, including but not limited to the warranties of
// merchantability, fitness for a particular purpose, accuracy, or
// non-infringement.

// The entire risk arising out of the use or performance of this software
// is assumed by the user. In no event shall the author be liable for any
// claim, damages, or other liability, whether in an action of contract,
// tort, or otherwise, arising from, out of, or in connection with the
// software or the use or other dealings in the software.

// Contact:
// For commercial licensing requests, contact:
// <motel_voluten_7n@icloud.com>
</script>


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Skywalk Flightplan</title>

    <!--RUN FULL SCREEN-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2A3F54">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">

    <!--ICON-->
    <link rel="shortcut icon" type="image/png" href="./icons/airplane_gray.png">
    <link rel="icon" type="image/png" sizes="16x16 32x32" href="./icons/airplane_gray.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icons/airplane_gray.png">

    <!--STYLESHEETS-->
    <link rel="stylesheet" href="style.css">

    <!--CORE FILES-->
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
    <script src="./libs/plotly-2.35.2.min.js"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="./libs/leaflet.css">
    <script src="./libs/leaflet.js"></script>

    <!--APP FILES-->
    <link rel="manifest" href="/manifest.json">
    <script src="app.js"></script>

    <!--SCRIPTS-->
    <script src="./scripts/config.js" defer></script>
    <script src="./scripts/core.js" defer></script>
    <script src="./scripts/flashcard.js" defer></script>
    <script src="./scripts/widgets.js" defer></script>
    <!--ANIMATION SCRIPTS-->
    <script src="./scripts/rain.js" defer></script>
    <script src="./scripts/cloud.js" defer></script>
    <script src="./scripts/fog.js" defer></script>
    <script src="./scripts/sun.js" defer></script>
    <script src="./scripts/snow.js" defer></script>
    <script src="./scripts/dark.js" defer></script>
    <script src="./scripts/cloudPlot.js" defer></script>
    <!--<script src="./scripts/textoverlay.js" defer></script>-->
    <script src="./scripts/metar.js" defer></script>
    <!--MAP-->
    <script src="./scripts/maps.js" defer></script>
    <script src="./scripts/weightbalance.js" defer></script>
    <script src="./scripts/windenvelope.js" defer></script>
    <script src="./scripts/fuel.js" defer></script>
    <!--RUNWAY-->
    <script src="./scripts/runway.js" defer></script>
    <script src="./scripts/runwayUI.js" defer></script>
    <!--CHECKLIST-->
    <script src="./scripts/checklist.js" defer></script>
    <!--GENERIC-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

</head>


<body>

<div id="app">
        <!--<div id="loading-spinner" class="spinner-overlay" style="display: flex;">
            <div class="spinner-container">
                <div class="spinner"></div>
                <div class="spinner-text">Loading SkyWalk. Please wait..</div>
            </div>
        </div>-->

    <!-- Tab links -->
    <div class="tab">
        <button class="tablinks active" data-tab="General">‚ñ∂Ô∏è Start</button>
        <button class="tablinks" data-tab="Departure">üõ´ Departure</button>
        <button class="tablinks" data-tab="Arrival">üõ¨ Arrival</button>
        <button class="tablinks" data-tab="Enroute">‚úàÔ∏è Enroute</button>
        <button class="tablinks" data-tab="ATC">üéôÔ∏è ATC</button>
        <button class="tablinks" data-tab="More">‚ò∞ More</button>
    </div>

	<div id="More" class="tabcontent">
	    <label_h1>More</label_h1>

        <div style="border: 0px solid lightgrey; border-radius: 10px; padding: 10px;">
            <div id="bottom-container">
                <div class="info">
                    SkyWalk is a web-based tool designed to help pilots communicate effectively with Air Traffic Control (ATC). The app is free for use, is for educational purposes and does not require any registration or login. If you enjoy using SkyWalk, please consider supporting by donating a coffee.
                </div>
            </div>
        </div>

        <button class="tablinks" data-tab="MAP" style="cursor: pointer;">üó∫Ô∏è Map</button>
        <button class="tablinks" data-tab="Checklist" style="cursor: pointer;">üìã Checklist</button>
        <button class="tablinks" data-tab="Aircrafts" style="cursor: pointer;">üìê Aircrafts</button>
        <button class="tablinks" data-tab="Countries" style="cursor: pointer;">üåç Select Countries</button>
       	<button class="tablinks" data-tab="Config" style="cursor: pointer;">‚öôÔ∏è Config</button>
        <div class="button-row">
            <button id="BTN-WEIGHTBALANCE"
                type="button"
                onclick="window.open('https://www.vliegclubrotterdam.nl/wb/', '_blank')"
                title="Weight and Balance calculator vliegclub Rotterdam">
                    ‚öñÔ∏è Weight & Balance
            </button>
        </div>
        <!--CHECK FOR UPDATES-->
        <button id="updateBtn" onclick="updateApp()">Check for updates</button>
        <!--<script src="app.js"></script>-->

        <label_h1>Disclaimer</label_h1>
        <div class="disclaimer" style="margin-bottom: 20px; border: 2px solid red; border-radius: 10px; padding: 10px;">
            SkyWalk is provided "as is", without warranty of any kind,
            express or implied, including but not limited to the warranties of
            merchantability, fitness for a particular purpose, accuracy, or
            non-infringement.

            The entire risk arising out of the use or performance of this software
            is assumed by the user. In no event shall the author be liable for any
            claim, damages, or other liability, whether in an action of contract,
            tort, or otherwise, arising from, out of, or in connection with the
            software or the use or other dealings in the software.

            Skywalk is for academic, educational, and personal use only.
            Commercial use is strictly prohibited without prior written permission from the author.
        </div>

	</div>


    <!-- =============== TAB GENERAL =============== -->
	<div id="General" class="tabcontent">

        <!-- Logo -->
        <!--<div class="logo-container" style="margin-top: 20px; padding-bottom: 0px; margin: 0px;">-->
        <div class="border-round-eged-logo">
        <div class="logo-container">
            <a href="https://erdogant.github.io/skywalk-docs/pages/html/index.html" target="_blank">
                <img
                    id="SKYWALK_LOGO_image_cache"
                    alt="SkyWalk"
                    src="./figs/logo_skywalk.png"
                >

                <canvas class="rain-canvas" data-prefix="SKYWALK_LOGO"></canvas>
                <canvas class="cloud-canvas"  data-prefix="SKYWALK_LOGO"></canvas>
                <canvas class="fog-canvas"  data-prefix="SKYWALK_LOGO"></canvas>
                <canvas class="flare-canvas"  data-prefix="SKYWALK_LOGO"></canvas>
                <canvas class="snow-canvas"  data-prefix="SKYWALK_LOGO"></canvas>
                <canvas class="dark-canvas"  data-prefix="SKYWALK_LOGO"></canvas>

            </a>
            <div class="version" style="margin-bottom: 5px; ">version: 1.0.0</div>
        </div>
        </div>



        <div class="flight-card">
            <div class="route-header">

                <div class="airport">
                    <div class="airport-code">
                        <input id="DEPARTURE_ICAO" type="text" class="UPPERCASE_input" title="Departure ICAO"
                            style="font-size: 30px; font-weight: bold; color: #2c2c2c; margin-bottom: 2px; text-align: center;">
                    </div>
                    <div id="DEPARTURE_CITY" class="airport-name">DEPARTURE</div>
                    <div><img id="DEPARTURE_FLAG_2" src="" alt="" style="width:30px; height:auto; vertical-align:middle; margin-left:6px;"></div>
                    <div class="schedule-label">Scheduled</div>
                    <input type="time" id="DEPARTURE_clockField" class="clock-input" onclick="this.showPicker?.()" step="300">

                </div>

                <div class="plane-icon" onclick="handlePlaneClick()">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                    </svg>
                </div>

                <div class="airport">
                    <div class="airport-code">
                        <input id="ARRIVAL_ICAO" type="text" class="UPPERCASE_input" title="Arrival ICAO"
                            style="font-size: 30px; font-weight: bold; color: #2c2c2c; margin-bottom: 2px; text-align: center;">
                    </div>
                    <div id="ARRIVAL_CITY" class="airport-name">ARRIVAL</div>
                    <div><img id="ARRIVAL_FLAG_2" src="" alt="" style="width:30px; height:auto; vertical-align:middle; margin-left:6px;"></div>
                    <div class="schedule-label">Scheduled</div>
                    <input type="time" id="ARRIVAL_clockField" class="clock-input" onclick="this.showPicker?.()" step="300">
                </div>

            </div>

            <div class="divider-general-section">
                <svg class="divider-plane" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="#666" d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                </svg>
            </div>

            <div class="distance-section">
                <div class="distance-info">
                    <span id="DEPARTURE_FLIGHT_DISTANCE_INFO">Departure</span>
                    <span id="ARRIVAL_FLIGHT_DISTANCE_INFO">- km, - min.</span>
                </div>
            </div>
        </div>


        <!-- AIRCRAFT SECTION -->
        <div class="divider-general-section" style="background: #f5f5f5;"></div>

        <div class="flight-card">
            <div class="flight-card-row">

                <!-- LEFT 15% COLUMN -->
                <div class="flight-card-icon" onclick="handleRegistrationClick()">
                    <div class="plane-small">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                        </svg>
                    </div>
                </div>

                <!-- RIGHT 85% CONTENT -->
                <div class="flight-card-content">

                    <div class="route-header">
                        <div class="wind-grid">
                            <div class="aircraft" style="text-align: left;">
                                <span id="CALLSIGN_LABEL" class="tile-label" style="text-align: left;">REGISTRATION</span>
                                <input id="CALLSIGN" type="text" class="tile-value UPPERCASE_input"
                                       title="Registration of the aircraft"
                                       style="font-size: 14px; text-align: left">

                            </div>

                            <div class="aircraft" style="text-align: left;">
                                <span class="tile-label" style="text-align: left;">AIRCRAFT TYPE</span>
                                <input id="AIRCRAFT_TYPE" type="text"
                                       class="tile-value UPPERCASE_input"
                                       title="Aircraft Type (ROBIN, CESSNA)"
                                       style="font-size: 14px; text-align: left; ">
                            </div>
                        </div>
                    </div>

                    <div class="divider-general-section" style="background: #f0f0f0"></div>

                    <div class="wind-grid">
                        <div class="aircraft" style="text-align: left;">
                            <span class="tile-label" style="text-align: left;">PASSENGERS</span>
                            <input id="POB" type="text"
                                   class="tile-value UPPERCASE_input"
                                   title="Persons on Board"
                                   style="font-size: 14px; text-align: left">
                        </div>

                        <div class="aircraft" style="text-align: left;">
                            <span class="tile-label" style="text-align: left;">FLIGHT TYPE</span>
                            <select id="FLIGHT_RULES" class="tile-value-dropdown" style="text-align: left; background: transparent; ">
                                <option value="VFR">VFR</option>
                                <option value="IFR">IFR</option>
                            </select>
                        </div>
                    </div>

                </div>

            </div>
        </div>


        <div class="divider-general-section" style="background: #f5f5f5;"></div>


        <div class="flight-card">
            <div class="flight-card-row">

                <!-- LEFT 15% COLUMN -->
                <div class="flight-card-icon" onclick="window.save_flightplan()">
                    <div class="plane-small">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                        </svg>
                    </div>
                </div>


                <div class="flight-card-content">

                    <div class="wind-grid">
                        <div class="aircraft" style="text-align: left;">
                            <span id='DATETIME_CREATION' class="tile-label" style="text-align: left;">FLIGHT PLAN</span>
                            <input id="FLIGHTPLAN" type="text" class="tile-value UPPERCASE_input"
                                onchange="createDateTime()"
                                placeholder="My new flight plan"
                                title="Flightplan"
                                style="font-size: 20px; text-align: left;">
                        </div>
                    </div>

                    <div class="divider-general-section" style="background: #f0f0f0"></div>

                    <div class="wind-grid" style="display: flex; ">
                        <!-- Delete Button -->
                        <button id="delete_btn" style="display: flex; justify-content: left; align-items: left; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Delete Flight Plan">üóëÔ∏è</button>
                        <!-- Spinner -->
                        <div class="wind-grid">
                            <!--<span class="tile-label" style="text-align: left;">FLIGHT PLAN</span>-->
                            <select id="plan_spinner" class="tile-value-dropdown" onchange="this.value && window.load_flightplan()" style="text-align: left; background: lightgray; font-size: 12px; font-weight: normal;">
                                <option value="">Select and Load</option>
                            </select>
                        </div>
                        <!-- Clean Button -->
                        <button id="new_plan_btn" style="display: flex; justify-content: right; align-items: right; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Erase all fields and create new flight plan">üßπ</button>
                    </div>
                    <!-- Save button -->
                    <!--<button id="save_fields_btn" onclick="window.save_flightplan()" style="display: flex; justify-content: flex-end; align-items: center; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Save Flight Plan">üíæ</button>-->
                </div>

            </div>
        </div>

        <div class="divider-general-section" style="background: #f5f5f5;"></div>

        <!-- DEPARTURE Summary -->
        <div class="flight-card">
            <span class="tile-label" style="text-align: left; font-size: 14px; font-weight: bold;">DEPARTURE <span style="font-size: 8px;">OVERVIEW</span></span>
            <div class="summary-grid">
                <div id="DEPARTURE_FLASHCARD_FLIGHTRULES"></div>
                <div id="DEPARTURE_FLASHCARD_TEMPDEW"></div>
                <div id="DEPARTURE_FLASHCARD_DIRSTRENGTH"></div>
            </div>

            <div class="divider-general-section" style="background: #f0f0f0;"></div>

            <div class="summary-grid">
                <div id="DEPARTURE_FLASHCARD_WINDENV"></div>
                <div id="DEPARTURE_FLASHCARD_HEADWIND"></div>
                <div id="DEPARTURE_FLASHCARD_CROSSWIND"></div>
            </div>

            <div class="divider-general-section" style="background: #f0f0f0;"></div>

            <div class="summary-grid">
                <div id="DEPARTURE_FLASHCARD_RUNWAY_NR"></div>
                <div id="DEPARTURE_FLASHCARD_RUNWAY"></div>
                <div id="DEPARTURE_FLASHCARD_CLOUDS"></div>
            </div>

            <div class="divider-general-section" style="background: #f0f0f0;"></div>

            <div class="summary-grid">
                <div id="DEPARTURE_FLASHCARD_WEIGHT"></div>
                <div id="DEPARTURE_FLASHCARD_FUEL"></div>
            </div>
        </div>

        <!-- ARRIVAL Summary -->
        <div class="flight-card">
            <span class="tile-label" style="text-align: left; font-size: 14px; font-weight: bold;">ARRIVAL <span style="font-size: 8px;">OVERVIEW</span></span>
            <div class="summary-grid">
                <div id="ARRIVAL_FLASHCARD_FLIGHTRULES"></div>
                <div id="ARRIVAL_FLASHCARD_TEMPDEW"></div>
                <div id="ARRIVAL_FLASHCARD_DIRSTRENGTH"></div>
            </div>

            <div class="divider-general-section" style="background: #f0f0f0;"></div>

            <div class="summary-grid">
                <div id="ARRIVAL_FLASHCARD_WINDENV"></div>
                <div id="ARRIVAL_FLASHCARD_HEADWIND"></div>
                <div id="ARRIVAL_FLASHCARD_CROSSWIND"></div>
            </div>

            <div class="divider-general-section" style="background: #f0f0f0;"></div>

            <div class="summary-grid">
                <div id="ARRIVAL_FLASHCARD_RUNWAY_NR"></div>
                <div id="ARRIVAL_FLASHCARD_RUNWAY"></div>
                <div id="ARRIVAL_FLASHCARD_CLOUDS"></div>
            </div>

            <div class="divider-general-section" style="background: #f0f0f0;"></div>

            <div class="summary-grid">
                <div id="ARRIVAL_FLASHCARD_WEIGHT"></div>
                <div id="ARRIVAL_FLASHCARD_FUEL"></div>
            </div>
        </div>

        <!-- Bottom Buttons Container -->
        <div id="bottom-container">
            <div class="coffee-container">
                <a href="https://www.buymeacoffee.com/erdogant" target="_blank">
                    <img id="coffee_logo" alt="Coffee Donation" src="./figs/buy_me_a_coffee.png">
                </a>
            </div>

           	<center>
          		<script async src="https://media.ethicalads.io/media/client/ethicalads.min.js"></script>
          		<div data-ea-publisher="erdogantgithubio" data-ea-type="text"></div>
           	</center>
        </div>

	</div>


	<!-- ============================================= -->
	<!-- =============== TAB DEPARTURE =============== -->
	<!-- ============================================= -->

	<div id="Departure" class="tabcontent">

        <!-- Departure Information Label -->
        <label_h1>Departure Information</label_h1>

        <div class="logo-container">
            <!--Aerodrome image-->
            <img
                id="DEPARTURE_image_cache"
                alt="Departure Aerodrome"
                src="./figs/default_aerodrome.jpg"
                onclick="openAerodromeMap('DEPARTURE')"
            >
            <!--Rain overlay-->
            <canvas class="rain-canvas" data-prefix="DEPARTURE"></canvas>
            <canvas class="cloud-canvas"  data-prefix="DEPARTURE"></canvas>
            <canvas class="fog-canvas"  data-prefix="DEPARTURE"></canvas>
            <canvas class="flare-canvas"  data-prefix="DEPARTURE"></canvas>
            <canvas class="snow-canvas"  data-prefix="DEPARTURE"></canvas>
            <canvas class="dark-canvas"  data-prefix="DEPARTURE"></canvas>
            <!--<canvas class="textoverlay-canvas"  data-prefix="DEPARTURE"></canvas>-->
            <!--<canvas class="controls-canvas"  data-prefix="DEPARTURE"></canvas>-->
            <!--<div class="controls-wrapper" data-prefix="DEPARTURE">
              <canvas class="controls-canvas"></canvas>
            </div>-->

        </div>
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 0px; margin-top: 0px; padding-bottom: 0px; margin: 0px;">
            <button id="DEPARTURE_ANIMATION_START" title="Start the animation" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 0 8px 4px; flex: 0 0 auto; cursor: pointer;">‚ñ∂Ô∏è</button>
            <button id="DEPARTURE_ANIMATION_STOP" title="Stop the animation" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 0 8px 4px; flex: 0 0 auto; cursor: pointer;">‚è∏Ô∏è</button>
            <button id="DEPARTURE_ANIMATION_METARTEXT" title="Update animation directly on the METAR textfield" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 0 8px 4px; flex: 0 0 auto; cursor: pointer;">üîÄ</button>
        </div>


        <label_h1>Select Departure</label_h1>

        <div class="border-round-eged" id="DEPARTURE_SELECT_AERODROME_BORDER_1">
            <div class="wind-grid">
                <select id="DEPARTURE_COUNTRY" class="tile-value-dropdown" style="font-weight: normal;">
                    <option value="">Select Country</option>
                    <!-- ICAO City options will be populated dynamically IN import_country_selected()-->
                </select>
                <select id="DEPARTURE_ICAO_CITY" class="tile-value-dropdown" style="font-weight: normal;">
                    <option value="">Select ICAO</option>
                    <!-- ICAO City options will be populated dynamically IN populate_aerodrome_fields_from_icao()-->
                </select>
            </div>

            <div class="button-row">
                <img id="DEPARTURE_FLAG_1" src="" alt="" style="width:30px; height:auto; vertical-align:middle; margin-left:6px;">
                <img id="DEPARTURE_CATAGORY_ICON" src="" alt="" style="width:35px; height:auto; vertical-align:middle; margin-left:6px;">
                <img id="DEPARTURE_VFR_ICON" src="" alt="" style="width:70px; height:auto; vertical-align:middle; margin-left:6px;">
                <img id="DEPARTURE_METAR_WARNING" src="" alt="" style="width:70px; height:auto; vertical-align:middle; margin-left:6px;">
                <!--<button id="DEPARTURE_LOAD_ICAO" title="Reset to default aerodrome (ICAO) information" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 0 8px 4px; flex: 0 0 auto; cursor: pointer;">üè¨</button>-->
                <!--<button id="DEPARTURE_USE_CACHED" title="Retrieve most recent METAR weather information from Aviation weather" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 0 8px 4px; flex: 0 0 auto; cursor: pointer;">‚õÖ</button>-->
                <!--<input type="text" id="DEPARTURE_ICAO" class="tile-value UPPERCASE_input sync-departure" onchange="window.load_aerodrome_from_json('DEPARTURE')" placeholder="ICAO" disabled>-->
            </div>

        </div>


        <div class="collapsible" data-title="‚ö†Ô∏è METAR">
        <div class="collapsible-header" id="DEPARTURE_METARMENU_TOP"></div>
        <div class="collapsible-content" id="DEPARTURE_METARMENU_BACKGROUND">

            <div class="wind-grid">
                 <div class="tile">
                    <input id="DEPARTURE_WIND_DIRECTION" type="text" class="tile-value">
                    <span class="tile-label">Wind direction (¬∞)</span>
                </div>

                <div class="tile">
                    <input id="DEPARTURE_WIND_STRENGTH" type="text" class="tile-value">
                    <span class="tile-label">Strength (kt)</span>
                </div>

                <div class="tile">
                    <input id="DEPARTURE_WIND_GUST" type="text" class="tile-value">
                    <span class="tile-label">Gust (kt)</span>
                </div>
            </div>

            <div class="wind-grid">
                <div class="tile">
                    <input id="DEPARTURE_WIND_VARIATION" type="text" class="tile-value">
                    <span class="tile-label">Variation (¬∞)</span>
                </div>
                <div class="tile">
                    <input id="DEPARTURE_TEMPERATURE" type="text" class="tile-value">
                    <span class="tile-label">Temp. (C¬∞)</span>
                </div>
                <div class="tile">
                    <input id="DEPARTURE_QNH" type="text" class="tile-value">
                    <span class="tile-label">QNH</span>
                </div>
            </div>

            <div class="wind-grid">
                <div class="button-row">
                    <textarea id="METAR-FIELD-DEPARTURE"
                        placeholder="METAR Information"
                        title="METAR weather information"
                        style="font-size:12px; background-color: transparent; width: 100%; min-height: 80px; max-height: 120px; resize: vertical; padding: 8px; box-sizing: border-box; border-radius: 10px"
                        aria-label="METAR Information">
                    </textarea>
                </div>
            </div>

            <div style="display: flex; gap: 1px; margin-top: 1px;">
                <input type="text" id="METAR-TEXT-DEPARTURE" readonly
                    style="transition: background-color 0.3s; width: 70%;
                           padding: 0; box-sizing: border-box; font-size: 10px;
                           border: none; background-color: transparent;
                           color: #333333; outline: none;">

                <input type="text" id="DATETIME-METAR-DEPARTURE" readonly
                    style="transition: background-color 0.3s; width: 40%;
                           padding: 0; box-sizing: border-box; font-size: 10px;
                           border: none; background-color: transparent;
                           color: #333333; outline: none;">
            </div>

            <!--<button id="DEPARTURE_USE_CACHED" title="Retrieve most recent METAR weather information from Aviation weather" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 0 8px 4px; flex: 0 0 auto; cursor: pointer;">‚õÖ</button>-->
            <div class="button-row">
                <button id="DEPARTURE_USE_CACHED" class="button-style" title="Retrieve most recent METAR weather information from Aviation weather">
                    Refresh METAR Information
                </button>
            </div>

        </div>
        </div>


        <div class="collapsible" data-title="AERODROME">
        <div class="collapsible-header" id='DEPARTURE_AERODROME_MENU_TOP'></div>
        <div class="collapsible-content" id='DEPARTURE_AERODROME_MENU_BACKGROUND'>

            <div class="wind-grid">
                <div class="tile">
                    <input id="DEPARTURE_NAME" type="text" class="tile-value" title="Name of the aerodrome how it is known on the radio">
                    <span class="tile-label">Aerodrome name</span>
                </div>
            </div>

            <div class="grid-two-thirds-one-third">
                <div class="tile">
                    <input id="DEPARTURE_POSITION" type="text" class="tile-value UPPERCASE_input" title="Position of the Aircraft (at the apron)">
                    <span class="tile-label">Position of the aircraft</span>
                </div>

                <select id="DEPARTURE_CTR" class="tile-value-dropdown" onchange="highlightMissingFields(); highlightDropdownMenus('DEPARTURE')" style="text-align: center;">
                    <option value=""></option>
                    <option value="CTR">CTR</option>
                </select>
            </div>

            <div class="wind-grid">
                <div class="tile">
                    <input id="DEPARTURE_ROUTE_NAME" type="text" class="tile-value UPPERCASE_input" title="The name of the route (e.g., MIKE/ROMEO) for departure.">
                    <span class="tile-label">Name departure</span>
                </div>
                <div class="tile">
                    <input id="DEPARTURE_ROUTE_ALTITUDE" type="text" class="tile-value" title="The altitude of the route in feet.">
                    <span class="tile-label">Altitude departure (ft)</span>
                </div>
                <div class="tile">
                    <input id="DEPARTURE_CIRCUIT_ALTITUDE" type="text" class="tile-value" title="The altitude of the circuit in feet.">
                    <span class="tile-label">Altitude circuit(ft)</span>
                </div>
            </div>

            <!-- Cloud layers -->
            <div class="wind-grid">
                <div id="DEPARTURE_CLOUD_CONTAINER" style="display:none; margin-top: 8px;">
                    <canvas id="DEPARTURE_CLOUD_CANVAS"></canvas>
                </div>
            </div>

            <div class="button-row">
                <button id="DEPARTURE_LOAD_ICAO" class="button-style" title="Reset to default aerodrome (ICAO) information">
                    Reset aerodrome information
                </button>
                <button onclick="window.save_aerodrome_to_json('DEPARTURE')" title="Save custom aerodrome information" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 4px 8px 0; flex: 0 0 auto; cursor: pointer; float: right;">üíæ</button>
            </div>


        </div>
        </div>


         <div class="collapsible" data-title="CONTACT">
         <div class="collapsible-header" id="DEPARTURE_CONTACT_MENU"></div>
         <div class="collapsible-content" id="DEPARTURE_CONTACT_MENU_BACKGROUND">

             <div class="wind-grid">
                 <div class="tile">
                     <input id="DEPARTURE_ATC_GROUND" type="text" class="tile-value">
                     <span class="tile-label">Ground/ delivery (MHz)</span>
                 </div>
                 <div class="tile">
                     <input id="DEPARTURE_ATC_TOWER" type="text" class="tile-value">
                     <span class="tile-label">Tower/ Radio (MHz)</span>
                 </div>
                 <div class="tile">
                     <input id="DEPARTURE_ATC_ATIS_FREQ" type="text" class="tile-value">
                     <span class="tile-label">ATIS (MHz)</span>
                 </div>
             </div>

             <div class="grid-two-thirds-one-third">
                 <div class="tile">
                     <input id="DEPARTURE_ATC_TELEPHONE" type="text" class="tile-value">
                     <span class="tile-label">Telephone Number</span>
                 </div>
                 <div class="tile">
                     <input id="DEPARTURE_ATC_APPROACH" type="text" class="tile-value">
                     <span class="tile-label">Approach (MHz)</span>
                 </div>
             </div>

             <button onclick="window.save_aerodrome_to_json('DEPARTURE')" title="Save custom aerodrome information" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 4px 8px 0; flex: 0 0 auto; cursor: pointer; float: right;">üíæ</button>
         </div>
         </div>


        <label_h1>WIDGETS</label_h1>

        <!-- METAR Information -->
        <div class="collapsible" data-title="WIND ENVELOPE">
        <div class="collapsible-header" id="DEPARTURE_WIND_MENU"></div>
        <div class="collapsible-content">

            <div class="wind-grid">
                <div id="DEPARTURE_WINDENVELOPE_MESSAGE"></div>
            </div>

           <!-- WIND INFORMATION -->
           <div class="wind-grid">
               <div id="DEPARTURE_WIND_HEADWIND"></div>
               <div id="DEPARTURE_WIND_CROSSWIND"></div>
           </div>

           <div class="button-row" style="margin-bottom: 15px;">
               <div id="DEPARTURE_WIND_ENVELOPE_PLOT" style="width: 100%; box-sizing: border-box;"></div>
           </div>

           <div class="button-row">
               <button id="BTN-PLOT-WIND-DEPARTURE" class="button-style" onclick="window.windEnvelopeMain('DEPARTURE')">
                   Reset Plot
               </button>
           </div>

       </div>
       </div>


        <!--WEIGHT AND BALANCE ENVELOPE-->
        <div class="collapsible" data-title="WEIGHT AND BALANCE">
        <div class="collapsible-header" id="DEPARTURE_WB_MENU"></div>
        <div class="collapsible-content">

            <div class="wind-grid">
                <div id="DEPARTURE_WEIGHTBALANCE_MESSAGE"></div>
            </div>
            <div class="wind-grid">
                <div id="DEPARTURE_envelopeMessage" style="margin-top: 12px; padding: 10px; border-radius: 8px; font-size: 14px; text-align: center;"></div>
                <div id="DEPARTURE_fuelMessage" style="margin-top: 12px; padding: 10px; border-radius: 8px; font-size: 14px; text-align: center;"></div>
            </div>

            <!-- Totals Section -->
            <div class="border-round-eged">
                <div class="weight-card-header">Totals</div>
                <div class="wind-grid_3">
                    <input type="number" class="tile-value" id="DEPARTURE_total_moment" value="" disabled>
                    <input type="number" class="tile-value" id="DEPARTURE_total_weight" value="" disabled>
                    <input type="number" class="tile-value" id="DEPARTURE_takeoff_cg" value="" disabled>
                </div>
                <div class="wind-grid_3">
                    <span class="tile-label">Total Moment</span>
                    <span class="tile-label">Total Weight (kg)</span>
                    <span class="tile-label">Take off CG</span>
                </div>
            </div>


            <div class="border-round-eged" style="background-color: #ffffff;">

                <div class="grid-middle-small">
                    <div class="tile" style="border-color: transparent">
                        <input type="number" id="DEPARTURE_WEIGHT_FUEL_LITERS" value="">
                        <span class="tile-label">Fuel (liters)</span>
                    </div>
                </div>

                <!--ADD FRONT AIRCRAFT IMAGE-->
                <div class="logo-container">
                    <img id="AIRCRAFT_FRONT_IMAGE" src="./figs/aircraft_front.png">
                </div>

                <div class="wind-grid" style="margin:2; padding:0; gap:0; display:flex; align-items:center;">
                    <div class="tile" style="border-color: transparent; margin:2; padding:10; gap:2; align-items:center;">
                        <input type="number" id="DEPARTURE_WEIGHT_PILOT" value="" min="0">
                        <span class="tile-label">Pilot (kg)</span>
                    </div>
                    <div class="tile" style="border-color: transparent; margin:2; padding:10; gap:2; align-items:center;">
                        <input type="number" id="DEPARTURE_WEIGHT_COPILOT" value="" min="0">
                        <span class="tile-label">Front Passenger (kg)</span>
                    </div>
                </div>
                <div class="wind-grid" style="margin:2; padding:0; gap:0; display:flex; align-items:center;">
                    <div class="tile" style="border-color: transparent; margin:2; padding:10; gap:2; align-items:center;">
                        <input type="number" id="DEPARTURE_WEIGHT_REAR_LEFT" value="" min="0">
                        <span class="tile-label">Left Passenger (kg)</span>
                    </div>
                    <div class="tile" style="border-color: transparent; margin:2; padding:10; gap:2; align-items:center;">
                        <input type="number" id="DEPARTURE_WEIGHT_REAR_RIGHT" value="" min="0">
                        <span class="tile-label">Right Passenger (kg)</span>
                    </div>
                </div>

                <div class="grid-middle-small">
                    <div class="tile" style="border-color: transparent">
                        <input type="number" id="DEPARTURE_WEIGHT_BAGAGE" value="" min="0">
                        <span class="tile-label">Baggage (kg)</span>
                    </div>
                </div>

                <!--ADD BACK AIRCRAFT IMAGE-->
                <div class="logo-container">
                    <img id="AIRCRAFT_BACK_IMAGE" src="./figs/aircraft_back.png">
                </div>

                <!-- checkbox -->
                <div class="button-row" style="justify-content: center; align-items: center;">
                    <input type="checkbox" id="DEPARTURE_WEIGHT_CHECKBOX" checked style="font-size: 10px;"> <span style="font-size: 12px;">Sync departure and arrival weights.</span>
                </div>
                <button id="DEPARTURE_BTN_WEIGHTS" class="button-style" onclick="update_aerodrome_weights_js('DEPARTURE'); update_aerodrome_weights_js('ARRIVAL'); computeArrivalFuelPerLeg();">
                    Load pre-defined weights
                </button>
            </div>

            <!-- Weight Balance Chart -->
            <div class="section-title">Weight & Balance Envelope</div>
            <div class="border-round-eged">
                <canvas id="DEPARTURE_weightBalanceChart"></canvas>
            </div>



       </div>
       </div>


        <!--RUNWAY DEPARTURE-->
        <div class="collapsible" data-title="RUNWAY">
        <div class="collapsible-header" id="DEPARTURE_RUNWAY_MENU"></div>
        <div class="collapsible-content">

            <div class="wind-grid">
                <div id="DEPARTURE_RUNWAY_MESSAGE"></div>
            </div>

            <div class="border-round-eged">
                <div class="wind-grid">
                    <div class="tile">
                        <input id="DEPARTURE_RUNWAY_LENGTH"
                                type="text" class="tile-value" title="Set the runway length (ft)."
                                style="font-size: 32px; font-family: 'Aeroport', 'Aviation', 'Consolas', 'Monaco', 'Menlo', 'Liberation Mono', 'Courier New', monospace; letter-spacing: 2px; text-align: center; height: 64px; line-height: 64px;">
                        <span class="tile-label">
                            Runway Length (ft)
                        </span>
                    </div>
                    <div class="tile">
                        <input id="DEPARTURE_RUNWAY_NR"
                                type="text" class="tile-value" title="Set the runway number."
                                style="font-size: 32px; font-family: 'Aeroport', 'Aviation', 'Consolas', 'Monaco', 'Menlo', 'Liberation Mono', 'Courier New', monospace; letter-spacing: 2px; text-align: center; height: 64px; line-height: 64px;">
                        <span class="tile-label">
                            Runway Nr.
                        </span>
                    </div>
                </div>

                <div class="wind-grid">
                    <div class="tile" style="text-align: center;">
                        <input id="DEPARTURE_RUNWAY_SLOPE" type="text" class="tile-value">
                        <span class="tile-label" style="text-align: center;">Slope (¬∞)</span>
                    </div>
                    <div class="tile">
                        <input id="DEPARTURE_ELEVATION" type="text" class="tile-value" title="Aerodrome elevation (ft).">
                        <span class="tile-label">Elevation (ft)</span>
                    </div>
                </div>

                <div class="wind-grid">
                    <div class="tile" style="text-align: center;">
                        <select id="DEPARTURE_RUNWAY_SURFACE" class="tile-value-dropdown" style="text-align: left; background: transparent; ">
                            <option value="">Select</option>
                            <option value="hard">Hard</option>
                            <option value="soft">Soft</option>
                            <option value="other">Other</option>
                        </select>
                        <span class="tile-label" style="text-align: center;">Surface</span>
                    </div>
                    <div class="tile" style="text-align: center;">
                        <select id="DEPARTURE_RUNWAY_SLIPPERY" class="tile-value-dropdown" style="text-align: left; background: transparent; ">
                            <option value="">Select</option>
                            <option value="dry">Dry</option>
                            <option value="wet">Wet</option>
                        </select>
                        <span class="tile-label" style="text-align: center;">Condition</span>
                    </div>
                </div>

                <textarea id="DEPARTURE_RUNWAY_CONDITION" class="tile-value" title="Runway condition." style="background-color: transparent; font-size: 12px; font-weight: normal; resize: vertical; min-height: 32px; max-height: 80px; width: 100%; box-sizing: border-box; white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word; margin-top: 10px;"></textarea>

           </div>

           <div class="border-round-eged">
                <div class="wind-grid">
                    <!--<div id="DEPARTURE_RUNWAY_MINDISTANCE"></div>-->
                    <div id="DEPARTURE_RUNWAY_THRESHOLD"></div>
                    <div id="DEPARTURE_RUNWAY_THRESHOLD_50ft"></div>
                </div>

                <div id="DEPARTURE_RUNWAY_PLOT"></div>
           </div>

           <div class="border-round-eged">
                <div class="wind-grid">
                    <div id="DEPARTURE_RUNWAY_TABLE"></div>
                </div>

           </div>

           <!-- Add a button to calculate -->
           <button class="button-style" onclick="window.displayRunwayMain('DEPARTURE')">
               Calculate Runway Performance
           </button>

            <button id="DEPARTURE_LOAD_DEFAULTS" onclick="window.setRunwaySurface('DEPARTURE', true); window.displayRunwayMain('DEPARTURE')"
                title="Load the default runway information."
                style="background-color: transparent; border: none; width: 10px; padding: 1px; cursor: pointer;">
                    üîÑ
            </button>
            <button onclick="window.save_aerodrome_to_json('DEPARTURE')" title="Save custom aerodrome information" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 4px 8px 0; flex: 0 0 auto; cursor: pointer; float: right;">üíæ</button>

        </div>
        </div>



        <!-- METAR-TAF WIDGET -->
        <div class="collapsible" data-title="METAR-TAF">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <div class="button-row">
                <button id="BTN-METARTAF-DEPARTURE"
                    onclick="window.set_widget('DEPARTURE', 'METARTAF')"
                    style="transition: background-color 0.3s; z-index: 1; background-color: #006280; border: 1px solid #333333; color: #ffffff; cursor: pointer;">
                    Retrieve METAR-TAF
                </button>
            </div>

            <div id="CONTAINER-METARTAF-DEPARTURE" style="display: flex; justify-content: center; align-items: center; cursor: pointer;">
                <iframe id="DEPARTURE-METARTAF-iframe"
                        src=""
                        width="100%"
                        height="500"
                        frameborder="0"
                        style="border:0; min-height:500px; overflow:hidden; display:block;"
                        title="METAR-TAF"
                        allowfullscreen
                        scrolling="no">
            </iframe>
            </div>
        </div>
        </div>

        <!-- AIRPORT-WEATHER WIDGET -->
        <div class="collapsible" data-title="AIRPORTWEATHER">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <div class="button-row">
                <button id="BTN-AIRPORTWEATHER-DEPARTURE"
                    onclick="window.set_widget('DEPARTURE', 'AIRPORTWEATHER')"
                    style="transition: background-color 0.3s; z-index: 1; background-color: #006280; border: 1px solid #333333; color: #ffffff;">
                    Retrieve AirportWeather
                </button>
            </div>

            <!--
            1. make the iframe large enough =4000 the put the commercial stuff at the bottom.
            2. Remove the top 125px of the website and hte bottom 1500px.
            3. Do not allow scroll
            -->
            <div id="CONTAINER-AIRPORTWEATHER-DEPARTURE" style="display: flex; justify-content: center; align-items: center;">
                <iframe id="DEPARTURE-airportweather-iframe"
                        src=""
                        width="100%"
                        height="4000"
                        frameborder="0"
                        style="border:0; min-height:1000px; overflow:hidden; margin-top:-125px; margin-bottom:-1500px; display:block;"
                        title="AirportWeather"
                        allowfullscreen
                        scrolling="no">
                </iframe>
            </div>

        </div>
        </div>

	</div>



    <!-- ============================================= -->
	<!-- =============== TAB ARRIVAL =============== -->
	<!-- ============================================= -->

	<div id="Arrival" class="tabcontent">

        <!-- Arrival Information Label -->
        <label_h1>Arrival Information</label_h1>

        <!--<div class="logo-container rain-wrapper" style="margin-top: 20px;">-->
        <div class="logo-container">
            <!-- Aerodrome image -->
            <img
                id="ARRIVAL_image_cache"
                alt="Arrival Aerodrome"
                src="./figs/default_aerodrome.jpg"
                onclick="openAerodromeMap('ARRIVAL')"
            >

            <!-- Canvas overlay -->
            <canvas class="rain-canvas" data-prefix="ARRIVAL"></canvas>
            <canvas class="cloud-canvas"  data-prefix="ARRIVAL"></canvas>
            <canvas class="fog-canvas"  data-prefix="ARRIVAL"></canvas>
            <canvas class="flare-canvas"  data-prefix="ARRIVAL"></canvas>
            <canvas class="snow-canvas"  data-prefix="ARRIVAL"></canvas>
            <canvas class="dark-canvas"  data-prefix="ARRIVAL"></canvas>
            <!--<canvas class="textoverlay-canvas"  data-prefix="ARRIVAL"></canvas>-->
            <!--<canvas class="controls-canvas"  data-prefix="ARRIVAL"></canvas>-->
            <!--<div class="controls-wrapper" data-prefix="ARRIVAL">
              <canvas class="controls-canvas"></canvas>
            </div>-->
        </div>

        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 0px; margin-top: 0px; padding-bottom: 0px; margin: 0px;">
            <button id="ARRIVAL_ANIMATION_START" title="Start the METAR Animation" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 0 8px 4px; flex: 0 0 auto; cursor: pointer;">‚ñ∂Ô∏è</button>
            <button id="ARRIVAL_ANIMATION_STOP" title="Stop the METAR Animation" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 0 8px 4px; flex: 0 0 auto; cursor: pointer;">‚è∏Ô∏è</button>
            <button id="ARRIVAL_ANIMATION_METARTEXT" title="Update animation directly on the METAR textfield" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 0 8px 4px; flex: 0 0 auto; cursor: pointer;">üîÄ</button>
        </div>

        <label_h1>Select Arrival</label_h1>

        <div class="border-round-eged" id="ARRIVAL_SELECT_AERODROME_BORDER_1">
            <div class="wind-grid">
                <select id="ARRIVAL_COUNTRY" class="tile-value-dropdown" style="font-weight: normal;">
                    <option value="">Select Country</option>
                    <!-- ICAO City options will be populated dynamically IN import_country_selected()-->
                </select>
                <select id="ARRIVAL_ICAO_CITY" class="tile-value-dropdown" style="font-weight: normal;">
                    <option value="">Select ICAO</option>
                    <!-- ICAO City options will be populated dynamically IN populate_aerodrome_fields_from_icao()-->
                </select>
            </div>

            <div class="button-row">
                <img id="ARRIVAL_FLAG_1" src="" alt="" style="width:30px; height:auto; vertical-align:middle; margin-left:6px;">
                <img id="ARRIVAL_CATAGORY_ICON" src="" alt="" style="width:35px; height:auto; vertical-align:middle; margin-left:6px;">
                <img id="ARRIVAL_VFR_ICON" src="" alt="" style="width:70px; height:auto; vertical-align:middle; margin-left:6px;">
                <img id="ARRIVAL_METAR_WARNING" src="" alt="" style="width:70px; height:auto; vertical-align:middle; margin-left:6px;">
                <!--<button id="ARRIVAL_LOAD_ICAO" title="Reset to default aerodrome (ICAO) information" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 0 8px 4px; flex: 0 0 auto; cursor: pointer;">üè¨</button>-->
                <!--<button id="ARRIVAL_USE_CACHED" title="Retrieve most recent METAR weather information from Aviation weather" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 0 8px 4px; flex: 0 0 auto; cursor: pointer;">üå¶</button>-->
                <!--<input type="text" id="ARRIVAL_ICAO" class="tile-value UPPERCASE_input sync-arrival" onchange="window.load_aerodrome_from_json('ARRIVAL')" placeholder="ICAO" disabled>-->
                <!--<button onclick="window.save_aerodrome_to_json('ARRIVAL')" title="Save custom aerodrome information" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 4px 8px 0; flex: 0 0 auto; cursor: pointer; float: right;">üíæ</button>-->
            </div>
        </div>

        <!-- =========== METAR =========== -->
        <div class="collapsible" data-title="‚ö†Ô∏è METAR">
        <div class="collapsible-header" id="ARRIVAL_METARMENU_TOP"></div>
        <div class="collapsible-content" id="ARRIVAL_METARMENU_BACKGROUND">

            <div class="wind-grid">

                <div class="tile">
                    <input id="ARRIVAL_WIND_DIRECTION" type="text" class="tile-value">
                    <span class="tile-label">Wind Direction</span>
                </div>

                <div class="tile">
                    <input id="ARRIVAL_WIND_STRENGTH" type="text" class="tile-value">
                    <span class="tile-label">Strength (kt)</span>
                </div>

                <div class="tile">
                    <input id="ARRIVAL_WIND_GUST" type="text" class="tile-value">
                    <span class="tile-label">Gust (kt)</span>
                </div>
            </div>

            <div class="wind-grid">
                <div class="tile">
                    <input id="ARRIVAL_WIND_VARIATION" type="text" class="tile-value">
                    <span class="tile-label">Variation (¬∞)</span>
                </div>
                <div class="tile">
                    <input id="ARRIVAL_TEMPERATURE" type="text" class="tile-value">
                    <span class="tile-label">Temp. (C¬∞)</span>
                </div>
                <div class="tile">
                    <input id="ARRIVAL_QNH" type="text" class="tile-value">
                    <span class="tile-label">QNH</span>
                </div>
            </div>

            <div class="wind-grid">
                <div class="button-row">
                    <textarea id="METAR-FIELD-ARRIVAL"
                        placeholder="METAR Information"
                        title="METAR weather information"
                        style="font-size:12px; background-color: transparent; width: 100%; min-height: 80px; max-height: 120px; resize: vertical; padding: 8px; box-sizing: border-box; border-radius: 10px"
                        aria-label="METAR Information">
                    </textarea>
                </div>
            </div>

            <div style="display: flex; gap: 1px; margin-top: 1px;">
                <input type="text" id="METAR-TEXT-ARRIVAL" readonly
                    style="transition: background-color 0.3s; width: 70%;
                        padding: 0; box-sizing: border-box; font-size: 10px;
                        border: none; background-color: transparent;
                        color: #333333; outline: none;">

                <input type="text" id="DATETIME-METAR-ARRIVAL" readonly
                    style="transition: background-color 0.3s; width: 40%;
                        padding: 0; box-sizing: border-box; font-size: 10px;
                        border: none; background-color: transparent;
                        color: #333333; outline: none;">
            </div>

            <div class="button-row">
                <button id="ARRIVAL_USE_CACHED" class="button-style" title="Retrieve most recent METAR weather information from Aviation weather">
                    Refresh METAR Information
                </button>
            </div>

        </div>
        </div>


        <div class="collapsible" data-title="AERODROME">
        <div class="collapsible-header" id='ARRIVAL_AERODROME_MENU_TOP'></div>
        <div class="collapsible-content" id='ARRIVAL_AERODROME_MENU_BACKGROUND'>
        <!--<div class="collapsible-content">-->

            <div class="wind-grid">

                <div class="tile">
                    <input id="ARRIVAL_NAME" type="text" class="tile-value" title="Name of the aerodrome how it is known on the radio">
                    <span class="tile-label">Aerodrome name</span>
                </div>
            </div>

            <div class="grid-two-thirds-one-third">
                <div class="tile">
                    <input id="ARRIVAL_POSITION" type="text" class="tile-value UPPERCASE_input" title="Position of the Aircraft (at the apron)">
                    <span class="tile-label">Position of the aircraft</span>
                </div>

                <select id="ARRIVAL_CTR" class="tile-value-dropdown" onchange="highlightMissingFields(); highlightDropdownMenus('ARRIVAL')" style="text-align: center;">
                    <option value=""></option>
                    <option value="CTR">CTR</option>
                </select>
            </div>

            <div class="wind-grid">
                <div class="tile">
                    <input id="ARRIVAL_ROUTE_NAME" type="text" class="tile-value UPPERCASE_input" title="The name of the route (e.g., MIKE/ROMEO) for ARRIVAL.">
                    <span class="tile-label">Name arrival</span>
                </div>
                <div class="tile">
                    <input id="ARRIVAL_ROUTE_ALTITUDE" type="text" class="tile-value" title="The altitude of the route in feet.">
                    <span class="tile-label">Altitude arrival (ft)</span>
                </div>
                <div class="tile">
                    <input id="ARRIVAL_CIRCUIT_ALTITUDE" type="text" class="tile-value" title="The altitude of the circuit in feet.">
                    <span class="tile-label">Altitude circuit(ft)</span>
                </div>

            </div>

            <!-- Cloud layers -->
            <div class="wind-grid">
                <div id="ARRIVAL_CLOUD_CONTAINER" style="display:none; margin-top: 8px;">
                    <canvas id="ARRIVAL_CLOUD_CANVAS"></canvas>
                </div>
            </div>

            <div class="button-row">
                <button id="ARRIVAL_LOAD_ICAO" class="button-style" title="Reset to default aerodrome (ICAO) information">
                    Reset aerodrome information
                </button>
                <button onclick="window.save_aerodrome_to_json('ARRIVAL')" title="Save custom aerodrome information" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 4px 8px 0; flex: 0 0 auto; cursor: pointer; float: right;">üíæ</button>
            </div>


        </div>
        </div>


        <!--CONTACT-->
        <div class="collapsible" data-title="CONTACT">
        <div class="collapsible-header" id="ARRIVAL_CONTACT_MENU"></div>
        <div class="collapsible-content" id="ARRIVAL_CONTACT_MENU_BACKGROUND">

            <div class="wind-grid">
                <div class="tile">
                    <input id="ARRIVAL_ATC_GROUND" type="text" class="tile-value">
                    <span class="tile-label">Ground/ delivery (MHz)</span>
                </div>
                <div class="tile">
                    <input id="ARRIVAL_ATC_TOWER" type="text" class="tile-value">
                    <span class="tile-label">Tower/ Radio (MHz)</span>
                </div>
                <div class="tile">
                    <input id="ARRIVAL_ATC_ATIS_FREQ" type="text" class="tile-value">
                    <span class="tile-label">ATIS (MHz)</span>
                </div>
            </div>

            <div class="grid-two-thirds-one-third">
                <div class="tile">
                    <input id="ARRIVAL_ATC_TELEPHONE" type="text" class="tile-value">
                    <span class="tile-label">Telephone Number</span>
                </div>
                <div class="tile">
                    <input id="ARRIVAL_ATC_APPROACH" type="text" class="tile-value">
                    <span class="tile-label">Approach (MHz)</span>
                </div>
            </div>

            <button onclick="window.save_aerodrome_to_json('ARRIVAL')" title="Save custom aerodrome information" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 4px 8px 0; flex: 0 0 auto; cursor: pointer; float: right;">üíæ</button>
        </div>
        </div>


        <!-- METAR Information -->
        <label_h1>WIDGETS</label_h1>

        <div class="collapsible" data-title="WIND ENVELOPE">
        <div class="collapsible-header" id="ARRIVAL_WIND_MENU"></div>
        <div class="collapsible-content">

            <div class="wind-grid">
                <div id="ARRIVAL_WINDENVELOPE_MESSAGE"></div>
            </div>

           <!-- WIND INFORMATION -->
           <div class="wind-grid">
               <div id="ARRIVAL_WIND_HEADWIND"></div>
               <div id="ARRIVAL_WIND_CROSSWIND"></div>
           </div>

           <div class="button-row" style="margin-bottom: 15px;">
               <div id="ARRIVAL_WIND_ENVELOPE_PLOT" style="width: 100%; box-sizing: border-box;"></div>
           </div>

           <div class="button-row">
               <button id="BTN-PLOT-WIND-ARRIVAL" class="button-style" onclick="window.windEnvelopeMain('ARRIVAL')">
                   Reset Plot
               </button>
           </div>

       </div>
       </div>


       <!--ARRIVAL WEIGHT AND BALANCE ENVELOPE-->
       <div class="collapsible" data-title="WEIGHT AND BALANCE">
       <div class="collapsible-header" id="ARRIVAL_WB_MENU"></div>
       <div class="collapsible-content">

           <div class="wind-grid">
               <div id="ARRIVAL_WEIGHTBALANCE_MESSAGE"></div>
           </div>
           <div class="wind-grid">
               <div id="ARRIVAL_envelopeMessage" style="margin-top: 12px; padding: 10px; border-radius: 8px; font-size: 14px; text-align: center; display: none;"></div>
               <div id="ARRIVAL_fuelMessage" style="margin-top: 12px; padding: 10px; border-radius: 8px; font-size: 14px; text-align: center; display: none;"></div>
           </div>

           <!-- Totals Section -->
           <div class="border-round-eged">
               <div class="weight-card-header">Totals</div>
               <div class="wind-grid_3">
                    <input type="number" class="tile-value" id="ARRIVAL_total_moment" value="" disabled>
                    <input type="number" class="tile-value" id="ARRIVAL_total_weight" value="" disabled>
                    <input type="number" class="tile-value" id="ARRIVAL_takeoff_cg" value="" disabled>
               </div>
               <div class="wind-grid_3">
                    <span class="tile-label">Total Moment</span>
                    <span class="tile-label">Total Weight (kg)</span>
                    <span class="tile-label">Take off CG</span>
               </div>
           </div>

           <div class="border-round-eged" style="background-color: #ffffff;">
                <div class="grid-middle-small">
                    <div class="tile" style="border-color: transparent">
                        <input type="number" id="ARRIVAL_WEIGHT_FUEL_LITERS" value="">
                        <span class="tile-label">Fuel (liters)</span>
                    </div>
                </div>

                <!--ADD FRONT AIRCRAFT IMAGE-->
                <div class="logo-container">
                    <img id="AIRCRAFT_FRONT_IMAGE" src="./figs/aircraft_front.png">
                </div>

                <div class="wind-grid" style="margin:2; padding:0; gap:0; display:flex; align-items:center;">
                    <div class="tile" style="border-color: transparent; margin:2; padding:10; gap:2; align-items:center;">
                        <input type="number" id="ARRIVAL_WEIGHT_PILOT" value="" min="0">
                        <span class="tile-label">Pilot (kg)</span>
                    </div>
                    <div class="tile" style="border-color: transparent; margin:2; padding:10; gap:2; align-items:center;">
                        <input type="number" id="ARRIVAL_WEIGHT_COPILOT" value="" min="0">
                        <span class="tile-label">Front Passenger (kg)</span>
                    </div>
                </div>
                <div class="wind-grid" style="margin:2; padding:0; gap:0; display:flex; align-items:center;">
                    <div class="tile" style="border-color: transparent; margin:2; padding:10; gap:2; align-items:center;">
                        <input type="number" id="ARRIVAL_WEIGHT_REAR_LEFT" value="" min="0">
                        <span class="tile-label">Left Passenger (kg)</span>
                    </div>
                    <div class="tile" style="border-color: transparent; margin:2; padding:10; gap:2; align-items:center;">
                        <input type="number" id="ARRIVAL_WEIGHT_REAR_RIGHT" value="" min="0">
                        <span class="tile-label">Right Passenger (kg)</span>
                    </div>
                </div>

                <div class="grid-middle-small">
                    <div class="tile" style="border-color: transparent">
                        <input type="number" id="ARRIVAL_WEIGHT_BAGAGE" value="" min="0">
                        <span class="tile-label">Baggage (kg)</span>
                    </div>
                </div>

                <!--ADD BACK AIRCRAFT IMAGE-->
                <div class="logo-container">
                    <img id="AIRCRAFT_BACK_IMAGE" src="./figs/aircraft_back.png">
                </div>

                <!-- checkbox -->
                <div class="button-row" style="justify-content: center; align-items: center;">
                    <input type="checkbox" id="ARRIVAL_WEIGHT_CHECKBOX" checked style="font-size: 10px;"> <span style="font-size: 12px;">Sync departure and arrival weights.</span>
                </div>
                <button id="ARRIVAL_BTN_WEIGHTS" class="button-style" onclick="update_aerodrome_weights_js('ARRIVAL'); computeArrivalFuelPerLeg(); ">
                    Load pre-defined weights
                </button>

           </div>

           <!-- Weight Balance Chart -->
           <div class="section-title">Weight & Balance Envelope</div>
           <div class="border-round-eged">
               <canvas id="ARRIVAL_weightBalanceChart"></canvas>
           </div>

       </div>
       </div>


       <!--RUNWAY ARRIVAL-->
       <div class="collapsible" data-title="RUNWAY">
       <div class="collapsible-header" id="ARRIVAL_RUNWAY_MENU"></div>
       <div class="collapsible-content">

           <div class="wind-grid">
               <div id="ARRIVAL_RUNWAY_MESSAGE"></div>
           </div>

           <div class="border-round-eged">
               <div class="wind-grid">
                   <div class="tile">
                       <input id="ARRIVAL_RUNWAY_LENGTH"
                               type="text" class="tile-value" title="Set the runway length (ft)."
                               style="font-size: 32px; font-family: 'Aeroport', 'Aviation', 'Consolas', 'Monaco', 'Menlo', 'Liberation Mono', 'Courier New', monospace; letter-spacing: 2px; text-align: center; height: 64px; line-height: 64px;">
                       <span class="tile-label">
                           Runway Length (ft)
                       </span>
                   </div>
                   <div class="tile">
                       <input id="ARRIVAL_RUNWAY_NR"
                               type="text" class="tile-value" title="Set the runway number."
                               style="font-size: 32px; font-family: 'Aeroport', 'Aviation', 'Consolas', 'Monaco', 'Menlo', 'Liberation Mono', 'Courier New', monospace; letter-spacing: 2px; text-align: center; height: 64px; line-height: 64px;">
                       <span class="tile-label">
                           Runway Nr.
                       </span>
                   </div>
               </div>

               <div class="wind-grid">
                   <div class="tile" style="text-align: center;">
                       <input id="ARRIVAL_RUNWAY_SLOPE" type="text" class="tile-value">
                       <span class="tile-label" style="text-align: center;">Slope (¬∞)</span>
                   </div>
                   <div class="tile">
                       <input id="ARRIVAL_ELEVATION" type="text" class="tile-value" title="Aerodrome elevation (ft).">
                       <span class="tile-label">Elevation (ft)</span>
                   </div>
               </div>

               <div class="wind-grid">
                   <div class="tile" style="text-align: center;">
                       <select id="ARRIVAL_RUNWAY_SURFACE" class="tile-value-dropdown" style="text-align: left; background: transparent; ">
                           <option value="">Select</option>
                           <option value="hard">Hard</option>
                           <option value="soft">Soft</option>
                           <option value="other">Other</option>
                       </select>
                       <span class="tile-label" style="text-align: center;">Surface</span>
                   </div>
                   <div class="tile" style="text-align: center;">
                       <select id="ARRIVAL_RUNWAY_SLIPPERY" class="tile-value-dropdown" style="text-align: left; background: transparent; ">
                           <option value="">Select</option>
                           <option value="dry">Dry</option>
                           <option value="wet">Wet</option>
                       </select>
                       <span class="tile-label" style="text-align: center;">Condition</span>
                   </div>
               </div>

            <textarea id="ARRIVAL_RUNWAY_CONDITION" class="tile-value" title="Runway condition." style="background-color: transparent; font-size: 12px; font-weight: normal; resize: vertical; min-height: 32px; max-height: 80px; width: 100%; box-sizing: border-box; white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word; margin-top: 10px;"></textarea>
          </div>

          <div class="border-round-eged">
               <div class="wind-grid">
                   <!--<div id="ARRIVAL_RUNWAY_MINDISTANCE"></div>-->
                   <div id="ARRIVAL_RUNWAY_THRESHOLD"></div>
                   <div id="ARRIVAL_RUNWAY_THRESHOLD_50ft"></div>
               </div>

               <div id="ARRIVAL_RUNWAY_PLOT"></div>
          </div>

          <div class="border-round-eged">
               <div class="wind-grid">
                   <div id="ARRIVAL_RUNWAY_TABLE"></div>
               </div>

          </div>

          <!-- Add a button to calculate -->
          <button class="button-style" onclick="window.displayRunwayMain('ARRIVAL')">
              Calculate Runway Performance
          </button>

           <button id="ARRIVAL_LOAD_DEFAULTS" onclick="window.setRunwaySurface('ARRIVAL', true); window.displayRunwayMain('ARRIVAL')"
               title="Load the default runway information."
               style="background-color: transparent; border: none; width: 10px; padding: 1px; cursor: pointer;">
                   üîÑ
           </button>
           <button onclick="window.save_aerodrome_to_json('ARRIVAL')" title="Save custom aerodrome information" style="background-color: transparent; border: none; color: #666; width: 30px; min-width: 24px; height: 24px; padding: 0; margin: 8px 4px 8px 0; flex: 0 0 auto; cursor: pointer; float: right;">üíæ</button>

       </div>
       </div>




        <!-- METAR-TAF WIDGET -->
        <div class="collapsible" data-title="METAR-TAF">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <div class="button-row">
                <button id="BTN-METARTAF-ARRIVAL"
                    onclick="window.set_widget('ARRIVAL', 'METARTAF')"
                    style="transition: background-color 0.3s; z-index: 1; background-color: #006280; border: 1px solid #333333; color: #ffffff; cursor: pointer;">
                    Retrieve METAR-TAF
                </button>
            </div>

            <div id="CONTAINER-METARTAF-ARRIVAL" style="display: flex; justify-content: center; align-items: center; cursor: pointer;">
                <iframe id="ARRIVAL-METARTAF-iframe"
                        src=""
                        width="100%"
                        height="500"
                        frameborder="0"
                        style="border:0; min-height:500px; overflow:hidden; display:block;"
                        title="METAR-TAF"
                        allowfullscreen
                        scrolling="no">
            </iframe>
            </div>
        </div>
        </div>

        <!-- AIRPORT-WEATHER WIDGET -->
        <div class="collapsible" data-title="AIRPORTWEATHER">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <div class="button-row">
                <button id="BTN-AIRPORTWEATHER-ARRIVAL"
                    onclick="window.set_widget('ARRIVAL', 'AIRPORTWEATHER')"
                    style="transition: background-color 0.3s; z-index: 1; background-color: #006280; border: 1px solid #333333; color: #ffffff;">
                    Retrieve AirportWeather
                </button>
            </div>

            <!--
            1. make the iframe large enough =4000 the put the commercial stuff at the bottom.
            2. Remove the top 125px of the website and hte bottom 1500px.
            3. Do not allow scroll
            -->
            <div id="CONTAINER-AIRPORTWEATHER-ARRIVAL" style="display: flex; justify-content: center; align-items: center;">
                <iframe id="ARRIVAL-airportweather-iframe"
                        src=""
                        width="100%"
                        height="4000"
                        frameborder="0"
                        style="border:0; min-height:1000px; overflow:hidden; margin-top:-125px; margin-bottom:-1500px; display:block;"
                        title="AirportWeather"
                        allowfullscreen
                        scrolling="no">
                </iframe>
            </div>

        </div>
        </div>

	</div>






    <!-- =============== TAB ENROUTE =============== -->
    <div id="Enroute" class="tabcontent">
        <label_h1>Enroute Information</label_h1>

        <div class="border-round-eged">
            <label_h2>Flight Information Centre (FIC)</label_h2>
            <div class="grid-two-thirds-one-third">
                <div class="tile">
                    <input id="FIC_NAME" type="text" class="tile-value REPLACE_INFO" style="font-size: 14px;">
                    <span class="tile-label">FIC NAME</span>
                </div>
                <div class="tile">
                    <input id="FIC_FREQUENCY" type="text" class="tile-value">
                    <span class="tile-label">FREQUENCY (Mhz)</span>
                </div>
            </div>

            <div class="grid-two-thirds-one-third">
                <div class="tile">
                    <input id="OVERHEAD" type="text" class="tile-value UPPERCASE_input" style="font-size: 11px;">
                    <span class="tile-label">OVERHEAD</span>
                </div>
                <div class="tile">
                    <input id="SQUAWK" type="text" class="tile-value">
                    <span class="tile-label">SQUAWK</span>
                </div>
            </div>

            <div class="wind-grid" style="display: flex; align-items: center; gap: 8px;">
                <!-- Delete Button -->
                <button id="fic_delete_btn" style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Delete FIC">üóëÔ∏è</button>
                <!-- Spinner -->
                <select id="fic_spinner" class="tile-value-dropdown" style="flex: 1; font-size: 12px; font-weight: normal;">
                    <option value="">Select and Load</option>
                </select>
                <!-- Save button -->
                <button id="fic_save_btn" style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Save FIC">üíæ</button>
            </div>

        </div>


        <div class="border-round-eged">
            <label_h2>Second Flight Information Centre (FIC)</label_h2>

            <div class="grid-two-thirds-one-third">
                <div class="tile">
                    <input id="FIC_NAME2" type="text" class="tile-value REPLACE_INFO" style="font-size: 14px;">
                    <span class="tile-label">2ND FIC NAME</span>
                </div>
                <div class="tile">
                    <input id="FIC_FREQUENCY2" type="text" class="tile-value">
                    <span class="tile-label">FREQUENCY (Mhz)</span>
                </div>
            </div>
            <div class="grid-two-thirds-one-third">
                <div class="tile">
                    <input id="OVERHEAD2" type="text" class="tile-value UPPERCASE_input" style="font-size: 11px;">
                    <span class="tile-label">OVERHEAD</span>
                </div>
                <div class="tile">
                    <input id="SQUAWK2" type="text" class="tile-value">
                    <span class="tile-label">SQUAWK</span>
                </div>
            </div>

            <div class="wind-grid" style="display: flex; align-items: center; gap: 8px;">
                <!-- Delete Button -->
                <button id="fic_delete_btn2" style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Delete FIC2">üóëÔ∏è</button>

                <!-- Spinner -->
                <select id="fic_spinner2" class="tile-value-dropdown" style="flex: 1; font-size: 12px; font-weight: normal;">
                    <option value="">Select and Load</option>
                </select>

                <!-- Save button -->
                <button id="fic_save_btn2" style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Save FIC2">üíæ</button>
            </div>

        </div>



    </div>

    <!-- =============== TAB ATC =============== -->


    <div id="ATC" class="tabcontent">

        <label_h1>Required Fields</label_h1>
        <div style="border: 1px solid lightgrey; border-radius: 10px; padding: 10px;">
            <div id="bottom-container">
                <div class="warning" id="missing_label">Missing: Flight plan name, CALLSIGN, Aircraft Type</div>
            </div>
        </div>


       <label_h1>Air Traffic Control (ATC)</label_h1>

       <div style="border: 1px solid lightgrey; border-radius: 10px; padding: 10px;">

            <div class="wind-grid">
                 <div class="tile", style="border: none">
                     <select id="ATC_FONTSIZE" class="tile-value-dropdown">
                         <option value="small">Small</option>
                         <option value="medium">Medium</option>
                         <option value="large" selected>Large</option>
                         <option value="xl">Extra Large</option>
                         <option value="xxl">XXL</option>
                     </select>
                     <span class="tile-label">Choose Font Size</span>
                </div>
                <div class="tile", style="border: none">
                    <select id="ATC_COLUMNS" class="tile-value-dropdown">
                        <option value="1">1</option>
                        <option value="2" selected>2</option>
                        <option value="3">3</option>
                    </select>
                    <span class="tile-label">Choose Columns</span>
                </div>
            </div>

            <div class="divider-general-section" style="background: #f5f5f5;"></div>

            <div class="button-row">
               <button id="BTN_HTML_SUMMARY">Summary ATC</button>
                <button id="BTN_HTML_SUMMARY_REV">Reverse</button>
            </div>
            <div class="button-row">
                <button id="BTN_HTML_DEPARTURE">Departure ATC</button>
                <button id="BTN_HTML_DEPARTURE_REV">Reverse</button>
            </div>
            <div class="button-row">
                <button id="BTN_HTML_ARRIVAL">Arrival ATC</button>
                <button id="BTN_HTML_ARRIVAL_REV">Reverse</button>
            </div>
            <div class="button-row">
                <button id="BTN_HTML_ENROUTE">Enroute ATC</button>
                <button id="BTN_HTML_EN_REV">Reverse</button>
            </div>
       </div>

    </div>



    <!-- =============== TAB MAP =============== -->
    <div id="MAP" class="tabcontent">
        <label_h1>MAP</label_h1>

        <div class="border-round-eged">
            <div class="wind-grid">
                <select id="layer-select" class="tile-value-dropdown">
                    <option value="OpenStreetMap">OpenStreetMap</option>
                    <option value="EsriWorldStreetMap">EsriWorldStreetMap</option>
                    <option value="CartoVoyager">CartoVoyager</option>
                    <option value="EsriWorldImagery">EsriWorldImagery</option>
                </select>
            </div>

            <div class="button-row">
                <label>
                    <input type="checkbox" id="aviation-toggle" checked> Show Airports
                </label>
                <label>
                    <input type="checkbox" id="airspace-toggle" checked> Show Airspaces
                </label>
            </div>

            <div class="button-row">
                <div style="display: flex; align-items: center; margin-top: 5px;">
                    <label style="margin-right: 5px;">Airspaces at altitude (ft):</label>
                    <input type="number" id="airspace-altitude" value="1500" min="150" max="10000" step="150" style="width: 80px;">
                </div>
            </div>

            <div class="button-row">
                <div style="display: flex; gap: 10px;">
                    <label><input type="checkbox" id="TMZ-toggle" unchecked>TMZ</label>
                    <label><input type="checkbox" id="CTA_TMA-toggle" unchecked>CTA/TMA</label>
                    <label><input type="checkbox" id="danger-toggle" unchecked>Danger</label>
                    <label><input type="checkbox" id="prohibited-toggle" unchecked>Prohibited</label>
                </div>
            </div>

            <div class="button-row">
                <label>
                    <input type="checkbox" id="metar-toggle"> Show METAR Stations
                </label>
                <button id="refresh-metar-btn"
                        onclick="window.refreshMetarData()"
                        style="margin-left: 10px; padding: 4px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;"
                        title="Refresh METAR data">
                    üîÑ Refresh
                </button>
            </div>
        </div>

        <div class="border-round-eged">
            <div class="divider-general-section">
                <svg class="divider-plane" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="#666" d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                </svg>
            </div>
            <div class="distance-section">
                <div class="distance-info">
                    <span style="white-space: nowrap;"><span id="distance-km">0</span> km</span> |
                    <span style="white-space: nowrap;"><span id="flying-minutes">0</span> min</span> |
                    <span id="departure-time">--:--</span> ‚Üí
                    <span id="arrival-time">--:--</span>
                </div>
            </div>
        </div>

        <div id="map-container" style="height: 500px;">
            <div id="route-map" style="height: 100%;"></div>
            <div class="map-controls" style="position: absolute; top: 10px; right: 10px; background: none; padding: 0; z-index: 1000;">
                <button id="fullscreen-btn" onclick="toggleFullscreen()" style="width: 44px; height: 44px; padding: 0; background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; cursor: pointer; touch-action: manipulation;">
                    <svg class="fullscreen-enter" viewBox="0 0 24 24" style="width: 24px; height: 24px; margin: 8px;">
                        <path d="M7,14H5v5h5v-2H7V14z M5,10h2V7h3V5H5V10z M17,17h-3v2h5v-5h-2V17z M14,5v2h3v3h2V5H14z"/>
                    </svg>
                    <svg class="fullscreen-exit" viewBox="0 0 24 24" style="width: 24px; height: 24px; margin: 8px; display: none;">
                        <path d="M5,16h3v3h2v-5H5V16z M8,8H5v2h5V5H8V8z M14,19h2v-3h3v-2h-5V19z M16,8V5h-2v5h5V8H16z"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="border-round-eged">
            <div class="disclaimer">
                The airspace projections on the map are based on data that can be outdated or inaccurate. Do not navigate using the map but only use it for educational purposes.
            </div>
        </div>

    </div>

    <!-- =============== TAB COUNTRIES OF INTEREST =============== -->

    <div id="Countries" class="tabcontent">
        <label_h1>SELECT COUNTRIES</label_h1>

        <div style="border: 0px solid lightgrey; border-radius: 10px; padding: 10px;">
            <div id="bottom-container">
                <div class="info">
                    Select the countries for ICAO selection by moving countries from Available to Selected lists.
                </div>
            </div>
        </div>

        <div class="border-round-eged">
            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center;">
                <!-- Available Countries -->
                <div>
                    <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #666;">Available</label>
                    <input type="text" id="search-available" placeholder="Search..."
                        style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; margin-bottom: 8px; font-size: 14px; box-sizing: border-box;"
                        oninput="filterCountry('available-countries', this.value)">

                    <select id="available-countries" size="10" multiple
                        style="width: 100%; padding: 5px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                            <!--automatically populated in populateAvailableCountries()-->
                    </select>
                </div>

                <!-- Arrow Buttons -->
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button onclick="moveCountries('available-countries', 'selected-countries', 'add')"
                        style="width: 50px; height: 40px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 20px;"
                        title="Add selected countries">
                        ‚Üí
                    </button>
                    <button onclick="moveCountries('selected-countries', 'available-countries', 'remove')"
                        style="width: 50px; height: 40px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 20px;"
                        title="Remove selected countries">
                        ‚Üê
                    </button>
                </div>

                <!-- Selected Countries -->
                <div>
                    <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #666;">Selected</label>
                    <input type="text" id="search-selected" placeholder="Search..."
                        style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; margin-bottom: 8px; font-size: 14px; box-sizing: border-box;"
                        oninput="filterCountry('selected-countries', this.value)">
                    <select id="selected-countries" size="10" multiple
                        style="width: 100%; padding: 5px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; background: #f8f9fa;">
                    </select>
                </div>
            </div>
        </div>

    </div>


    <!-- =============== TAB CONFIGURATIONS =============== -->

    <div id="Config" class="tabcontent">
        <label_h1>Configurations</label_h1>

        <div style="border: 0px solid lightgrey; border-radius: 10px; padding: 10px;">
            <div id="bottom-container">
                <div class="info">
                    This section is to manage general configurations.
                </div>
            </div>
        </div>


        <label_h1>CLEAR CACHE</label_h1>
        <div class="border-round-eged">
            <div class="disclaimer" style="margin-bottom: 20px;">
                Warning: This will permanently delete all saved flightplans and aerodrome images from your local browser storage. The reason for using this is when you want to start fresh or when you suspect that your flightplans or images are corrupted or the ATC page does not show or update. This action cannot be undone.
            </div>

            <div class="button-row" style="margin-top: 20px;">
                <button id="clear_cache_btn" style="background-color: #ff4444; color: white; cursor: pointer;">Clear Cache</button>
            </div>

        </div>
    </div>


    <div id="Checklist" class="tabcontent">

        <label_h1>Checklist</label_h1>
        <div style="border: 0px solid lightgrey; border-radius: 10px; padding: 10px;">
            <div id="bottom-container">
                <div class="info">
                    Flight preparations requires doing many tasks carefully. Here we seperate them into catagories to keep it organized.
                </div>
            </div>
        </div>

        <div class="border-round-eged">
            <div class="wind-grid" style="display: flex; align-items: center; gap: 1px;">
                <!-- Inputfield -->
                <input id="checklist_field" type="text" class="tile-value" placeholder="My new checklist" style="background-color:transparent; font-size: 18px; padding: 0.5px;">
            </div>

            <div class="wind-grid" style="display: flex; align-items: center; gap: 8px;">
                <!-- Clean Button -->
                <button id="checklist_clear_btn" onclick="checklist_clean()" style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Create New Checklist">üßπ</button>
                <!-- Delete Button -->
                <button id="checklist_delete_btn" onclick="window.delete_item_from_spinner('checklist_spinner', 'CHECKLIST', 'checklist_field')" style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Delete checklist">üóëÔ∏è</button>
                <!-- Spinner -->
                <select id="checklist_spinner" class="tile-value-dropdown" style="flex: 1; font-size: 12px; font-weight: normal;">
                    <option value="">Select and Load</option>
                </select>
                <!-- Save button -->
                <button id="checklist_save_btn" onclick="window.save_to_json('checklist_field', 'CHECKLIST')" style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Save Checklist">üíæ</button>
            </div>
        </div>

        <!-- Personal items -->
        <div class="collapsible" data-title="Personal">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <!-- JavaScript will fill this automatically in  window.populateChecklist("Personal checklist")-->
        </div>
        </div>

        <div class="collapsible" data-title="Passengers">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <!-- JavaScript will fill this automatically in  window.populateChecklist("Navigation checklist")-->
        </div>
        </div>

        <div class="collapsible" data-title="Flightplan">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <!-- JavaScript will fill this automatically in  window.populateChecklist("Flightplan checklist")-->
        </div>
        </div>

        <div class="collapsible" data-title="Technical">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <!-- JavaScript will fill this automatically in  window.populateChecklist("Technical checklist")-->
        </div>
        </div>

        <div class="collapsible" data-title="Departure (Aircraft)">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <!-- JavaScript will fill this automatically in  window.populateChecklist("Departure checklist")-->
        </div>
        </div>

        <div class="collapsible" data-title="Departure (Aerodrome)">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <!-- JavaScript will fill this automatically in  window.populateChecklist("Departure checklist")-->
        </div>
        </div>

        <div class="collapsible" data-title="Arrival (Aircraft)">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <!-- JavaScript will fill this automatically in  window.populateChecklist("Arrival checklist")-->
        </div>
        </div>

        <div class="collapsible" data-title="Arrival (Aerodrome)">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <!-- JavaScript will fill this automatically in  window.populateChecklist("Arrival checklist")-->
        </div>
        </div>

        <div class="collapsible" data-title="Enroute">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <!-- JavaScript will fill this automatically in  window.populateChecklist("Arrival checklist")-->
        </div>
        </div>

        <div class="collapsible" data-title="Various">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <!-- JavaScript will fill this automatically in  window.populateChecklist("Various checklist")-->
        </div>
        </div>

        <div class="collapsible" data-title="Final">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <!-- JavaScript will fill this automatically in  window.populateChecklist("Final checklist")-->
        </div>
        </div>

        <div class="border-round-eged">
            <div class="info" style="margin-bottom: 14px; font-size: 12px;">Personalize your checklist by adding or removing items.</div>
            <div class="wind-grid" style="display: flex; align-items: center; gap: 8px;">
                <!-- Remove Button -->
                <button id="checklist_item_del_btn" onclick="window.checklist_update_catagories('drop')" style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px; margin-left: 4px;" title="Check the items then click this remove button to remove the items from the checklist.">‚ûñ</button>
                <!-- Catagories -->
                <select id="checklist_catagory_field" class="tile-value-dropdown">
                    <option value="">Catagories</option>
                </select>
                <!-- Inputfield -->
                <input id="checklist_item_field" type="text" class="tile-value" style="background-color: #ffffff;">
                <!-- Save button -->
                <button id="checklist_item_add_btn" onclick="window.checklist_update_catagories('add')" style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Add item to checklist">‚ûï</button>
            </div>
        </div>

        <div class="button-row">
            <button id="checklist_print"
                    type="button"
                    title="Print checklist"
                    aria-label="Print checklist"
                    onclick="checklist_print()"
                    style="background-color: #006280; border: 1px solid #333333; color: #ffffff; padding: 8px 12px; border-radius: 8px; cursor: pointer;">
                    üñ®Ô∏è Print Checklist
            </button>
        </div>

    </div>


    <!-- AIRCRAFT SPECIFICATIONS-->
    <div id="Aircrafts" class="tabcontent">
        <label_h1>Aircrafts</label_h1>

        <div style="border: 0px solid lightgrey; border-radius: 10px; padding: 10px;">
            <div id="bottom-container">
                <div class="info">
                    Specify the technical (POH) specifications for one or multiple aircrafts.
                    The parameters are used for weight and balance calculations, and the takeoff and landing performance calculations.
                </div>
            </div>
        </div>

        <!-- IMPORT -->
        <div class="collapsible" data-title="IMPORT">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">
            <!--<div class="wind-grid" style="display: flex; align-items: center; gap: 1px;">
                <input type="text" class="tile-value UPPERCASE_input" placeholder="Import" style="background-color:transparent; font-size: 18px; padding: 0.5px;" disabled>
            </div>-->
            <div class="wind-grid" style="display: flex; align-items: center; gap: 8px;">
                <!--Add spacing -->
                <button style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: transparent; width: 30px; height: 30px;"></button>
                <!--Selection spinner-->
                <select id="import_aircraft_spinner" class="tile-value-dropdown" style="flex: 1; font-size: 12px; font-weight: normal;">
                    <option value="">Select and Load</option>
                </select>
                <!--Save button-->
                <button id="import_and_save_btn" style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Import and save selected data">üì•</button>
                <!--Add spacing -->
                <button style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: transparent; width: 30px; height: 30px;"></button>
            </div>
        </div>
        </div>

        <div class="border-round-eged">
            <div class="wind-grid" style="display: flex; align-items: center; gap: 1px;">
                <input id="aircraft_field" type="text" class="tile-value UPPERCASE_input" placeholder="New Registration Name" style="background-color:transparent; font-size: 18px; padding: 0.5px;">
            </div>

            <div class="wind-grid" style="display: flex; align-items: center; gap: 8px;">
                <!-- Delete Button -->
                <button id="aircraft_delete_btn" onclick="window.delete_item_from_spinner('aircraft_spinner', 'AIRCRAFT', 'aircraft_field')" style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Delete Aircraft">üóëÔ∏è</button>
                <!-- Clean Button -->
                <!--<button id="aircraft_clear_btn" onclick="aircraft_clean()" style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Create New Aircraft">üßπ</button>-->
                <!-- Spinner, loaded from load_spinner_selection() -->
                <select id="aircraft_spinner" class="tile-value-dropdown" style="flex: 1; font-size: 12px; font-weight: normal;">
                    <option value="">Select and Load</option>
                </select>
                <!-- Save button -->
                <button id="aircraft_save_btn" style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Save Aircraft Specifications">üíæ</button>
                <!-- Download button -->
                <button id="aircraft_download_btn" style="display: flex; justify-content: center; align-items: center; background-color: transparent; border: none; color: #666; cursor: pointer; width: 30px; height: 30px;" title="Download Aircraft Specifications">üì•</button>
            </div>

            <div class="button-row">
                <button id="aircraft_clear_btn" class="button-style" title="Clean all aircraft fields." onclick="aircraft_clean()">
                    Clean all aircraft fields
                </button>
            </div>

        </div>


        <!-- PERSONAL SPECIFICATIONS -->
        <div class="collapsible" data-title="Personal Specifications">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">

            <div class="wind-grid">
                 <div class="tile">
                    <input id="SETTINGS_WEIGHT_PILOT" type="number" value="" min="0">
                    <span class="tile-label">Pilot (kg)</span>
                </div>
                <div class="tile">
                   <input id="SETTINGS_WEIGHT_COPILOT" type="number" value="" min="0">
                   <span class="tile-label">Front Passenger (kg)</span>
               </div>
            </div>

            <div class="wind-grid">
                 <div class="tile">
                    <input id="SETTINGS_WEIGHT_REAR_LEFT" type="number" value="" min="0">
                    <span class="tile-label">Left Passenger (kg)</span>
                </div>
                <div class="tile">
                   <input id="SETTINGS_WEIGHT_REAR_RIGHT" type="number" value="" min="0">
                   <span class="tile-label">Right Passenger (kg)</span>
               </div>
               <div class="tile">
                  <input id="SETTINGS_WEIGHT_BAGAGE" type="number" value="" min="0">
                  <span class="tile-label">Baggage (kg)</span>
              </div>
            </div>

        </div>
        </div>


        <!-- AIRCRAFT SPECIFICATIONS -->
        <div class="collapsible" data-title="Aircraft Specifications">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">

            <div class="wind-grid">
                 <div class="tile">
                    <input id="aircraft_callsign" type="text" class="tile-value UPPERCASE_input" disabled>
                    <span class="tile-label">REGISTRATION</span>
                </div>
                <div class="tile">
                    <input id="aircraft_type2" type="text" class="tile-value UPPERCASE_input">
                    <span class="tile-label">AIRCRAFT TYPE</span>
                </div>
            </div>

            <div class="wind-grid">
                 <div class="tile">
                    <input id="aircraft_cruisespeed" type="number" class="tile-value" value="" min="0">
                    <span class="tile-label">Cruise Speed (k/h)</span>
                </div>
                <div class="tile">
                   <input id="aircraft_mtow" type="number" value="" min="0">
                   <span class="tile-label">MTOW</span>
                </div>
            </div>

            <div class="wind-grid">
                <div class="tile">
                    <select id="aircraft_fuel_name" class="tile-value-dropdown" title="Select the fuel type used by this aircraft" style="flex: 1; font-size: 12px; font-weight: normal;">
                        <option value="">Fuel type</option>
                        <option value="avgas">Avgas</option>
                        <option value="mogas">Mogas (Automotive petrol)</option>
                        <option value="jet_a1">Jet A1</option>
                        <option value="jet_a">Jet A</option>
                        <option value="kerosene">Kerosene</option>
                        <option value="diesel">Diesel</option>
                        <option value="other">Other</option>
                    </select>
                    <span class="tile-label">Fuel Type</span>
                </div>
                <div class="tile">
                    <input id="aircraft_fuel_density" type="number" value="" min="0">
                    <span class="tile-label">Fuel Density</span>
                </div>
            </div>

            <div class="wind-grid">
                <div class="tile">
                    <input id="aircraft_fuel_consumption" type="number" value="", min="0">
                    <span class="tile-label">Fuel Consumption (l/h)</span>
                </div>
                <div class="tile">
                    <input id="SETTINGS_WEIGHT_FUEL_LITERS" type="number" value="", min="0">
                    <span class="tile-label">Maximum Fuel (l)</span>
                </div>
            </div>

            <div class="wind-grid">
                <div class="tile">
                    <input id="aircraft_costs_per_hour" type="number" value="", min="0">
                    <span class="tile-label">Costs Per Hour</span>
                </div>
            </div>

        </div>
        </div>

        <!-- WEIGHT AND BALANCE-->
        <div class="collapsible" data-title="Weight and Balance">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">

            <div class="container">
                <div class="border-round-eged">
                    <div class="warning">
                        Set the ranges for the aircraft's ARM, and empty weight. The take-off center of gravity (CG) is then shown at the bottom.
                    </div>
                </div>

                <div class="weight-card">
                    <div class="grid-two-thirds-one-third">
                        <div class="weight-card-header">Empty aircraft weight (kg)</div>
                        <input type="number" id="weight_empty" value="", min="0">
                    </div>
                </div>

                <div class="weight-card">
                    <div class="wind-grid_3">
                        <div class="input-label" style="text-align: center;">Position</div>
                        <div class="input-label" style="text-align: center;">Arm (cm)</div>
                        <div class="input-label" style="text-align: center;">Moment</div>
                    </div>

                    <div class="wind-grid_3">
                        <div class="weight-card-header">Empty Weight</div>
                        <input type="number" id="arm_empty" value="", min="0">
                        <input type="number" id="moment_empty" value="" disabled>
                    </div>

                    <!-- Pilot -->
                    <div class="wind-grid_3">
                        <div class="weight-card-header">Pilot</div>
                        <input type="number" id="arm_pilot" value="", min="0">
                        <input type="number" id="moment_pilot" value="" disabled>
                    </div>

                    <!-- Front Passenger -->
                    <div class="wind-grid_3">
                        <div class="weight-card-header">Front Passenger</div>
                        <input type="number" id="arm_copilot" value="", min="0">
                        <input type="number" id="moment_copilot" value="" disabled>
                    </div>

                    <!-- Rear Left Passenger -->
                    <div class="wind-grid_3">
                        <div class="weight-card-header">Rear Left Passenger</div>
                        <input type="number" id="arm_rl" value="", min="0">
                        <input type="number" id="moment_rl" value="" disabled>
                    </div>

                    <!-- Rear Right Passenger -->
                    <div class="wind-grid_3">
                        <div class="weight-card-header">Rear Right Passenger</div>
                        <input type="number" id="arm_rr" value="", min="0">
                        <input type="number" id="moment_rr" value="" disabled>
                    </div>

                    <!-- Baggage -->
                    <div class="wind-grid_3">
                        <div class="weight-card-header">Baggage</div>
                        <input type="number" id="arm_bagage" value="", min="0">
                        <input type="number" id="moment_bagage" value="" disabled>
                    </div>

                    <!-- Fuel -->
                    <div class="wind-grid_3">
                        <div class="weight-card-header">Fuel</div>
                        <input type="number" id="arm_fuel" value="", min="0">
                        <input type="number" id="moment_fuel" value="" disabled>
                    </div>

                </div>
            </div>

            <!-- Totals Section -->
            <div class="border-round-eged">
                <div class="weight-card-header">Totals</div>
                <div class="wind-grid_3">
                     <input type="number" class="tile-value" id="SETTINGS_total_moment" value="" disabled>
                     <input type="number" class="tile-value" id="SETTINGS_total_weight" value="" disabled>
                     <input type="number" class="tile-value" id="SETTINGS_takeoff_cg" value="" disabled>
                </div>
                <div class="wind-grid_3">
                     <span class="tile-label">Total Moment</span>
                     <span class="tile-label">Total Weight (kg)</span>
                     <span class="tile-label">Take off CG</span>
                </div>
            </div>


        </div>
        </div>


        <!-- WIND ENVELOPPE -->
        <div class="collapsible" data-title="Weight and Balance Envelope">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">

            <div class="container">
                <div class="border-round-eged">
                    <div class="warning">
                        The weight and balance envelope is drawn as a polygon on a chart, with weight on one axis and CG (moment arm) on the other.
                        Enter the coordinates of the envelope points below according to the POH.
                    </div>
                </div>

                <div class="weight-card">

                    <div class="wind-grid">
                        <div class="input-label" style="text-align: center;">x</div>
                        <div class="input-label" style="text-align: center;">y</div>
                    </div>

                    <div class="wind-grid">
                        <input type="number" id="x1" value="205" min="0" step="5">
                        <input type="number" id="y1" value="660" min="0" step="5">
                    </div>

                    <div class="wind-grid">
                        <input type="number" id="x2" value="205" min="0" step="5">
                        <input type="number" id="y2" value="725" min="0" step="5">
                    </div>

                    <div class="wind-grid">
                        <input type="number" id="x3" value="400" min="0" step="5">
                        <input type="number" id="y3" value="975" min="0" step="5">
                    </div>

                    <div class="wind-grid">
                        <input type="number" id="x4" value="570" min="0" step="5">
                        <input type="number" id="y4" value="975" min="0" step="5">
                    </div>

                    <div class="wind-grid">
                        <input type="number" id="x5" value="570" min="0" step="5">
                        <input type="number" id="y5" value="660" min="0" step="5">
                    </div>

                </div>
            </div>

            <!-- Weight Balance Chart -->
            <div class="section-title">Weight & Balance Envelope</div>
            <div class="border-round-eged">
                <canvas id="SETTINGS_weightBalanceChart"></canvas>
                <div id="SETTINGS_envelopeMessage" style="margin-top: 12px; padding: 10px; border-radius: 8px; font-size: 14px; text-align: center; display: none;"></div>
            </div>

        </div>
        </div>



        <!--TAKEOFF PERFORMANCE POH -->
        <div class="collapsible" data-title="Takeoff Performance POH">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">

            <div class="container">

                <div class="border-round-eged">
                    <div class="warning">
                        The takeoff performance of an aircraft depends on various conditions.
                        Set the parameters for weather, runway type, slope over here.
                        Use your POH to get the information. You can load default settings to get an idea of the ranges.
                    </div>
                </div>


                <div class="weight-card">
                    <div class="info-blue">
                        Correction factors for takeoff, given the wind (multiply per <i>n</i> kts).
                    </div>

                    <div class="divider"></div>

                    <div class="wind-grid">
                        <div class="input-label" style="text-align: center;">Headwind (kts)</div>
                        <div class="input-label" style="text-align: center;">Correction Factor</div>
                    </div>

                    <div class="wind-grid">
                        <input type="number" id="takeoff_headwind_kts_0" value="", min="0">
                        <input type="number" id="takeoff_headwind_cor_0" value="" min="0" step="0.05">
                    </div>

                    <div class="wind-grid">
                        <input type="number" id="takeoff_headwind_kts_1" value="", min="0">
                        <input type="number" id="takeoff_headwind_cor_1" value="" min="0" step="0.05">
                    </div>

                    <div class="wind-grid">
                        <input type="number" id="takeoff_headwind_kts_2" value="", min="0">
                        <input type="number" id="takeoff_headwind_cor_2" value="" min="0" step="0.05">
                    </div>

                    <div class="wind-grid">
                        <input type="number" id="takeoff_headwind_kts_3" value="", min="0">
                        <input type="number" id="takeoff_headwind_cor_3" value="" min="0" step="0.05">
                    </div>

                    <div class="divider"></div>

                    <div class="wind-grid">
                        <div class="input-label" style="text-align: center;">Tailwind (kts)</div>
                        <div class="input-label" style="text-align: center;">Correction Factor</div>
                    </div>
                    <div class="wind-grid">
                        <input type="number" id="takeoff_tailwind_kts" value="" min="0" step="1">
                        <input type="number" id="takeoff_tailwind_cor" value="" min="0" step="0.05">
                    </div>
                </div>

                <div class="info-gray", id="message_tailwind_corr">
                    As an example: Tailwind (kts)=2 and Correction Factor=1.1 describes: Add 10% to the distance for each 2 kt increase in tail wind.
                </div>
            </div>

            <!--RUNWAY CORRECTION FACTORS-->
            <div class="weight-card">
                <div class="info-blue">
                    Take into account the takeoff performance on hard, soft, or other surfaces, and whether the runway is dry or wet.
                </div>

                <div class="divider"></div>

                <div class="wind-grid_3">
                    <div class="input-label" style="text-align: center;">Correction Factor</div>
                </div>
                <div class="wind-grid_3">
                    <div class="input-label" style="text-align: center;">Runway Type</div>
                    <div class="input-label" style="text-align: center;">Dry Surface</div>
                    <div class="input-label" style="text-align: center;">Wet Surface</div>
                </div>

                <div class="wind-grid_3">
                    <div class="weight-card-header">Hard</div>
                    <input type="number" id="takeoff_runway_hard_dry" value="" min="0" step="0.05">
                    <input type="number" id="takeoff_runway_hard_wet" value="" min="0" step="0.05">
                </div>
                <div class="wind-grid_3">
                    <div class="weight-card-header">Soft</div>
                    <input type="number" id="takeoff_runway_soft_dry" value="" min="0" step="0.05">
                    <input type="number" id="takeoff_runway_soft_wet" value="" min="0" step="0.05">
                </div>
                <div class="wind-grid_3">
                    <div class="weight-card-header">Other</div>
                    <input type="number" id="takeoff_runway_custom_dry" value="" min="0" step="0.05">
                    <input type="number" id="takeoff_runway_custom_wet" value="" min="0" step="0.05">
                </div>

                <div class="info-gray", id="message_runway_corr">
                    Example: Dry Surface and Soft with value 1.15 describes: Add 15% for short, dry, grass.
                </div>
            </div>

            <div class="weight-card">
                <div class="info-blue">
                    Correction factor for runway slope (per percent gradient).
                </div>

                <div class="divider"></div>

                <div class="wind-grid">
                    <div class="input-label" style="text-align: center;">Runway Slope (%)</div>
                    <div class="input-label" style="text-align: center;">Correction Factor</div>
                </div>
                <div class="wind-grid">
                    <input type="number" id="takeoff_runway_slope_paved" value="" min="0" step="0.05">
                    <input type="number" id="takeoff_runway_correction_factor" value="" min="0" step="0.05">
                </div>
                <div class="info-gray", id="message_slope_corr">
                    Example: Runway slope: 2 and correction factor: 1.1 describes: An upward slope of 2% (2 m in 100 m) increases the take-off distance by 10%.
                </div>
            </div>

            <div class="weight-card">
                <div class="wind-grid">
                    <div class="input-label" style="text-align: center;">Minimum Takeoff Distance (% runway)</div>
                </div>
                <div class="wind-grid">
                    <input type="number" id="takeoff_runway_safety_correction" value="" min="0" step="0.1">
                </div>
                <div class="info-gray", id="message_safety_corr">
                    Example: 0.7 describes: Minimum distance for take-off is 70% of the runway length.
                </div>
            </div>

            <button id="takeoff_load_defaults" onclick="load_performance_defaults('takeoff')" style="border: 2px solid #f5f5f5; color: #333333; padding: 8px 12px; border-radius: 8px; cursor: pointer;">
                Load Example Takeoff Settings
            </button>

        </div>
        </div>

        <!--LANDING PERFORMANCE POH -->
        <div class="collapsible" data-title="Landing Performance POH">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">

            <div class="container">

                <div class="border-round-eged">
                    <div class="warning">
                        The landing performance of an aircraft depends on various conditions.
                        Set the parameters for weather, runway type, slope over here.
                        Use your POH to get the information. You can load default settings to get an idea of the ranges.
                    </div>
                </div>


                <div class="weight-card">
                    <div class="info-blue">
                        Correction factors for landing, given the wind (multiply per <i>n</i> kts).
                    </div>

                    <div class="divider"></div>

                    <div class="wind-grid">
                        <div class="input-label" style="text-align: center;">Headwind (KIAS)</div>
                        <div class="input-label" style="text-align: center;">Correction Factor</div>
                    </div>

                    <div class="wind-grid">
                        <input type="number" id="landing_headwind_kts_0" value="", min="0">
                        <input type="number" id="landing_headwind_cor_0" value="" min="0" step="0.05">
                    </div>

                    <div class="wind-grid">
                        <input type="number" id="landing_headwind_kts_1" value="", min="0">
                        <input type="number" id="landing_headwind_cor_1" value="" min="0" step="0.05">
                    </div>

                    <div class="wind-grid">
                        <input type="number" id="landing_headwind_kts_2" value="", min="0">
                        <input type="number" id="landing_headwind_cor_2" value="" min="0" step="0.05">
                    </div>

                    <div class="wind-grid">
                        <input type="number" id="landing_headwind_kts_3" value="", min="0">
                        <input type="number" id="landing_headwind_cor_3" value="" min="0" step="0.05">
                    </div>

                    <div class="divider"></div>

                    <div class="wind-grid">
                        <div class="input-label" style="text-align: center;">Tailwind (kts)</div>
                        <div class="input-label" style="text-align: center;">Correction Factor</div>
                    </div>
                    <div class="wind-grid">
                        <input type="number" id="landing_tailwind_kts" value="", min="0">
                        <input type="number" id="landing_tailwind_cor" value="", min="0">
                    </div>
                </div>
            </div>

            <!--RUNWAY CORRECTION FACTORS-->
            <div class="weight-card">
                <div class="info-blue">
                    Take into account the takeoff performance on hard, soft, or other surfaces, and whether the runway is dry or wet.
                </div>

                <div class="divider"></div>

                <div class="wind-grid_3">
                    <div class="input-label" style="text-align: center;">Runway Type</div>
                    <div class="input-label" style="text-align: center;">Dry Surface</div>
                    <div class="input-label" style="text-align: center;">Wet Surface</div>
                </div>
                <div class="wind-grid_3">
                    <div class="weight-card-header">Hard</div>
                    <input type="number" id="landing_runway_hard_dry" value="" min="0" step="0.05">
                    <input type="number" id="landing_runway_hard_wet" value="" min="0" step="0.05">
                </div>
                <div class="wind-grid_3">
                    <div class="weight-card-header">Soft</div>
                    <input type="number" id="landing_runway_soft_dry" value="" min="0" step="0.05">
                    <input type="number" id="landing_runway_soft_wet" value="" min="0" step="0.05">
                </div>
                <div class="wind-grid_3">
                    <div class="weight-card-header">Other</div>
                    <input type="number" id="landing_runway_custom_dry" value="" min="0" step="0.1">
                    <input type="number" id="landing_runway_custom_wet" value="" min="0" step="0.05">
                </div>
            </div>

            <div class="weight-card">
                <div class="info-blue">
                    Correction factor for runway slope (per percent gradient).
                </div>

                <div class="divider"></div>

                <div class="wind-grid">
                    <div class="input-label" style="text-align: center;">Runway Slope (%)</div>
                    <div class="input-label" style="text-align: center;">Correction Factor</div>
                </div>
                <div class="wind-grid">
                    <input type="number" id="landing_runway_slope_paved" value="" min="0" step="0.05">
                    <input type="number" id="landing_runway_correction_factor" value="" min="0" step="0.05">
                </div>
            </div>

            <div class="weight-card">
                <div class="wind-grid">
                    <div class="input-label" style="text-align: center;">Minimum Landing Distance (% runway)</div>
                </div>
                <div class="wind-grid">
                    <input type="number" id="landing_runway_safety_correction" value="" min="0" step="0.1">
                </div>
            </div>

            <button id="landing_load_defaults" onclick="load_performance_defaults('landing')" style="border: 2px solid #f5f5f5; color: #333333; padding: 8px 12px; border-radius: 8px; cursor: pointer;">
                Load Example Landing Settings
            </button>

        </div>
        </div>



        <!-- TAKEOFF PERFORMANCE POH TABLE -->
        <div class="collapsible" data-title="Takeoff Performance Distance Table">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">

            <div class="container">
                <div class="weight-card">
                    <div class="info-blue">Set your takeoff performance distances from the POH for the defined MTOW. Add/remove rows as needed.</div>
                    <div class="divider"></div>
                    <table id="poh_takeoff_table" style="width:100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr>
                                <th style="padding: 6px; border: 1px solid #ccc;">Alt (ft)</th>
                                <th style="padding: 6px; border: 1px solid #ccc;">Temp (¬∞C)</th>
                                <th style="padding: 6px; border: 1px solid #ccc;">Dist (m)</th>
                                <th style="padding: 6px; border: 1px solid #ccc;">50ft (m)</th>
                                <th style="padding: 6px; border: 1px solid #ccc;"></th>
                            </tr>
                        </thead>
                        <tbody id="POH_TAKEOFF_RECORDS"></tbody>
                    </table>
                    <button onclick="addPohRow('POH_TAKEOFF_RECORDS')" style="margin-top: 8px; font-size: 11px;">+ Add row</button>
                </div>
            </div>

            <p id="poh_takeoff_equation" style="font-family: monospace; font-size: 12px; margin: 8px 0;"></p>
            <canvas id="poh_takeoff_canvas" width="300" height="220" style="border: 1px solid #eee;"></canvas>
            <button onclick="plotLinearModel(getPohTableData('POH_TAKEOFF_RECORDS'), 'distance', 'poh_takeoff_canvas', 'poh_takeoff_equation')">
                Fit model
            </button>

        </div>
        </div>


        <!-- LANDING PERFORMANCE POH TABLE -->
        <div class="collapsible" data-title="Landing Performance Distance Table">
        <div class="collapsible-header"></div>
        <div class="collapsible-content">

            <div class="container">
                <div class="weight-card">
                    <div class="info-blue">Set your landing performance distances from the POH for the defined MTOW. Add/remove rows as needed.</div>
                    <div class="divider"></div>
                    <table id="poh_landing_table" style="width:100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr>
                                <th style="padding: 6px; border: 1px solid #ccc;">Alt (ft)</th>
                                <th style="padding: 6px; border: 1px solid #ccc;">Temp (¬∞C)</th>
                                <th style="padding: 6px; border: 1px solid #ccc;">Dist (m)</th>
                                <th style="padding: 6px; border: 1px solid #ccc;">50ft (m)</th>
                                <th style="padding: 6px; border: 1px solid #ccc;"></th>
                            </tr>
                        </thead>
                        <tbody id="POH_LANDING_RECORDS"></tbody>
                    </table>
                    <button onclick="addPohRow('POH_LANDING_RECORDS')" style="margin-top: 8px; font-size: 11px;">+ Add row</button>
                </div>
            </div>

            <p id="poh_landing_equation" style="font-family: monospace; font-size: 12px; margin: 8px 0;"></p>
            <canvas id="poh_landing_canvas" width="300" height="220" style="border: 1px solid #eee;"></canvas>
            <button onclick="plotLinearModel(getPohTableData('POH_LANDING_RECORDS'), 'distance', 'poh_landing_canvas', 'poh_landing_equation')">
                Fit model
            </button>

            <button id="load_defaults_poh" onclick="window.initPOHTables()" style="border: 2px solid #f5f5f5; color: #333333; padding: 8px 12px; border-radius: 8px; cursor: pointer;">
                Load example POH table
            </button>

        </div>
        </div>

        <div class="border-round-eged">
            <div class="disclaimer">
                The calculations are for educational purposes only and does not replace procedures. Always verify your calculations and consult official aircraft documentation before flight.
            </div>
        </div>

    </div>




<!-- Javascript functionality -->

<script>
    // MAKE REAL OFFLINE APP WITH SERVICEWORK AND SW.JS
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.error('SW registration failed', err));
    }

</script>


<script>
    document.addEventListener("DOMContentLoaded", () => {
        const collapsibles = document.querySelectorAll(".collapsible");

        collapsibles.forEach(block => {
            const header = block.querySelector(".collapsible-header");
            const content = block.querySelector(".collapsible-content");

            // Set the title from data-title attribute
            header.textContent = block.dataset.title || "Untitled";

            header.addEventListener("click", () => {
                block.classList.toggle("open");

                if (block.classList.contains("open")) {
                    content.style.maxHeight = content.scrollHeight + "px";
                } else {
                    content.style.maxHeight = null;
                }
            });
        });
    });

    // function syncFields(className) {
    //     // SYNC FIELDS OF DEPARTURE_ICAO AND DEPARTURE_ICAO_2
    //     const fields = document.querySelectorAll('.' + className);
    //     fields.forEach(field => {
    //         field.addEventListener('input', e => {
    //             fields.forEach(f => {
    //                 if (f !== e.target) f.value = e.target.value.toUpperCase();
    //             });
    //         });
    //     });
    // }

    // syncFields('sync-departure');
    // syncFields('sync-arrival');
</script>



<script>


    /**
     * Auto-update for RUNWAY PLOT when inputs change
     */
     function AutoUpdateRunwayResults(elementOrEvent) {
       console.log('> func: AutoUpdateRunwayResults()');
       // Determine prefix based on the field's id
       let element = (elementOrEvent && elementOrEvent.target) ? elementOrEvent.target : elementOrEvent;
       let prefix = element.id.startsWith('DEPARTURE') ? 'DEPARTURE' : 'ARRIVAL';
       // Update the runway
       displayRunwayMain(prefix);
       // If wind direction is not a number (e.g., 'VRB' or any non-numeric input)
       if (`${prefix}_WIND_DIRECTION` === element.id && isNaN(Number(element.value))) {
         cleanWindEnvelopeFields(prefix, action = "empty", "Wind direction is invalid or variable.", "Retrieve METAR information or set the wind direction manually.")
       }
       if (`${prefix}_WIND_STRENGTH` === element.id && isNaN(Number(element.value))) {
         cleanWindEnvelopeFields(prefix, action = "empty", "Wind strength is invalid or variable.", "Retrieve METAR information or set the wind strength manually.")
       }
       // Update the weight & balance
       WeightBalanceMain(prefix);
       const depCheckbox = document.getElementById("DEPARTURE_WEIGHT_CHECKBOX");
       if (depCheckbox.checked) {
         WeightBalanceMain(prefix === 'DEPARTURE' ? 'ARRIVAL' : 'DEPARTURE');
       }
     }

     // Setup event listeners for RUNWAY fields
     [
       'DEPARTURE_RUNWAY_LENGTH',
       'DEPARTURE_RUNWAY_SLOPE',
       'DEPARTURE_TEMPERATURE',
       'DEPARTURE_ELEVATION',
       'DEPARTURE_WEIGHT_FUEL_LITERS',
       'DEPARTURE_WEIGHT_PILOT',
       'DEPARTURE_WIND_DIRECTION',
       'DEPARTURE_WIND_STRENGTH',
       'DEPARTURE_RUNWAY_SURFACE',
       'DEPARTURE_RUNWAY_SLIPPERY',
       // ARRIVAL FIELDS
       'ARRIVAL_RUNWAY_LENGTH',
       'ARRIVAL_RUNWAY_SLOPE',
       'ARRIVAL_TEMPERATURE',
       'ARRIVAL_ELEVATION',
       'ARRIVAL_WEIGHT_FUEL_LITERS',
       'ARRIVAL_WEIGHT_PILOT',
       'ARRIVAL_WIND_DIRECTION',
       'ARRIVAL_WIND_STRENGTH',
       'ARRIVAL_RUNWAY_SURFACE',
       'ARRIVAL_RUNWAY_SLIPPERY'
     ].forEach(function(id) {
       const field = document.getElementById(id);
       if (!field) return;

       let prefix = field.id.startsWith('DEPARTURE') ? 'DEPARTURE' : 'ARRIVAL';
       // Trigger on blur
       field.addEventListener("blur", AutoUpdateRunwayResults);
       // Trigger on Enter key
       field.addEventListener('keydown', e => e.key === 'Enter' && displayRunwayMain(prefix));
       // Trigger when value is increased/decreased using the button (arrow keys or spinner)
       field.addEventListener('input', AutoUpdateRunwayResults);

       // If the field is a select (dropbox), also trigger on change
       if (
         id === 'DEPARTURE_RUNWAY_SURFACE' ||
         id === 'DEPARTURE_RUNWAY_SLIPPERY' ||
         id === 'ARRIVAL_RUNWAY_SURFACE' ||
         id === 'ARRIVAL_RUNWAY_SLIPPERY'
       ) {
         field.addEventListener('change', AutoUpdateRunwayResults);
       }
     });


    document.getElementById('ATC_FONTSIZE').addEventListener('change', (e) => {
        window.ATC_FONTSIZE = e.target.value;
        console.log('Updated ATC_FONTSIZE:', window.ATC_FONTSIZE);
        // Save to localStorage
        localStorage.setItem('ATC_FONTSIZE', e.target.value);
    });

    document.getElementById('ATC_COLUMNS').addEventListener('change', (e) => {
        window.ATC_COLUMNS = e.target.value;
        console.log('Updated nr. columns:', window.ATC_COLUMNS);
        // Save to localStorage
        localStorage.setItem('ATC_COLUMNS', e.target.value);
    });


    // Function to cache and set image source
    async function cacheAndSetImage(url, imgElementId) {
        // Import/save and then load cached image
        if (pyscriptReady) {
            await cache_and_display_image(url, imgElementId);
        }
    }

    // Add event listeners for FIC spinners
    document.getElementById('fic_spinner')?.addEventListener('change', function() {
        if (this.value && window.load_enroute_fic) {
            window.load_enroute_fic('fic_spinner');
        }
    });

    document.getElementById('fic_spinner2')?.addEventListener('change', function() {
        if (this.value && window.load_enroute_fic) {
            window.load_enroute_fic('fic_spinner2');
        }
    });

    // Add event listeners for checklist spinners
    document.getElementById('checklist_spinner')?.addEventListener('change', async function() {
        if (this.value && window.load_spinner_selection) {
            console.log(`> addEventListener: checklist_spinner`);
            // Update the checklist using the selection from cache (Python async)
            await window.load_spinner_selection('checklist_spinner', 'CHECKLIST');
            // Rebuild sections and categories after loading
            // createChecklistSections();
            populateChecklistCatagories();
            // checklist_populate();
        }
    });

    // Add event listeners for aircraft spinners
    document.getElementById('aircraft_spinner')?.addEventListener('change', async function() {
        if (this.value && window.load_spinner_selection) {
            console.log(`> addEventListener: aircraft_spinner`);
            // Update the checklist using the selection from cache (Python async)
            await window.load_spinner_selection('aircraft_spinner', 'AIRCRAFT');
        }
    });

    document.getElementById('aircraft_fuel_name')?.addEventListener('change', function() {
        if (this.value && window.FUELDENSITY[this.value]) {
            const densityInput = document.getElementById('aircraft_fuel_density');
            if (densityInput) {
                densityInput.value = window.FUELDENSITY[this.value];
            }
        }
    });

</script>


<!-- =================== ============== ===================-->
<!-- =================== PYTHON SECTION =================== -->
<!-- =================== ============== ===================-->

<py-config>
  packages = ["pandas", "numpy", "jinja2", "requests"]
</py-config>


<!-- PyScript for flightplan functionality -->
  <script type="py">
    # Standard library imports
    import json
    import os
    import copy
    import sys
    import re
    import pathlib
    import tempfile
    import base64
    from datetime import datetime
    from io import BytesIO
    from urllib.parse import urlparse
    import urllib.parse
    import webbrowser
    import math

    # Third party imports
    import pandas as pd
    import numpy as np
    import zipfile
    import requests
    import ast
    import asyncio
    from jinja2 import Environment, DictLoader

    # JavaScript/browser imports
    import js
    from js import Blob, URL, window
    from pyodide.http import pyfetch
    from pyodide.ffi import create_proxy
    from pyodide.ffi import to_js

    import logging
    logger = logging.getLogger('SKYWALK')


    def get_default_aircraft():
        print('> func: get_default_aircraft()')
        template = {
                    'CACHENAME': '',
                    'TYPE': '',
                    'CALLSIGN': '',
                    'RULES': '',
                    'CRUISESPEED': 0,
                    'MTOW': 0,
                    'EMPTY_WEIGHT': 0,
                    'COSTS_PER_HOUR': 0,
                    'FUEL': {'name': '', 'density': 0, 'consumption': 0},
                    'WEIGHT': {'fuel_liters': 0, 'pilot': 0, 'copilot': 0, 'passenger_left': 0, 'passenger_right': 0, 'bagage': 0},
                    'ARM': {'fuel': 0, 'empty_weight': 0, 'pilot': 0, 'copilot': 0, 'passenger_left': 0, 'passenger_right': 0, 'bagage': 0},
                    'ENVELOPE': {'x1': 0, 'x2': 0, 'x3': 0, 'x4': 0, 'x5': 0, 'y1': 0, 'y2': 0, 'y3': 0, 'y4': 0, 'y5': 0},
                    'TAKEOFF': {
                      'headwind_kts_0': '',
                      'headwind_kts_1': '',
                      'headwind_kts_2': '',
                      'headwind_kts_3': '',
                      'headwind_cor_0': '',
                      'headwind_cor_1': '',
                      'headwind_cor_2': '',
                      'headwind_cor_3': '',
                      'tailwind_kts': '',
                      'tailwind_cor': '',
                      'runway_hard_dry': '',
                      'runway_hard_wet': '',
                      'runway_soft_dry': '',
                      'runway_soft_wet': '',
                      'runway_custom_dry': '',
                      'runway_custom_wet': '',
                      'runway_slope_paved': '',
                      'runway_correction_factor': '',
                      'runway_safety_correction': '',
                    },
                    'LANDING': {
                      'headwind_kts_0': '',
                      'headwind_kts_1': '',
                      'headwind_kts_2': '',
                      'headwind_kts_3': '',
                      'headwind_cor_0': '',
                      'headwind_cor_1': '',
                      'headwind_cor_2': '',
                      'headwind_cor_3': '',
                      'tailwind_kts': '',
                      'tailwind_cor': '',
                      'runway_hard_dry': '',
                      'runway_hard_wet': '',
                      'runway_soft_dry': '',
                      'runway_soft_wet': '',
                      'runway_custom_dry': '',
                      'runway_custom_wet': '',
                      'runway_slope_paved': '',
                      'runway_correction_factor': '',
                      'runway_safety_correction': '',
                    },
                    'POH_TAKEOFF_RECORDS': {'altitude': [], 'temperature': [], 'distance': [], "50ft": []},
                    'POH_LANDING_RECORDS': {'altitude': [], 'temperature': [], 'distance': [], "50ft": []},
        }

        return template

    def get_default_checklist():
        print('> func: default_checklist()')
        checklist = {
                "personal": {
                    'Paper, Pen, Watch, Sunglasses, Hat': False,
                    'Medical papers': False,
                    'Pilot Licence': False,
                    'Passport/ identity card': False,
                    'Flight Logbook': False,
                    'Accu pack': False,
                    'Headset': False,
                    },

                "passengers": {
                  'Brief the Passenger(s)': False,
                    'Passport/ identity card Passenger(s)': False,
                    'Headset': False,
                    },

                "flightplan": {'Submit Flight Plan/ Flight Notification': False},

                "technical": {'Weight and Balance': False,
                              'Fuel Computations': False,
                              },

                "departure (aircraft)": {
                    'Official Aircraft Papers (The bag or suitcase)': False,
                    'Checklist Aircraft': False,
                    'Check outstanding complaints; become aware of known issues': False,
                    'Check the journal for available flight hours': False,
                    'Dinghy/swimming suit for overwater flight': False,
                    'Fuel draining (remove water at lowest point before moving the aircraft)': False,
                    },

                "departure (aerodrome)": {
                  'Departure Name': False,
                  'Departure Altitude': False,
                  'Circuit Altitude': False,
                  'Runway number (expected)': False,
                  'NOTAMS': False,
                  'Weather Information (METAR/ TAF)': False,
                  'Take-off/ Landing Distance': False,
                  'ATC frequencies': False,
                  },

                "arrival (aircraft)": {
                    'Take out personal valuable items': False,
                    'Take out keys, journal, bag or suitcase': False,
                    'Secure the wings with the strap': False,
                    'Lock the doors/ canopy': False,
                    'Close flightplan': False,
                    'Register and pay landing fee (C)': False,
                    'Prior Permission Required (PPR) by phone': False,
                    },

                "arrival (aerodrome)": {
                  'Arrival Name': False,
                  'Arrival Altitude': False,
                  'Circuit Altitude': False,
                  'Runway number (expected)': False,
                  'NOTAMS': False,
                  'Weather Information (METAR/ TAF)': False,
                  'Take-off/ Landing Distance': False,
                  'ATC frequencies': False,
                  },

                "enroute": {
                    'Navigation Plan': False,
                    'Alternate aerodrome': False,
                    'Flight levels and airspaces': False,
                    'Weather Information (METAR/ TAF)': False,
                    'AIP/AIC information printed': False,
                    'ATC frequencies (FIR/FIS)': False,
                    },

                "various": {
                    'Activate flight plan after takeoff': False,
                    },

                "final": {
                    'Flight plan/ Flight Notification is approved': False,
                    },

                }

        return checklist

    def get_default_data():
        """Get default flightplan data structure """
        print('> func: get_default_data()')
        return {
            # General Flightplan
            'FLIGHTPLAN': '',           # Name of the flightplan
            'DATETIME_CREATION': 'FLIGHT PLAN',
            'CALLSIGN': '',             # Aircraft callsign
            'CALLSIGN_SHORT': '',       # Short callsign (auto-generated)
            'AIRCRAFT_TYPE': '',        # Aircraft type/model
            'FLIGHT_RULES': 'VFR',      # VFR/IFR
            'POB': '',                  # Persons on board

            # Departure
            'DEPARTURE_ICAO': '',               # ICAO code
            'DEPARTURE_ICAO_CITY': '',          # ICAO code with City
            'DEPARTURE_CITY': '',               # City
            'DEPARTURE_NAME': '',               # Aerodrome name
            'DEPARTURE_POSITION': '',           # Position at apron

            'DEPARTURE_RUNWAYS': '',            # All available Runways
            'DEPARTURE_RUNWAY_PROPERTIES': '',  # The runway properties
            'DEPARTURE_RUNWAY_NR': '',             # GUI - The user selected Runway
            'DEPARTURE_RUNWAY_LENGTH': '',      # GUI - The length of the Runway
            'DEPARTURE_RUNWAY_SLOPE': '',       # GUI - The slope of the runway
            'DEPARTURE_RUNWAY_SURFACE': '',     # GUI - The surface of the Runway
            'DEPARTURE_RUNWAY_CONDITION': '',   # GUI - The condition
            'DEPARTURE_RUNWAY_SLIPPERY': '',    # GUI - The weather condition (dry/wet)
            'DEPARTURE_ELEVATION': '',          # GUI - The Runway ELEVATION

            'DEPARTURE_ROUTE_NAME': '',         # Departure route name
            'DEPARTURE_ROUTE_ALTITUDE': '',     # Departure route altitude
            'DEPARTURE_CIRCUIT_ALTITUDE': '',   # Departure circuit altitude
            'DEPARTURE_CTR': False,             # CTR checkbox state
            'DEPARTURE_COUNTRY': '',            # Country selection
            'DEPARTURE_COUNTRY_CODE': '',       # Country code selection
            'DEPARTURE_IMAGE': None,            # Image of the departure
            'DEPARTURE_URL_WEBSITE': None,      # Website of the Aerodrome
            'DEPARTURE_URL_WIKIPEDIA': None,    # Website of the Aerodrome
            'DEPARTURE_LATLON': [None, None],   # Latlon
            'DEPARTURE_METAR_ICAO': '',         # METAR for the specific ICAO
            'DEPARTURE_METAR': '',              # METAR
            'DEPARTURE_WIND_ENVELOPE': '',      # WIND ENVELOPE
            'DEPARTURE_CLOUD': '',              # CLOUD DATA
            'DEPARTURE_TIMEZONE': '',           # Timezone

            # Departure ATC
            'DEPARTURE_ATC_TOWER': '',            # Tower/Radio frequency
            'DEPARTURE_ATC_ATIS_FREQ': '',        # ATIS frequency
            'DEPARTURE_ATC_GROUND': '',           # Delivery/Ground frequency
            'DEPARTURE_ATC_APPROACH': '',         # Approach
            'DEPARTURE_ATC_TELEPHONE': '',        # Telephone Tower

            # Departure WEIGHTS
            'DEPARTURE_WEIGHT_FUEL_LITERS': 0,
            'DEPARTURE_WEIGHT_PILOT': 0,
            'DEPARTURE_WEIGHT_COPILOT': 0,
            'DEPARTURE_WEIGHT_REAR_LEFT': 0,
            'DEPARTURE_WEIGHT_REAR_RIGHT': 0,
            'DEPARTURE_WEIGHT_BAGAGE': 0,

            # Arrival
            'ARRIVAL_ICAO': '',                   # ICAO code
            'ARRIVAL_ICAO_CITY': '',              # ICAO code with City
            'ARRIVAL_CITY': '',                   # City
            'ARRIVAL_NAME': '',                   # Aerodrome name
            'ARRIVAL_POSITION': '',               # Position at apron

            'ARRIVAL_RUNWAYS': '',                # All available Runways
            'ARRIVAL_RUNWAY_PROPERTIES': '',      # The runway properties
            'ARRIVAL_RUNWAY_NR': '',                 # GUI - The user selected Runway
            'ARRIVAL_RUNWAY_LENGTH': '',          # GUI - The length of the Runway
            'ARRIVAL_RUNWAY_SLOPE': '',           # GUI - The slope of the runway
            'ARRIVAL_RUNWAY_SURFACE': '',         # GUI - The surface of the Runway
            'ARRIVAL_RUNWAY_CONDITION': '',       # GUI - The condition
            'ARRIVAL_RUNWAY_SLIPPERY': '',        # GUI - The surface condition (dry/wet)
            'ARRIVAL_ELEVATION': '',              # GUI - The Runway ELEVATION

            'ARRIVAL_ROUTE_NAME': '',             # Arrival route name
            'ARRIVAL_ROUTE_ALTITUDE': '',         # Arrival route altitude
            'ARRIVAL_CIRCUIT_ALTITUDE': '',       # Arrival circuit altitude
            'ARRIVAL_CTR': False,                 # CTR checkbox state
            'ARRIVAL_COUNTRY': '',                # Country selection
            'ARRIVAL_COUNTRY_CODE': '',           # Country code selection
            'ARRIVAL_IMAGE': None,                # Image of the departure
            'ARRIVAL_URL_WEBSITE': None,          # Website of the Aerodrome
            'ARRIVAL_URL_WIKIPEDIA': None,        # Website of the Aerodrome
            'ARRIVAL_LATLON': [None, None],       # Latlon
            'ARRIVAL_METAR_ICAO': '',             # METAR
            'ARRIVAL_METAR': '',                  # METAR
            'ARRIVAL_WIND_ENVELOPE': '',          # WIND ENVELOPE
            'ARRIVAL_CLOUD': '',                  # CLOUD DATA
            'ARRIVAL_TIMEZONE': '',               # Timezone

            # Arrival ATC
            'ARRIVAL_ATC_TOWER': '',        # Tower/Radio frequency
            'ARRIVAL_ATC_ATIS_FREQ': '',    # ATIS frequency
            'ARRIVAL_ATC_GROUND': '',       # Delivery/Ground frequency
            'ARRIVAL_ATC_APPROACH': '',     # Approach
            'ARRIVAL_ATC_TELEPHONE': '',    # Telephone Tower

            # Arrival WEIGHTS
            'ARRIVAL_WEIGHT_FUEL_LITERS': 0,
            'ARRIVAL_WEIGHT_PILOT': 0,
            'ARRIVAL_WEIGHT_COPILOT': 0,
            'ARRIVAL_WEIGHT_REAR_LEFT': 0,
            'ARRIVAL_WEIGHT_REAR_RIGHT': 0,
            'ARRIVAL_WEIGHT_BAGAGE': 0,

            # Enroute
            'FIC_NAME': '',             # FIC name
            'FIC_FREQUENCY': '',        # FIC frequency
            'OVERHEAD': '',             # Overhead point
            'SQUAWK': '',               # Squawk code
            # Enroute (second FIC/overhead/squawk)
            'FIC_NAME2': '',            # Second FIC name
            'FIC_FREQUENCY2': '',       # Second FIC frequency
            'OVERHEAD2': '',            # Second overhead point
            'SQUAWK2': '',              # Second squawk code

            'WAYPOINTS': [],            # Waypoint data
            'LEGINFO': {},              # Leg info
            'NOTAM': {'data': {}},      # NOTAM data
            'CHECKLIST': copy.deepcopy(get_default_checklist()),
            'AIRCRAFT': copy.deepcopy(get_default_aircraft()),
        }

    # ================================================
    # GENERIC FUNCTIONS
    # ================================================

    def update_dropdown(elementId, cacheName, keepSelection=True, elementId2=None):
        """Update the dropdown with cached info.

        Parameters
        ----------
        elementId : str
            The ID of the HTML element to be updated.
        cacheName : str
            The name of the cache from which the data will be fetched.
        keepSelection : bool, optional
            Whether to keep the current selection in the dropdown (default is True).
        elementId2 : str, optional
            An alternative ID to use if `keepSelection` is True and the current
            selection is empty.
        """
        print(f"> func: update_dropdown()")

        # Get all keys from localStorage
        storage_length = js.localStorage.length
        cName = cacheName.upper() + '_'
        cached_names = set()

        for i in range(storage_length):
            key = js.localStorage.key(i)
            if key and key.upper().startswith(cName):
                cached_names.add(str(key).replace(cName, ''))

        # Convert to list and sort alphabetically
        cached_names = sorted(list(cached_names))

        # Update dropdown
        select = js.document.getElementById(elementId)
        user_selection = select.value

        # Set user_selection with the value elementId2 name if user selection is empty
        # if keepSelection and elementId2 and user_selection == '':
        if keepSelection and elementId2 is not None:
            user_selection = js.document.getElementById(elementId2).value

        if select:
            # Clear existing options except the first placeholder
            select.innerHTML = f'<option value="">Select and Load</option>'

            # Add each detected item as an option
            for name in cached_names:
                option = js.document.createElement('option')
                option.value = name
                option.textContent = name
                select.appendChild(option)

            # Set to user selection:
            if keepSelection:
                select.value = user_selection

            print(f"   >‚úÖ Updated {elementId} with {len(cached_names)} {cacheName.lower()}s")
        else:
            print(f"   >‚ö†Ô∏è Dropdown {elementId} not found for {cacheName.lower()}.")


    async def load_spinner_selection(elementId, cacheName):
        """Load selected from localStorage, then store directly into flight_plan_data."""
        print(f'> func: load_spinner_selection({elementId})')

        # Get the user selection from the spinner element
        user_selection = js.document.getElementById(elementId).value

        if not user_selection or user_selection == "":
            print("   >‚ö†Ô∏è No {cacheName} selected")
            return

        print(f"   >üìÇ Loading {cacheName}: {user_selection}")

        # Load from cache (localStorage)
        storage_key = f"{cacheName}_{user_selection}"
        json_data = js.localStorage.getItem(storage_key)

        if not json_data:
            print(f"   >‚ö†Ô∏è {cacheName} not found: {user_selection}")
            js.window.alert(f"‚ö†Ô∏è {cacheName} '{user_selection}' was not found.")
            return

        # Parse JSON
        try:
            data_dict = json.loads(json_data)
            print(f"   >‚úÖ Loaded {cacheName}: {len(data_dict)} fields for {elementId}")

            # Do stuff for the spinner
            if elementId == 'checklist_spinner':
                js.window.flight_plan_data['CHECKLIST'] = data_dict
                js.document.getElementById('checklist_field').value = user_selection
                checklist_populate()
            elif elementId == 'aircraft_spinner':
                js.window.flight_plan_data['AIRCRAFT'] = data_dict
                js.document.getElementById('aircraft_field').value = user_selection
                js.window.aircraft_populate_js();
                js.window.update_aerodrome_weights_js("DEPARTURE");
                js.window.update_aerodrome_weights_js("ARRIVAL");
                # Compute Fuel per leg
                js.window.WeightBalanceMain('SETTINGS');
                js.window.WeightBalanceMain('DEPARTURE');
                js.window.WeightBalanceMain('ARRIVAL');
                # Compute Runway stats
                js.window.displayRunwayMain('DEPARTURE');
                js.window.displayRunwayMain('ARRIVAL');
                # Highlight any missing fields
                js.window.highlightMissingFields();
                # Update poh Table
                js.window.LoadPOHData()

            print(f"   >‚úÖ [elementId] '{user_selection}' loaded successfully")
        except Exception as e:
            print(f"   >‚ö†Ô∏è Error loading spinner {user_selection}: {e}")
            js.window.alert(f"‚ùó Error loading spinner {user_selection}: {e}")


    def save_to_json(elementId, cacheName):
        """Save custom data to localStorage. """
        print(f'> func: save_to_json()')

        try:
            # Store to localStorage
            listname = js.document.getElementById(elementId).value.strip()
            if listname == '':
                print('Name is required. Nothing saved. <return>')
                js.window.alert(f"‚ÑπÔ∏è Please provide a {cacheName} name before saving.")
                return

            # Update the flightplan with the latest version of the GUI fields before dumping to json
            if cacheName=='AIRCRAFT':
                aircraft_update_flightplan()

            cache_key = f'{cacheName}_{listname}'
            # Store Cache key in flightplan
            js.window.flight_plan_data[cacheName]['CACHENAME'] = cache_key
            # Convert to JSON string
            json_data = json.dumps(js.window.flight_plan_data[cacheName])
            # Save to cache
            js.localStorage.setItem(cache_key, json_data)

            # Update the spinner list
            update_dropdown(f'{cacheName.lower()}_spinner', cacheName=cacheName, keepSelection=True, elementId2=f'{cacheName.lower()}_field');
            message = f"‚úÖ {cacheName} {listname} is saved with the catagories and items."
            print(message)
            js.window.alert(message)
        except Exception as e:
            js.window.alert(f"‚ö†Ô∏è Saving was not succesful. Error: {e}")

        # Return
        return True

    # ================================================
    # AIRCRAFT SPECIFICATIONS
    # ================================================
    def aircraft_matching_pairs():
        """Matching pairs for GUI elements and dictionary in get_default_aircraft()."""
        # 'elementId'  : flight_plan_data['AIRCRAFT'][cat][item]

        return {
          'SETTINGS_WEIGHT_FUEL_LITERS': ['WEIGHT', 'fuel_liters'],
          'SETTINGS_WEIGHT_PILOT': ['WEIGHT', 'pilot'],
          'SETTINGS_WEIGHT_COPILOT': ['WEIGHT', 'copilot'],
          'SETTINGS_WEIGHT_REAR_LEFT': ['WEIGHT', 'passenger_right'],
          'SETTINGS_WEIGHT_REAR_RIGHT': ['WEIGHT', 'passenger_left'],
          'SETTINGS_WEIGHT_BAGAGE': ['WEIGHT', 'bagage'],

          'weight_empty': ['', 'EMPTY_WEIGHT'],
          'arm_fuel': ['ARM', 'fuel'],
          'arm_empty': ['ARM', 'empty_weight'],
          'arm_pilot': ['ARM', 'pilot'],
          'arm_copilot': ['ARM', 'copilot'],
          'arm_rl': ['ARM', 'passenger_left'],
          'arm_rr': ['ARM', 'passenger_right'],
          'arm_bagage': ['ARM', 'bagage'],

          'x1': ['ENVELOPE', 'x1'],
          'x2': ['ENVELOPE', 'x2'],
          'x3': ['ENVELOPE', 'x3'],
          'x4': ['ENVELOPE', 'x4'],
          'x5': ['ENVELOPE', 'x5'],
          'y1': ['ENVELOPE', 'y1'],
          'y2': ['ENVELOPE', 'y2'],
          'y3': ['ENVELOPE', 'y3'],
          'y4': ['ENVELOPE', 'y4'],
          'y5': ['ENVELOPE', 'y5'],

          'aircraft_field': ['', 'CALLSIGN'],
          'aircraft_spinner': ['', 'CALLSIGN'],
          'aircraft_callsign': ['', 'CALLSIGN'],
          'aircraft_type2': ['', 'TYPE'],
          'aircraft_cruisespeed': ['', 'CRUISESPEED'],
          'aircraft_mtow': ['', 'MTOW'],
          'aircraft_costs_per_hour': ['', 'COSTS_PER_HOUR'],

          'aircraft_fuel_name': ['FUEL', 'name'],
          'aircraft_fuel_density': ['FUEL', 'density'],
          'aircraft_fuel_consumption': ['FUEL', 'consumption'],

          'takeoff_headwind_kts_0': ['TAKEOFF', 'headwind_kts_0'],
          'takeoff_headwind_kts_1': ['TAKEOFF', 'headwind_kts_1'],
          'takeoff_headwind_kts_2': ['TAKEOFF', 'headwind_kts_2'],
          'takeoff_headwind_kts_3': ['TAKEOFF', 'headwind_kts_3'],
          'takeoff_headwind_cor_0': ['TAKEOFF', 'headwind_cor_0'],
          'takeoff_headwind_cor_1': ['TAKEOFF', 'headwind_cor_1'],
          'takeoff_headwind_cor_2': ['TAKEOFF', 'headwind_cor_2'],
          'takeoff_headwind_cor_3': ['TAKEOFF', 'headwind_cor_3'],
          'takeoff_tailwind_kts': ['TAKEOFF', 'tailwind_kts'],
          'takeoff_tailwind_cor': ['TAKEOFF', 'tailwind_cor'],
          'takeoff_runway_hard_dry': ['TAKEOFF', 'runway_hard_dry'],
          'takeoff_runway_hard_wet': ['TAKEOFF', 'runway_hard_wet'],
          'takeoff_runway_soft_dry': ['TAKEOFF', 'runway_soft_dry'],
          'takeoff_runway_soft_wet': ['TAKEOFF', 'runway_soft_wet'],
          'takeoff_runway_custom_dry': ['TAKEOFF', 'runway_custom_dry'],
          'takeoff_runway_custom_wet': ['TAKEOFF', 'runway_custom_wet'],
          'takeoff_runway_slope_paved': ['TAKEOFF', 'runway_slope_paved'],
          'takeoff_runway_correction_factor': ['TAKEOFF', 'runway_correction_factor'],
          'takeoff_runway_safety_correction': ['TAKEOFF', 'runway_safety_correction'],

          'landing_headwind_kts_0': ['LANDING', 'headwind_kts_0'],
          'landing_headwind_kts_1': ['LANDING', 'headwind_kts_1'],
          'landing_headwind_kts_2': ['LANDING', 'headwind_kts_2'],
          'landing_headwind_kts_3': ['LANDING', 'headwind_kts_3'],
          'landing_headwind_cor_0': ['LANDING', 'headwind_cor_0'],
          'landing_headwind_cor_1': ['LANDING', 'headwind_cor_1'],
          'landing_headwind_cor_2': ['LANDING', 'headwind_cor_2'],
          'landing_headwind_cor_3': ['LANDING', 'headwind_cor_3'],
          'landing_tailwind_kts': ['LANDING', 'tailwind_kts'],
          'landing_tailwind_cor': ['LANDING', 'tailwind_cor'],
          'landing_runway_hard_dry': ['LANDING', 'runway_hard_dry'],
          'landing_runway_hard_wet': ['LANDING', 'runway_hard_wet'],
          'landing_runway_soft_dry': ['LANDING', 'runway_soft_dry'],
          'landing_runway_soft_wet': ['LANDING', 'runway_soft_wet'],
          'landing_runway_custom_dry': ['LANDING', 'runway_custom_dry'],
          'landing_runway_custom_wet': ['LANDING', 'runway_custom_wet'],
          'landing_runway_slope_paved': ['LANDING', 'runway_slope_paved'],
          'landing_runway_correction_factor': ['LANDING', 'runway_correction_factor'],
          'landing_runway_safety_correction': ['LANDING', 'runway_safety_correction'],

        }

    def aircraft_clean(verbose='info'):
        print('> func: aircraft_clean()')
        if verbose=='info':
            if js.window.confirm("All aircraft fields will be cleaned. Do you want to proceed?"):
                js.window.alert("‚úÖ All aircraft fields are cleaned.")
            else:
                return

        # Clean the fields
        js.document.getElementById('aircraft_field').value = ''
        select = js.document.getElementById('aircraft_spinner')
        select.value = 'Select and Load'

        # Load the default checklist
        js.window.flight_plan_data['AIRCRAFT'] = get_default_aircraft()

        # Update the poh console table
        js.window.LoadPOHData()

        # Now also set computed fields to 0
        js.document.getElementById('moment_empty').value = 0
        js.document.getElementById('moment_pilot').value = 0
        js.document.getElementById('moment_copilot').value = 0
        js.document.getElementById('moment_rl').value = 0
        js.document.getElementById('moment_rr').value = 0
        js.document.getElementById('moment_bagage').value = 0
        js.document.getElementById('moment_fuel').value = 0
        js.document.getElementById('SETTINGS_total_moment').value = 0
        js.document.getElementById('SETTINGS_total_weight').value = 0
        js.document.getElementById('SETTINGS_takeoff_cg').value = 0

        # Populate aircraft with defaults
        js.window.aircraft_populate_js(updateGeneralTab=False)
        js.window.WeightBalanceMain('SETTINGS')
        js.window.cleanRunwayFields('DEPARTURE', 'empty')
        js.window.cleanRunwayFields('ARRIVAL', 'empty')
        js.window.flashcardClean('DEPARTURE')
        js.window.flashcardClean('ARRIVAL')

        if verbose=='info':
          print(js.window.flight_plan_data['AIRCRAFT'])

    def aircraft_update_flightplan():
        """Update the flightplan: js.window.flight_plan_data['AIRCRAFT'] with the values from the GUI."""
        print(f'>func: aircraft_update_flightplan()')

        js.window.SavePOHData('DEPARTURE')
        js.window.flight_plan_data['AIRCRAFT']['POH_TAKEOFF_RECORDS'] = json.loads(js.window.flight_plan_data['AIRCRAFT']['POH_TAKEOFF_RECORDS'])
        js.window.SavePOHData('ARRIVAL')
        js.window.flight_plan_data['AIRCRAFT']['POH_LANDING_RECORDS'] = json.loads(js.window.flight_plan_data['AIRCRAFT']['POH_LANDING_RECORDS'])

        print('HERE')
        print(js.window.flight_plan_data['AIRCRAFT'])

        # Matching pairs for GUI and dictionary
        matching_pairs = aircraft_matching_pairs()

        # Go throught all matching keys to store in flight dict
        try:
            for key in matching_pairs.keys():
                cat, item = matching_pairs[key]
                elementId = js.document.getElementById(key)
                if not elementId: continue

                print(f"   >Update flightplan GUI [{key}] -> ['AIRCRAFT'][{cat}][{item}]: {elementId.value}")
                if (cat == '') or (cat is None):
                    js.window.flight_plan_data['AIRCRAFT'][item] = elementId.value
                else:
                    js.window.flight_plan_data['AIRCRAFT'][cat][item] = elementId.value

            # Directly populate to all fields. This is required because some fields needs to be updated in General tab too.
            js.window.aircraft_populate_js();
            js.window.update_aerodrome_weights_js("DEPARTURE");
            js.window.update_aerodrome_weights_js("ARRIVAL");
            # Compute Fuel per leg
            js.window.WeightBalanceMain('SETTINGS');
            js.window.WeightBalanceMain('DEPARTURE');
            js.window.WeightBalanceMain('ARRIVAL');
            # Compute Runway stats
            js.window.displayRunwayMain("DEPARTURE");
            js.window.displayRunwayMain("ARRIVAL");
            # Highlight any missing fields
            js.window.highlightMissingFields();
            js.window.highlightDropdownMenus("DEPARTURE");
            js.window.highlightDropdownMenus("ARRIVAL");
        except Exception as e:
            js.window.alert(f"‚ö†Ô∏è Ooops. An unexpected error. Please load and save and try again.")
            print(f"Error saving aircraft for key '{key}': {e}")

    # ================================================
    # CHECKLIST
    # ================================================

    def checklist_update_catagories(operation):
        """Update the categories of the checklist.

        This function safely adds or removes items from the CHECKLIST structure
        stored in `js.window.flight_plan_data`. It validates that the checklist
        and the selected category exist and are dictionaries to avoid
        TypeError: 'builtin_function_or_method' object is not subscriptable and
        other indexing errors.

        Parameters
        ----------
        operation : str
            Either 'add' to add an item or 'drop' to remove an item.
        """

        if not js.window.flight_plan_data.get('CHECKLIST'):
            print('   > ‚ö†Ô∏è CHECKLIST not found in [js.window.flight_plan_data]')
            return

        # Get item name and category (normalize)
        itemName = js.document.getElementById('checklist_item_field').value.strip()
        catName = js.document.getElementById('checklist_catagory_field').value.lower()

        # Shortcut to the checklist dict
        checklist = js.window.flight_plan_data['CHECKLIST']
        blacklist = ['NAME', 'aerodrome']

        if operation == 'add':
            # Validate category exists and is a dict
            if (catName not in checklist) or not isinstance(checklist[catName], dict):
                js.window.alert(f"‚ö†Ô∏è Category '{catName}' does not exist or is not a valid category.")
                print(f"   > ‚ö†Ô∏è Category '{catName}' missing or invalid in CHECKLIST")
                return

            if itemName == '':
                js.window.alert(f"‚ö†Ô∏è Input name is required to {operation} an item.")
                return

            # Only add if not already present
            if itemName in checklist[catName]:
                print(f'    > Item "{itemName}" already exists in category: {catName}')
                js.window.alert(f'‚ö†Ô∏è Item "{itemName}" already exists in category: {catName}')
            else:
                # Add item to catagory
                checklist[catName][itemName] = False
                print(f'    > Added "{itemName}" to category: {catName}')
                js.document.getElementById('checklist_item_field').value = ''
        elif operation == 'drop':
            # Check whether any checkboxes are marked for deletion
            isdel = False
            for key in checklist.keys():
                # Skip the ones in blacklist
                if key not in blacklist:
                    if isinstance(checklist[key], dict):
                        # Collect items to delete first
                        items_to_delete = []
                        for item in checklist[key].keys():
                            print(f'{key}-{item}: {checklist[key][item]}')
                            if checklist[key][item]:
                                # Confirm deletion
                                if js.window.confirm(f"Delete: [{item}] from the [{key}] category?"):
                                    items_to_delete.append(item)

                        # Now delete the collected items
                        for item in items_to_delete:
                            checklist[key].pop(item, None)
                            isdel = True

            if not isdel:
                js.window.alert(f'‚ö†Ô∏è No items are marked to be removed. Please check the items first.')
        else:
            print(f'    > ‚ö†Ô∏è Unknown operation: {operation}')
            return

        # Update checklist UI
        checklist_populate()


    def checklist_populate():
        """Populate the checklist with data from js.window.flight_plan_data['CHECKLIST'].

        This function iterates over each key in `js.window.flight_plan_data['CHECKLIST']`.
        If the value associated with a key is a dictionary, it calls `js.window.populateChecklist()`
        to populate the checklist with that data.

        Returns
        -------
        None
            This function does not return anything. It only updates the checklist in place.
            If `js.window.flight_plan_data['CHECKLIST']` is not found or does not contain any dictionaries,
            it prints a warning message and returns early.

        """
        print('> func: checklist_populate()')
        if not js.window.flight_plan_data.get('CHECKLIST'):
            print('   > ‚ö†Ô∏è CHECKLIST not found in [js.window.flight_plan_data]')
            return

        # Populate the checklist
        for key in js.window.flight_plan_data['CHECKLIST'].keys():
            if isinstance(js.window.flight_plan_data['CHECKLIST'][key], dict):
                # A match is created for the data-title to fill the right elements
                js.window.populateChecklist(f"{key.title()}")

        # Automatically create the checklists
        # window.createChecklistSections()
        # window.populateChecklistCatagories()


    def checklist_clean(verbose='info'):
        print('> func: checklist_clean()')
        # Clean the fields
        js.document.getElementById('checklist_field').value = ''
        select = js.document.getElementById('checklist_spinner')
        select.value = 'Select and Load'

        # Set the default checklist
        js.window.flight_plan_data['CHECKLIST'] = get_default_checklist()

        # Populate checklist with defaults
        checklist_populate()

        if verbose=='info':
            js.window.alert(f"‚ÑπÔ∏è Default checklist catagories and items are loaded.")


    def check_items_complete(listname):
        # Get items from checklist
        check_items = js.window.flight_plan_data['CHECKLIST'][listname]

        # Check if all items are True
        if all(check_items.values()):
            icon = '‚ÑπÔ∏è'
        else:
            icon = '‚ö†Ô∏è'
        return icon

    def checklist_print():
        print(f'> func: checklist_print()')
        html_content = generate_checklist_html(include_badges=False)
        # print(html_content)
        open_html(html_content)
        return

    def create_badge_html(badges):
        html = '<div style="margin-left: 20px; display: flex; flex-wrap: wrap; gap: 6px;">'
        html += ''.join([f'<img src="{url}" alt="badge">' for url in badges])
        html += '</div>'
        return html

    def create_status_html(item, classtype='note', width='80'):
        return f"""
        <div class="{classtype}" style="background-color:{item['color']}; padding: 6px 10px; margin: 6px 0 6px 20px; border-radius: 4px; width: {width}%;">
            <strong>{item['message']}</strong>
        </div>
        """

    def badge_color(badge):
        # Get colors matched to state
        if 'error' in str(badge):
            return 'red'
        elif 'warning' in str(badge):
            return 'orange'
        elif 'success' in str(badge):
            return 'green'
        elif 'info' in str(badge):
            return 'blue'

    def weight_balance(fname, return_type='badge'):
        status = 'OK'
        message = 'Weight & Balance Inside Envelope'
        badge = 'success'
        return {'status': status, 'message': message, 'badge': badge, 'color': badge_color(badge)}

    def aircraft_weight(fname, return_type='badge'):
        status = 'OK'
        message = 'Weight within MTOW'
        badge = 'success'
        return {'status': status, 'message': message, 'badge': badge, 'color': badge_color(badge)}

    def fuel(fname, return_type='badge'):
        status = 'OK'
        message = 'Fuel within range'
        badge = 'success'
        return {'status': status, 'message': message, 'badge': badge, 'color': badge_color(badge)}

    def generate_checklist_html(include_badges=False):
        from collections import defaultdict

        if not js.window.flight_plan_data.get('CHECKLIST'):
            js.window.alert('‚ö†Ô∏è Create a new checklist before printing.')
            return None

        data = js.window.flight_plan_data['CHECKLIST']

        weight_status = weight_balance('DEPARTURE', return_type='dict')
        aircraft_status = aircraft_weight('DEPARTURE', return_type='dict')
        fuel_status = fuel('ARRIVAL', return_type='dict')

        # section_order = [
        #     "personal", "navigation", "flightplan", "technical", "aerodrome",
        #     "departure", "arrival", "various", "final"]

        # Only print those with at least one item
        counts = {k: len(v) for k, v in data.items() if isinstance(v, dict) and len(v) > 0}
        section_order = list(counts.keys())

        html = """
        <html>
        <head>
            <style>
                body { font-family: Arial, sans-serif; font-size: 13px; padding: 20px; margin: 0; }
                h2 { border-bottom: 1px solid #ccc; margin-top: 30px; }
                .section { margin-bottom: 20px; }
                .item { display: flex; align-items: flex-start; margin: 6px 0; }
                .item label { display: flex; align-items: flex-start; }
                .item input[type="checkbox"] { margin-right: 10px; margin-top: 2px; transform: scale(1.2); flex-shrink: 0; }
                .label-text { display: inline-block; max-width: 90%; word-wrap: break-word; }
                .name-tag { font-size: 14px; font-weight: bold; padding: 6px 0 20px; display: block; }
                .note { background-color: #f8f9fa; border-left: 4px solid #888; padding: 10px; margin-bottom: 10px; font-size: 12px; }
                .columns { display: flex; flex-wrap: wrap; gap: 20px; }
                .column { flex: 1 1 45%; min-width: 300px; }
            </style>
        </head>
        <body>
        """

        # Get checklist name from gui
        checklist_name = js.document.getElementById('checklist_field').value
        if checklist_name != '':
            html += f"<class='name-tag'><h1>Checklist {data['NAME']}</h1>"

        for section in section_order:
            if section in data:
                if section == "aerodrome":
                    continue
                else:
                    html += f"<div class='section'><h2>{section.capitalize()}</h2><div class='columns'>"
                    items = list(data[section].items())
                    if len(items) > 0:
                        half = len(items) // 2
                        left_items = items[:half]
                        right_items = items[half:]

                        for col_items in [left_items, right_items]:
                            html += "<div class='column'>"
                            for label, checked in col_items:
                                checked_html = "checked" if checked else ""
                                html += f"<div class='item'><label><input type='checkbox' {checked_html}><span class='label-text'>{label}</span></label></div>"

                                if section == "technical" and include_badges:
                                    if 'weight' in label.lower():
                                        html += create_status_html(weight_status)
                                        html += create_status_html(aircraft_status)
                                    if 'fuel' in label.lower():
                                        html += create_status_html(fuel_status)

                            html += "</div>"
                        html += "</div></div>"

        html += "</body></html>"

        print_button = """
            <button onclick=\"window.print()\" style=\"
                margin-bottom: 10px;
                padding: 6px 12px;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            \">üñ®Ô∏è Print Checklist</button>
        """

        html = f"{print_button}{html}"
        return html


    # ================================================
    # CACHE HELPERS
    # ================================================

    def clear_cache():
        """Clear all cached data from localStorage"""
        try:
            # Clears everything stored in localStorage
            js.localStorage.clear()

            # If you also use sessionStorage:
            js.sessionStorage.clear()
            print("üßπ Cache cleared successfully")
            return True
        except Exception as e:
            print(f"‚ùå Error clearing cache: {e}")
            return False


    def is_cached(cache_key):
        try:
            cached = js.localStorage.getItem(cache_key)
            # Check if value exists and is truthy (not null/undefined)
            return bool(cached)
        except:
            return False


    def save_to_cache(cache_key, data, encode_base64=False):
        """Save data to localStorage with optional base64 encoding"""
        try:
            if encode_base64:
                data = base64.b64encode(data).decode('utf-8')
            js.localStorage.setItem(cache_key, data)
            print(f"üíæ Cached {cache_key}: {len(data)} bytes")
            return True
        except Exception as e:
            print(f"‚ùå Error saving to cache: {e}")
            return False


    async def load_cached_zip(cache_key, url=None):
        """Load data from cache or download and cache it
        Args:
            cache_key: Key to use for caching
            url: URL to fetch data from if not in cache
        Returns:
            bytes: The loaded data
        """
        if is_cached(cache_key):
            print(f"üì¶ Using cached data for: {cache_key}")
            cached_data = load_from_cache(cache_key)
            return cached_data

        if url:
            print(f"‚¨áÔ∏è Downloading from: {url}")
            data = await fetch_zip(url)
            if data:
                save_to_cache(cache_key, data, encode_base64=True)
                return data
        return None


    def load_from_cache(cache_key):
        try:
            cached_data = js.localStorage.getItem(cache_key)
            if cached_data:
                # Decode base64 string to bytes
                data = base64.b64decode(cached_data)
                print(f"üì¶ Loaded {len(data)} bytes from cache")
                return data
            print("‚ö†Ô∏è Cache returned null")
            return None
        except Exception as e:
            print(f"‚ö†Ô∏è Error decoding cached data: {e}")
            return None


    # Fetch ZIP from remote and save to cache
    async def fetch_zip(url):
        filepath = urlparse(url).path
        zipname = os.path.splitext(os.path.basename(filepath))[0]
        print(f"üì• Fetching: {url}")
        print(f"üì• Fetching: {zipname}")

        response = await pyfetch(url)
        if response.ok:
            # Get bytes directly as Python bytes object
            zip_bytes = await response.bytes()
            save_to_cache(zipname, zip_bytes, encode_base64=True)
            return zip_bytes
        else:
            print(f"‚ùå Failed to download {url} - Status: {response.status}")
            # js.document.getElementById('loading-spinner').style.display = 'none'
            return None


    # Extract CSV inside the ZIP
    def extract_csv_from_zip(zip_bytes, password=None):
        print('----> extract_csv_from_zip()')
        try:
            print(f"üîì Extracting ZIP file ({len(zip_bytes)} bytes)...")
            with zipfile.ZipFile(BytesIO(zip_bytes)) as z:
                files = z.namelist()
                print(f"üìÇ Files in ZIP: {files}")
                name = files[0]  # First file in ZIP
                print(f"üìÑ Reading: {name}")
                if password is None:
                    with z.open(name) as f:
                        df = pd.read_csv(f, sep=';')
                else:
                    with z.open(name, pwd=password.encode()) as f:
                        df = pd.read_csv(f, sep=';')
                print(f"‚úÖ CSV parsed: {len(df)} rows, {len(df.columns)} columns")
            return df
        except zipfile.BadZipFile as e:
            print(f"‚ùå BadZipFile error: {e}")
            print(f"First 100 bytes: {zip_bytes[:100]}")
            raise
        except Exception as e:
            print(f"‚ùå Error extracting CSV: {type(e).__name__}: {e}")
            # js.document.getElementById('loading-spinner').style.display = 'none'
            raise


    # ================================================
    # METAR HELPERS
    # ================================================

    def get_top_metar_stations(fname, n=5, return_df=False):
        # Retrieve all metar stations for the country
        print(f'>func: get_top_metar_stations({fname}, {n})')

        icao = js.window.flight_plan_data[f'{fname}_ICAO']
        lat = js.window.flight_plan_data[f'{fname}_LATLON'][0]
        lon = js.window.flight_plan_data[f'{fname}_LATLON'][1]

        print(f'   >icao: {icao}, lat: {lat}, lon: {lon}')

        # Import METAR station data
        df_stations = get_metar_stations(todf=True)
        # print(df_stations)

        if n is None or n > df_stations.shape[0]:
            n = df_stations.shape[0]

        # If icao is in df_stations
        # if icao in df_stations['icao'].values:
        #    print(f'   >Found {icao} in METAR stations')
        #    return [icao]

        # Return all or selection
        if (lat is not None) and (lon is not None):
            # Compute haversine distance
            df_stations['distance_to_target'] = haversine_distances(lat, lon, df_stations['lat'].values, df_stations['lon'].values)
            # df_stations['distance_to_target'] = df_stations.apply(lambda row: compute.haversine(row['lat'], row['lon'], lat, lon), axis=1)
            # Sort on closest METAR stations
            df_stations.sort_values(by='distance_to_target', inplace=True)
        else:
            df_stations['distance_to_target'] = None

        # Filter on top distance metar stations
        icao_stations = list(df_stations['icao'].values[0:int(n)])
        # name_stations = list(df_stations['name'].values[0:int(n)])

        # print(df_stations)
        # print(icao_stations)
        # print(name_stations)

        # Return
        if return_df:
            return df_stations
        else:
            return icao_stations


    def get_metar_stations(fname=None, todf=True):
        if fname == 'DEPARTURE':
            AERODROME_DATA = window.AERODROME_DEPARTURE_DATA.copy()
        elif fname == 'ARRIVAL':
            AERODROME_DATA = window.AERODROME_ARRIVAL_DATA.copy()
        else:
            AERODROME_DATA = window.AERODROME_DATA.copy()

        if todf:
            icao_with_metar = [
            {"icao": item["icao"], "lat": item["lat"], "lon": item["lon"], "country": item["country"], "name": item["name"]}
                for item in AERODROME_DATA
                if item.get("metar_station") is True
            ]
            icao_with_metar = pd.DataFrame(icao_with_metar)
        else:
            icao_with_metar = {
                item["icao"]: {"lat": item["lat"], "lon": item["lon"], "country": item["country"], "name": item["name"]}
                for item in AERODROME_DATA
                if item.get("metar_station") is True
            }

        # Return
        return icao_with_metar

    def remove_metar_widget(fname):
        """Remove METAR widget for the specified aerodrome if it exists"""
        print(f"> func: remove_metar_widget({fname})")

        # Clear the METAR container
        widget_id = f"{fname}-WidgetContainer"
        widget = js.document.getElementById(widget_id)
        # Clear the container instead of removing it
        if widget:
            widget.innerHTML = ''
            print(f"   >üßπ Cleared METAR widget for {fname}")

        datetime_field = js.document.getElementById(f'DATETIME-METAR-{fname}')
        # button = js.document.getElementById(f'BTN-METAR-{fname}')
        metarField = js.document.getElementById(f'METAR-FIELD-{fname}')
        metarText = js.document.getElementById(f'METAR-TEXT-{fname}')

        windDirectionField = js.document.getElementById(fname + '_WIND_DIRECTION');
        windSpeedField = js.document.getElementById(fname + '_WIND_STRENGTH');
        windGustField = js.document.getElementById(fname + '_WIND_GUST');
        windVariationField = js.document.getElementById(fname + '_WIND_VARIATION');
        # windHeadwindField = js.document.getElementById(fname + '_WIND_HEADWIND');
        # windCrosswindField = js.document.getElementById(fname + '_WIND_CROSSWIND');
        tempField = js.document.getElementById(fname + '_TEMPERATURE');
        QNHField = js.document.getElementById(fname + '_QNH');

        # button.style.backgroundColor = '#006280';
        datetime_field.style.backgroundColor = 'transparent';
        metarField.style.backgroundColor = 'transparent';
        metarText.style.backgroundColor = 'transparent';

        metarText.value = ' '
        datetime_field.value = ''
        metarField.value = ''
        windDirectionField.value = '';
        windSpeedField.value = '';
        windGustField.value = '';
        windVariationField.value = '';
        tempField.value = '';
        QNHField.value = '';
        # windHeadwindField.value = '';
        # windCrosswindField.value = '';

        js.window.createWindTextbox(f'{fname.upper()}_WIND_HEADWIND', '-', 'DISABLED');
        js.window.createWindTextbox(f'{fname.upper()}_WIND_CROSSWIND', '-', 'DISABLED');

        # Clear datetime
        js.window.flight_plan_data[f'{fname.upper()}_METAR'] = ''
        js.window.flight_plan_data[f'{fname.upper()}_METAR_ICAO'] = ''
        print(f"üßπ Cleared METAR datetime for {fname}")


    def haversine_distances(lat1, lon1, lats, lons):
        distances = np.array(list(map(lambda x, y: haversine(lat1, lon1, x, y), lats, lons)))
        return distances


    def haversine(lat1, lon1, lat2, lon2):
        """
        Calculate the Haversine distance between two sets of latitude and longitude coordinates.

        Parameters
        ----------
        lat1 : float
            Latitude of the first point in degrees.
        lon1 : float
            Longitude of the first point in degrees.
        lat2 : float
            Latitude of the second point in degrees.
        lon2 : float
            Longitude of the second point in degrees.

        Returns
        -------
        float
            The Haversine distance between the two points in kilometers.

        Example
        -------
        >>> haversine(37.7749, -122.4194, 34.0522, -118.2437)
        >>> 616.7752155325443

        """
        # if (lat1 is None) or (lon1 is None) or (lat2 is None) or (lon2 is None):
        #     print(lat1)
        #     return None

        R = 6371  # Radius of the Earth in kilometers

        # Convert latitude and longitude from degrees to radians
        lat1, lon1, lat2, lon2 = map(math.radians, [lat1, lon1, lat2, lon2])

        # Haversine formula
        dlat = lat2 - lat1
        dlon = lon2 - lon1
        a = math.sin(dlat / 2) ** 2 + math.cos(lat1) * math.cos(lat2) * math.sin(dlon / 2) ** 2
        c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))

        # Distance in kilometers
        distance = R * c
        return distance

    # ================================================
    # AIRSPACE HELPERS
    # ================================================

    # Main loader: called from JS
    async def import_country_selected(fname, country, UNZIPK):
        print(f'>func: import_country_selected({fname}, {country})')
        zip_bytes = None

        try:
            url = js.window.URL_AERODROMES + country.replace(' ', '_') + ".zip"
            zip_bytes = await load_cached_zip(f"aerodrome_{country}", url)

            if zip_bytes:
                df = extract_csv_from_zip(zip_bytes, UNZIPK)
                js.console.log(f"   >‚úÖ Aerodromes loaded for {country}: {len(df)} rows.")
                print(f"   >‚úÖ Successfully loaded {len(df)} aerodromes for {country}")
                # print(df['country_code'])

                # For now, just show the first few entries
                # print(df.head().to_string())
                # print(f"Available columns: {df.columns.tolist()}")

                country_code = np.unique(df.get('country_code', ['']))
                country_code = country_code[0]
                #print(country_code)

                try:
                    # Store data in global variable
                    if fname == 'DEPARTURE':
                        js.window.AERODROME_DEPARTURE_DATA = df.to_dict('records')
                    elif fname == 'ARRIVAL':
                        js.window.AERODROME_ARRIVAL_DATA = df.to_dict('records')

                    # Combine departure and arrival data when possible and store in global variable
                    concat_country_aerodromes()

                    # Update flag
                    window.updateFlag(fname, country_code)

                except AttributeError as e:
                    error_msg = f"‚ö†Ô∏è Error processing aerodrome data: {str(e)}"
                    print(f"‚ùå {error_msg}")
                    js.window.alert("‚ö†Ô∏è Error processing aerodrome data. Please check your input and try again.");
                    return

                # Populate the dropdown with aerodrome data
                if 'city_icao' in df.columns:
                    icao_codes = df['city_icao'].dropna().unique().tolist()
                    print(f"   >üìç Found {len(icao_codes)} unique ICAO cities")

                    # Clear and populate the dropdown
                    select = js.document.getElementById(f'{fname}_ICAO_CITY')

                    # Clear existing options except the first placeholder
                    select.innerHTML = '<option value="">Select ICAO</option>'

                    # Add each ICAO city as an option
                    for icao in sorted(icao_codes):
                        option = js.document.createElement('option')
                        option.value = icao
                        option.textContent = icao
                        select.appendChild(option)

                    print(f"   >‚úÖ Populated {fname}_ICAO_CITY dropdown with {len(icao_codes)} cities")
                else:
                    print(f"   >‚ö†Ô∏è '{fname}_city_icao' column not found in dataframe")
                    print(f"   >Available columns: {df.columns.tolist()}")
        except Exception as e:
            error_msg = f"   >‚ö†Ô∏è No airspace data available for {country}: {str(e)}"
            print(f"{error_msg}")
            js.window.alert(f"‚ö†Ô∏è No airspace data is available for the selected country: {country}.")
            # js.document.getElementById('loading-spinner').style.display = 'none'
            return

        # Get and then concat airspaces
        concat_airspaces(country)

        # Hide loading spinner when done
        # js.document.getElementById('loading-spinner').style.display = 'none'


    def concat_airspaces(country):
        # Import airspace polygon data
        new_airspaces = import_airspaces(country)

        if new_airspaces:
            # Create country-specific prefixed keys
            prefixed_airspaces = {}
            for key, value in new_airspaces.items():
                new_key = f"{country}_{key}"
                value['country_id'] = country  # Add country identifier to the airspace data
                prefixed_airspaces[new_key] = value

            if hasattr(js.window, 'airspaces') and js.window.airspaces:
                # Append new country data to existing airspaces
                js.window.airspaces.update(prefixed_airspaces)
            else:
                # Initialize with first country
                js.window.airspaces = prefixed_airspaces
        # print(js.window.airspaces.keys())


    # ================================================
    # AERODROME HELPERS
    # ================================================

    def concat_country_aerodromes():
        # Combine departure and arrival data when possible and store in global variable

        # Check whether data is available
        has_departure = hasattr(window, "AERODROME_DEPARTURE_DATA")
        has_arrival   = hasattr(window, "AERODROME_ARRIVAL_DATA")

        # Store only what is available
        if has_departure and not has_arrival:
            js.window.AERODROME_DATA = js.window.AERODROME_DEPARTURE_DATA
        elif not has_departure and has_arrival:
            js.window.AERODROME_DATA = js.window.AERODROME_ARRIVAL_DATA
        elif has_departure and has_arrival:
            dep = window.AERODROME_DEPARTURE_DATA
            arr = window.AERODROME_ARRIVAL_DATA

            # handle both lists and dicts automatically
            if isinstance(dep, list) and isinstance(arr, list):
                window.AERODROME_DATA = dep + arr
                #print("OPTION 1")
            elif isinstance(dep, dict) and isinstance(arr, dict):
                window.AERODROME_DATA = {**dep, **arr}
                #print("OPTION 2")
            else:
                # fallback: convert to list if mixed
                window.AERODROME_DATA = list(dep) + list(arr)
                #print("OPTION 3")
        else:
            window.AERODROME_DATA = {}


    async def populate_aerodrome_fields_from_icao(fname, city_icao, load_from_cache=True):
        """Populate aerodrome fields when ICAO city is selected."""
        print(f'> func: populate_aerodrome_fields_from_icao({fname}, {city_icao})')

        # Load from cache if available
        if load_from_cache:
            isLoaded = await load_aerodrome_from_json(fname.upper(), icao=city_icao, verbose='silent')
            if isLoaded:
                print(f"   >‚úÖ Aerodrome is loaded from cache! <do not retrieve any other data>")
                return

        # Get the stored dataframe
        if not hasattr(js.window, f'AERODROME_{fname}_DATA'):
            print(f"   >‚ö†Ô∏è No aerodrome data available:'AERODROME_{fname}_DATA'")
            return

        # Get data
        if fname == 'DEPARTURE':
            df = js.window.AERODROME_DEPARTURE_DATA
        elif fname == 'ARRIVAL':
            df = js.window.AERODROME_ARRIVAL_DATA

        # Get data for specific ICAO
        row_dict = get_icao_data(df, city_icao)

        if not row_dict:
            print(f"   >‚ö†Ô∏è No data found for {city_icao}")
            return

        # Get runway data
        rwy_ids, rwy_list = retrieve_runways(row_dict)
        #print('HERE')
        #print(row_dict)

        # Store data
        CTR_BOOL = row_dict['AERODROME_CTR']

        js.window.flight_plan_data[f"{fname}_ICAO"] = row_dict['icao']
        js.window.flight_plan_data[f"{fname}_ICAO_CITY"] = city_icao
        js.window.flight_plan_data[f"{fname}_CITY"] = str(row_dict['city']).upper()
        js.window.flight_plan_data[f"{fname}_RUNWAYS"] = rwy_list
        js.window.flight_plan_data[f"{fname}_RUNWAY_PROPERTIES"] = row_dict['runways']
        js.window.flight_plan_data[f"{fname}_RUNWAY_NR"] = clean_string(rwy_ids)
        js.window.flight_plan_data[f"{fname}_ELEVATION"] = str(row_dict['elevation_aerodrome']).split('.')[0]
        js.window.flight_plan_data[f"{fname}_NAME"] = row_dict['name']
        js.window.flight_plan_data[f"{fname}_METAR"] = ''
        js.window.flight_plan_data[f"{fname}_METAR_ICAO"] = ''
        js.window.flight_plan_data[f"{fname}_WIND_ENVELOPE"] = ''
        js.window.flight_plan_data[f"{fname}_CTR"] = 'CTR' if CTR_BOOL else ''
        js.window.flight_plan_data[f"{fname}_COUNTRY"] = row_dict['country']
        js.window.flight_plan_data[f"{fname}_COUNTRY_CODE"] = row_dict['country_code']
        js.window.flight_plan_data[f"{fname}_IMAGE"] = row_dict.get('url.wikipedia.aerodrome.image', None)
        js.window.flight_plan_data[f"{fname}_URL_WEBSITE"] = row_dict.get('url.website', '')
        js.window.flight_plan_data[f"{fname}_URL_WIKIPEDIA"] = row_dict.get('url.wikipedia', '')
        js.window.flight_plan_data[f"{fname}_LATLON"] = [row_dict.get('lat', None), row_dict.get('lon', None)]
        js.window.flight_plan_data[f"{fname}_TIMEZONE"] = row_dict.get('tz', None)
        js.document.getElementById(f'{fname}_CTR').value = 'CTR' if CTR_BOOL else ''
        js.document.getElementById(f'{fname}_CTR').dispatchEvent(js.Event.new('change'))

        # Update route map if both departure and arrival coordinates are available
        # if hasattr(js.window, 'updateRouteLine'): js.window.updateRouteLine()

        if fname == 'DEPARTURE':
            # Handle FREQ_TOWER_RADIO
            FREQ_TOWER_RADIO = row_dict['freqs.TOWER'] if CTR_BOOL else row_dict['freqs.RADIO']
            js.window.flight_plan_data["DEPARTURE_ATC_TOWER"] = clean_string(FREQ_TOWER_RADIO)

            # MAPPING OF THE FREQUENCIES
            field_mapping = {
              f"{fname}_ATC_ATIS_FREQ": 'freqs.ATIS',
              f"{fname}_ATC_GROUND": 'freqs.DELIVERY/GROUND',
              f"{fname}_ATC_APPROACH": 'freqs.APPROACH',
              f"{fname}_ATC_TELEPHONE": 'freqs.TELEPHONE',
              'FIC_NAME': 'freqs.FIC_NAME',
              'FIC_FREQUENCY': 'freqs.FIC_FREQUENCY',
              'FIC_NAME2': 'freqs.FIC_NAME_2',
              'FIC_FREQUENCY2': 'freqs.FIC_FREQUENCY_2',
            }

            # FILL THE FREQUENCIES
            for key, colname in field_mapping.items():
              freq_raw = row_dict[colname]
              freq_clean = clean_string(freq_raw)
              js.window.flight_plan_data[key] = freq_clean
              print(f"  {key}: {js.window.flight_plan_data[key]}")

        # Remove METAR widget
        remove_metar_widget(fname)
        # Cleanly initialize runway plot
        js.window.cleanRunwayFields(fname, 'empty')
        # remove wind envelope plot
        js.window.cleanWindEnvelopeFields(fname, 'empty')
        # Clean Weigth&Balance
        js.window.cleanWeightBalanceFields(fname, 'empty');

        # Update GUI fields for aerodrome but not the aircraft fields
        update_aerodrome_gui_fields(fname, updateAircraftFields=False)

        # Update time and clock for departure only
        time_dep = js.document.getElementById('DEPARTURE_clockField').value
        js.window.UpdateFlightInfoFields(time_dep, True, True)

        # Update images for aerodrome
        await update_aerodrome_image(fname)
        # Retrieve METAR
        await js.window.retrieve_metar(fname)

        # Update weight and balance
        js.window.aircraft_populate_js();
        js.window.update_aerodrome_weights_js(fname);
        # Compute Fuel per leg
        js.window.computeArrivalFuelPerLeg();
        # Compute Weight and Balance
        js.window.WeightBalanceMain(fname)
        js.window.syncWeightCheckboxesAndFields(f'{fname}_WEIGHT_CHECKBOX')

        # Set runway surface
        js.window.setRunwaySurface(fname)
        # Compute Runway stats
        js.window.displayRunwayMain(fname)
        # Update missing fields
        js.window.highlightMissingFields()
        js.window.highlightDropdownMenus(fname)

        #js.window.alert('here after making selectionbox choice for icao')


    # ================================================
    # GUI HELPERS
    # ================================================

    def clean_string(value):
        # Convert to string and strip brackets/quotes
        freq_str = str(value).strip().strip('[]').replace("'", "").replace('"', '')
        # Split, clean, and filter empty items
        parts = [f.strip() for f in freq_str.split(',') if f.strip()]
        # Return
        return ', '.join(parts)

    def create_callsign_short(CALLSIGN):
        # Create short callsign automatically
        CALLSIGN_SHORT = ''
        if CALLSIGN is not None and CALLSIGN != '':
            CALLSIGN_SHORT = CALLSIGN[0] + CALLSIGN[-2:]
        return CALLSIGN_SHORT

    def TEXT_INFORMATION_RECEIVED():
        """Return text confirming information received"""
        return '<br><br>INFORMATION <strong class="pilot_text"> [ .   .   .   .   .   . ]</strong> RECEIVED,'

    async def clear_general_fields():
        """Clear all GENERAL GUI fields and flight_plan_data"""
        print("üßπ Clearing all GENERAL fields...")

        # List of all departure fields to clear
        field_ids = [
          'FLIGHTPLAN',
          'DATETIME_CREATION',
          'CALLSIGN',
          'AIRCRAFT_TYPE',
          'FLIGHT_RULES',
          'POB',
        ]

        # Clear GUI fields
        for field_id in field_ids:
            element = js.document.getElementById(field_id)
            if element:
                if field_id == 'FLIGHT_RULES':
                    element.value = 'VFR'
                elif field_id == 'DATETIME_CREATION':
                    element.textContent = 'FLIGHT PLAN'
                else:
                    element.value = ''

        # Clear flight_plan_data
        keys = field_ids + ['CALLSIGN_SHORT']
        for key in keys:
            if key == 'FLIGHT_RULES':
                js.window.flight_plan_data[key] = 'VFR'
            elif field_id == 'DATETIME_CREATION':
                js.window.flight_plan_data[key] = 'FLIGHT PLAN'
            else:
                js.window.flight_plan_data[key] = ''

        js.document.getElementById('DEPARTURE_clockField').value = '00:00'
        js.document.getElementById('ARRIVAL_clockField').value = '00:00'   # Default is '--:--'
        js.document.getElementById('DEPARTURE_FLIGHT_DISTANCE_INFO').textContent = '- km, - min.'
        js.document.getElementById('ARRIVAL_FLIGHT_DISTANCE_INFO').textContent = '- km, - min.'
        js.document.getElementById('distance-km').textContent = '0'
        js.document.getElementById('flying-minutes').textContent = '0'
        js.document.getElementById('departure-time').textContent = ''
        js.document.getElementById('arrival-time').textContent = ''

        # Clear flashcards
        js.window.flashcardClean('DEPARTURE')
        js.window.flashcardClean('ARRIVAL')

        # Clear checklist
        js.window.flight_plan_data['CHECKLIST'] = get_default_checklist()
        # Clear aircraft
        js.window.flight_plan_data['AIRCRAFT'] = get_default_aircraft()


    def update_general_gui_fields(flight_plan_dict):
        """Update GENERAL GUI fields from js.window.flight_plan_data"""
        print('----> update_general_gui_fields()')
        print("üîÑ Updating GENERAL GUI fields...")

        fields = ['FLIGHTPLAN', 'CALLSIGN', 'AIRCRAFT_TYPE', 'POB', 'FLIGHT_RULES', 'DATETIME_CREATION']
        for field in fields:
            if flight_plan_dict.get(field):
                element = js.document.getElementById(field)
                if field=='DATETIME_CREATION':
                    element.textContent = flight_plan_dict[field]
                else:
                    element.value = flight_plan_dict[field]


    def update_enroute_gui_fields(enroute_dict, spinner_name):
        """Update ENROUTE GUI fields from js.window.flight_plan_data"""
        print('>func: update_enroute_gui_fields()')
        print("üîÑ Updating ENROUTE GUI fields...")

        # Get all fields that need updating
        if spinner_name == 'fic_spinner':
            fields = ['FIC_NAME', 'FIC_FREQUENCY', 'OVERHEAD', 'SQUAWK']
        else:
            fields = ['FIC_NAME2', 'FIC_FREQUENCY2', 'OVERHEAD2', 'SQUAWK2']

        # Update each GUI field from flight_plan_data
        for field in fields:
            element = js.document.getElementById(field)
            if element:
                value = js.window.flight_plan_data.get(field, '')
                element.value = value if value not in ('', None, 'None', 'nan') else ''

        for field in fields:
            if enroute_dict.get(field):
                js.document.getElementById(field).value = enroute_dict[field]



    def update_aerodrome_gui_fields(fname, updateAircraftFields=True):
        """Update GENERAL GUI fields from js.window.flight_plan_data"""
        print('> func: update_aerodrome_gui_fields()')

        # List of field IDs to update
        field_ids = [
            f'{fname}_COUNTRY',
            f'{fname}_ICAO_CITY',
            f'{fname}_CITY',
            f'{fname}_NAME',
            f'{fname}_ICAO',
            f'{fname}_POSITION',
            f'{fname}_RUNWAY_NR',
            f'{fname}_RUNWAY_LENGTH',
            f'{fname}_RUNWAY_SLOPE',
            f'{fname}_RUNWAY_SURFACE',
            f'{fname}_RUNWAY_CONDITION',
            f'{fname}_RUNWAY_SLIPPERY',
            f'{fname}_ELEVATION',
            f'{fname}_ROUTE_NAME',
            f'{fname}_ROUTE_ALTITUDE',
            f'{fname}_CIRCUIT_ALTITUDE',
            f'{fname}_CTR',
            f'{fname}_ATC_TOWER',
            f'{fname}_ATC_APPROACH',
            f'{fname}_ATC_ATIS_FREQ',
            f'{fname}_ATC_GROUND',
            f'{fname}_ATC_TELEPHONE',
        ]

        if updateAircraftFields:
            field_ids2 = [
                f'{fname}_WEIGHT_FUEL_LITERS', f'{fname}_WEIGHT_PILOT', f'{fname}_WEIGHT_COPILOT',
                f'{fname}_WEIGHT_REAR_LEFT', f'{fname}_WEIGHT_REAR_RIGHT', f'{fname}_WEIGHT_BAGAGE',
            ]
            field_ids = field_ids + field_ids2

        # Only update these fields based on DEPARTURE
        if fname == 'DEPARTURE':
            field_ids = field_ids + [
                'FIC_NAME',
                'FIC_FREQUENCY',
                'SQUAWK',
                'OVERHEAD',
                'FIC_NAME2',
                'FIC_FREQUENCY2',
                'SQUAWK2',
                'OVERHEAD2',
            ]

        updated_count = 0
        for field_id in field_ids:
            # Get the value from flight_plan_data
            value = js.window.flight_plan_data.get(field_id)

            # Get the HTML element
            element = js.document.getElementById(field_id)

            # Only continue if element exists
            if element:
                # Convert value to string and handle special cases
                if value is not None and value != '' and str(value) != 'nan' and str(value) != 'None':

                  # Handle boolean for CTR
                    if field_id == f'{fname}_CTR':
                        element.value = 'CTR' if (value or str(value).lower() == 'true') else ''
                    elif field_id == f'{fname}_CITY':
                        # Do this trick to make sure the length of both cities are similar to keep the GUI alignment
                        #element.textContent = str(value[:15].ljust(15, ' '))
                        element.textContent = str(value)
                    elif field_id == f'{fname}_RUNWAY_LENGTH':
                        #print('HERE')
                        #print(f"  ‚úì Updated {field_id}: {str(value)}")
                        #value = js.window.ft2meter(value)
                        element.value = str(value)
                    else:
                        element.value = str(value)

                    updated_count += 1
                    print(f"  ‚úì Updated {field_id}: {str(value)}")
                else:
                    # Clear the field if no value
                    element.value = ''
            else:
                print(f"  >‚ö†Ô∏è Element not found: {field_id}")

        # For the ICAO field: also sync its mirror
        icao_element = js.document.getElementById(f'{fname}_ICAO')
        element_label = js.document.getElementById(f'{fname}_CITY')

        # Show city name when loading the ICAO with a maximum of 10 chars
        label = element_label.textContent
        element_label.textContent = f'{label}'

        # Update weight and balance
        if updateAircraftFields:
            js.window.WeightBalanceMain(fname)
            js.window.syncWeightCheckboxesAndFields(f'{fname}_WEIGHT_CHECKBOX')

        print(f"   >‚úÖ Updated {updated_count} GUI fields")


    async def clear_enroute_fields():
        """Clear all ENROUTE GUI fields and flight_plan_data"""
        print('----> clear_enroute_fields()')
        print("üßπ Clearing all ENROUTE fields...")

        # Clear GUI fields
        js.document.getElementById('FIC_NAME').value = ''
        js.document.getElementById('FIC_FREQUENCY').value = ''
        js.document.getElementById('OVERHEAD').value = ''
        js.document.getElementById('SQUAWK').value = ''
        js.document.getElementById('FIC_NAME2').value = ''
        js.document.getElementById('FIC_FREQUENCY2').value = ''
        js.document.getElementById('OVERHEAD2').value = ''
        js.document.getElementById('SQUAWK2').value = ''

        # Clear enroute fields
        enroute_keys = [
            'FIC_NAME', 'FIC_FREQUENCY', 'FIC_NAME2', 'FIC_FREQUENCY2',
            'OVERHEAD', 'OVERHEAD2', 'SQUAWK', 'SQUAWK2',
        ]

        for key in enroute_keys:
            js.window.flight_plan_data[key] = ''


    async def clear_aerodrome_fields(fname, clearAircraftFields=True):
        """Clear all aerodrome GUI fields and flight_plan_data"""
        print(f'> func: clear_aerodrome_fields({fname})')
        print(f"   >üßπ Clearing all {fname} fields...")

        # List of all departure/arrival fields to clear - ensure critical fields are included
        field_ids = [
            f'{fname}_COUNTRY',
            f'{fname}_ICAO_CITY',
            f'{fname}_CITY',
            f'{fname}_CTR',
            f'{fname}_NAME',
            f'{fname}_ICAO',
            f'{fname}_POSITION',
            f'{fname}_RUNWAY_NR',
            f'{fname}_RUNWAY_LENGTH',
            f'{fname}_RUNWAY_SLOPE',
            f'{fname}_RUNWAY_SURFACE',
            f'{fname}_RUNWAY_CONDITION',
            f'{fname}_RUNWAY_SLIPPERY',
            f'{fname}_ELEVATION',
            f'{fname}_ROUTE_NAME',
            f'{fname}_ROUTE_ALTITUDE',
            f'{fname}_CIRCUIT_ALTITUDE',
            f'{fname}_ATC_TOWER',
            f'{fname}_ATC_APPROACH',
            f'{fname}_ATC_ATIS_FREQ',
            f'{fname}_ATC_GROUND',
            f'{fname}_ATC_TELEPHONE',
            f'{fname}_WIND_DIRECTION',
            f'{fname}_TEMPERATURE',
            f'{fname}_QNH',
            f'{fname}_WIND_STRENGTH',
            f'{fname}_WIND_GUST',
            f'{fname}_WIND_VARIATION',
            # f'{fname}_WIND_HEADWIND',
            # f'{fname}_WIND_CROSSWIND',
            f'DATETIME-METAR-{fname}',
            f'METAR-FIELD-{fname}',
            f'METAR-TEXT-{fname}',
        ]

        if clearAircraftFields:
            field_ids2 = [
                f'{fname}_WEIGHT_FUEL_LITERS',
                f'{fname}_WEIGHT_PILOT',
                f'{fname}_WEIGHT_COPILOT',
                f'{fname}_WEIGHT_REAR_LEFT',
                f'{fname}_WEIGHT_REAR_RIGHT',
                f'{fname}_WEIGHT_BAGAGE',
            ]
            field_ids = field_ids + field_ids2

        print(f"Clearing fields for {fname}:")

        # Clear aerdrome image
        js.document.getElementById(f'{fname}_image_cache').src = js.window.IMG_DEFAULT_AIRFIELD
        js.document.getElementById(fname + "_SELECT_AERODROME_BORDER_1").style.backgroundColor = js.window.EMPTYCOLOR

        # Reset colors of METAR
        js.document.getElementById(fname + "_METARMENU_BACKGROUND").style.backgroundColor = js.window.DEFAULTCOLOR
        js.document.getElementById(fname + '_METARMENU_TOP').textContent = "‚ö†Ô∏è METAR"
        # js.document.getElementById(fname + "_METARMENU_TOP").style.backgroundColor = js.window.EMPTYCOLOR

        # Clear head/crosswind
        js.window.createWindTextbox(f'{fname.upper()}_WIND_HEADWIND', '-', 'DISABLED')
        js.window.createWindTextbox(f'{fname.upper()}_WIND_CROSSWIND', '-', 'DISABLED')

        # Clear all GUI fields with overlapping names
        for field_id in field_ids:
            default_value = ''
            # Get GUI element
            element = js.document.getElementById(field_id)

            if element:
                # Check whether it is one of the weight-elements and set value to 0
                if '_WEIGHT_' in field_id: default_value = 0
                print(f"   >üßπ Clearing {field_id}")

                if hasattr(element, "value"):
                    element.value = default_value
                else:
                    element.textContent = default_value

                # Trigger change event to update any dependent fields
                if field_id.endswith('_CTR'):
                    js.document.getElementById(field_id).dispatchEvent(js.Event.new('change'))


        # Set label back
        element = js.document.getElementById(f'{fname}_CITY')
        element.textContent = f'{fname.upper()}'

        # Clear flight_plan_data for aerodrome fields
        keys = [
            f'{fname}_COUNTRY', f'{fname}_COUNTRY_CODE', f'{fname}_ICAO_CITY',
            f'{fname}_ICAO', f'{fname}_ICAO_CITY', f'{fname}_CITY', f'{fname}_NAME',
            f'{fname}_POSITION',
            f'{fname}_RUNWAYS', f'{fname}_RUNWAY_PROPERTIES', f'{fname}_RUNWAY_NR'
            f'{fname}_RUNWAY_LENGTH', f'{fname}_RUNWAY_SLOPE', f'{fname}_RUNWAY_SURFACE',
            f'{fname}_RUNWAY_CONDITION', f'{fname}_RUNWAY_SLIPPERY', f'{fname}_ELEVATION',
            f'{fname}_ROUTE_NAME', f'{fname}_ROUTE_ALTITUDE',
            f'{fname}_CIRCUIT_ALTITUDE', f'{fname}_CTR', f'{fname}_IMAGE',
            f'{fname}_URL_WEBSITE', f'{fname}_URL_WIKIPEDIA', f'{fname}_LATLON',
            f'{fname}_METAR_ICAO', f'{fname}_METAR', f'{fname}_WIND_ENVELOPE',
            f'{fname}_CLOUD', f'{fname}_TIMEZONE', f'{fname}_ATC_TOWER',
            f'{fname}_ATC_ATIS_FREQ', f'{fname}_ATC_GROUND', f'{fname}_ATC_APPROACH',
            f'{fname}_ATC_TELEPHONE',
        ]

        if clearAircraftFields:
            keys = keys + field_ids2

        for key in keys:
            if key == f'{fname}_CTR':
                js.window.flight_plan_data[key] = False
            elif '_LATLON' in key:
                js.window.flight_plan_data[key] = [None, None]
            elif key in [f'{fname}_METAR', f'{fname}_METAR_ICAO', f'{fname}_WIND_ENVELOPE']:
                js.window.flight_plan_data[key] = ''
            elif key in [f'{fname}_CLOUD', f'{fname}_RUNWAYS']:
                js.window.flight_plan_data[key] = ''
            else:
                js.window.flight_plan_data[key] = ''

        # Clear flashcard
        js.window.flashcardClean(fname)
        # Remove METAR widget
        remove_metar_widget(fname)
        # Remove wind envelope
        js.window.cleanWindEnvelopeFields(fname, 'empty')
        # Clean Weigth&Balance
        js.window.cleanWeightBalanceFields(fname, 'empty');
        # Remove runway image
        js.window.cleanRunwayFields(fname, 'empty')
        # Remove flag
        js.window.updateFlag(fname, 'remove')
        # Remove VFR icon
        js.window.updateFlightCatagoryIcon(fname, remove=True)
        # Stop animations
        js.window.animations(fname, "stop")
        # Create cloud plot
        js.window.createCloudPlot(fname, "clean");
        # Update weight and balance
        if clearAircraftFields:
            js.window.WeightBalanceMain(fname)
            js.window.syncWeightCheckboxesAndFields(f'{fname}_WEIGHT_CHECKBOX')
        # Update missing fields colors
        js.window.highlightMissingFields()
        js.window.highlightDropdownMenus()

        # Clear selectionbox (WARNING: CAN NOT BE CLEARED HERE BECAUSE THE ICOA SELECTIONS WILL BE RESET AFTER SELECTION)
        # select = js.document.getElementById(f'{fname}_ICAO_CITY')
        # select.innerHTML = '<option value="">Select ICAO</option>'


    # ================================================
    # IMAGE HELPERS
    # ================================================

    async def update_aerodrome_image(fname):
        """Update image from DEPARTURE_IMAGE or ARRIVAL_IMAGE or use default"""
        print(f"> func: update_aerodrome_image({fname})")

        # Update flag
        window.updateFlag(fname)

        # Get the image URL from flight_plan_data
        # 1. from GitHub
        # 2. from wikipedia
        # 3. from default
        image_url1 = os.path.join(js.window.URL_AERODROMES_IMAGES, js.window.flight_plan_data[f'{fname}_ICAO']) + '.png' if js.window.flight_plan_data[f'{fname}_ICAO'] != '' else None
        image_url2 = js.window.flight_plan_data.get(f'{fname}_IMAGE')

        for image_url in [image_url1, image_url2]:
            if await cache_and_display_image(image_url, f'{fname}_image_cache'):
                print(f"  üìã {fname}_IMAGE from flight_plan_data: {image_url}")
                return

        # Set the default image when all other fails
        js.document.getElementById(f'{fname}_image_cache').src = js.window.IMG_DEFAULT_AIRFIELD


    async def cache_and_display_image(url, img_element_id):
        """Cache and display an image using browser cache API"""
        # If the URL is invalid or missing, return without displaying an image
        if not url or str(url) == 'None' or str(url) == '' or str(url) == 'nan' or not str(url).startswith('http'):
            return False

        try:
            cache = await js.caches.open("skywalk-cache-v1")

            # Try loading from cache
            response = await cache.match(url)

            if not response:
                print(f"  üì• Image not cached, downloading: {url}")
                response = await js.fetch(url)
                if response.ok:
                    await cache.put(url, response.clone())
                else:
                    print(f"  ‚ùå Failed to fetch image: {response.status}")
                    return False
            else:
                print(f"  üì¶ Loaded from cache: {url}")

            # Convert response to blob and display
            blob = await response.blob()
            object_url = js.URL.createObjectURL(blob)
            js.document.getElementById(img_element_id).src = object_url
            print(f"  ‚úÖ Image displayed: {img_element_id}")
            return True

        except Exception as e:
            print(f"  ‚ùå Error caching/displaying image: {e}")
            raise
            return False


    def get_icao_data(df, city_icao, colname='city_icao'):
        """Load custom icao from disk and update"""
        row_dict = {}
        for df_row in df:
            if df_row.get('city_icao') == city_icao:
                row_dict = df_row
                break
        # Return
        return row_dict

    # ================================================
    # WIND ENVELOPE HELPERS
    # ================================================

    def compute_wind_envelope(fname):
        """Compute the wind envelope based on the METAR data and runway number.

        The wind envelope can be used to visually see whether the crosswind/headwind remains within the limits
        with variable winds. To compute this, the wind strenghts is kept constant but the wind direction is varied
        from 0-360 degrees. If the red line (the present wind conditions) crosses the the blue line
        (the maximum wind limits), it indicates that certain wind angles can push the aircraft outside the maximum
        crosswind/headwind limits.

        The wind envelope is computed with the following parameters:
        - runway_number: The runway number.
        - max_headwind: The maximum headwind limit.
        - max_crosswind: The maximum crosswind limit.

        From the METAR data, the following parameters are used:
        - wind direction: The wind direction.
        - wind strength: The wind strength.
        - wind gust: The wind gust.
        - wind variation: The wind variation.

        """
        logger.info(f"func: compute_wind_envelope() - {fname}")

        # Get the METAR data and runway number
        METAR_DATA = js.window.flight_plan_data.get(f"{fname}_METAR_ICAO", {})
        RUNWAY = js.window.flight_plan_data.get(f"{fname}_RUNWAY_NR", "")
        # Check if the runway and METAR data are set, otherwise show a popup and return
        if RUNWAY == "" or METAR_DATA == {}:
            logger.warning(f"Set the runway.")
            print("Set Runway", "Please set the runway.")
            return

        js.window.flight_plan_data[f"{fname}_METAR"] = METAR_DATA

    # ================================================
    # RUNWAY HELPERS
    # ================================================

    def retrieve_runways(row_dict):
        """Retrieve the runways from ICAO"""
        # row_dict = get_icao_data(df, city_icao)
        rwy_ids, rwy_list = [], []

        # Get all INFORMATION for the selected ICAO
        if row_dict:
            runways = row_dict.get("runways", [])
            if isinstance(runways, str): runways = ast.literal_eval(runways)
            rwy_ids = [r["id"] for r in runways if isinstance(r, dict) and "id" in r]
            rwy_list = options_runway_number(runways)

        # Return
        return rwy_ids, rwy_list


    def options_runway_number(data):
        """Retrieve all available runways based on aerodrome ICAO."""
        runways = []
        if data is not None:
            runways = [num for rwy in data for num in rwy.get("number", [])]
            runways = list(filter(lambda x: x != '', runways))

        # Return
        return runways

    def predict_runway_number(fname, wind_direction='', wind_strength=''):
        """Compute the expected runway based on wind information for a given aerodrome."""
        print(f'> func: predict_runway_number({fname})')
        # Defaults
        expect_runway = ''
        runwayField = js.document.getElementById(fname + "_RUNWAY_NR")
        runwaysGUI = runwayField.value.strip()

        # Get information from GUI when wind fields are not forced
        if wind_direction == '' or wind_strength == '':
            wind_direction = js.document.getElementById(fname + "_WIND_DIRECTION").value
            wind_strength = js.document.getElementById(fname + "_WIND_STRENGTH").value
            if is_numeric(wind_direction): wind_direction = int(wind_direction)
            if is_numeric(wind_strength): wind_strength = int(wind_strength)

        # Get all runways for the aerodrome. We need to copy the list to avoid modifying the original data
        try:
            runways = js.window.flight_plan_data[f"{fname}_RUNWAYS"].copy()
        except Exception:
            return

        # Add more runways if provided
        if runwaysGUI is not None and runwaysGUI.strip() != '':
            rwys_clean = re.findall(r'\d+', runwaysGUI)
            runways.extend(rwys_clean)
            runways = list(set(runways))
        print(f'   >All available runways: {runways}')

        # Compute the expected runway number
        if (len(runways) > 0) and (wind_direction is not None) and is_numeric(wind_direction):
            results = list(map(lambda x: runway_headwind(wind_direction, wind_strength, x), runways))
            if np.any(results):
                expect_runway = runways[np.where(results)[0][0]]
        else:
            # js.window.messages = f'No wind direction: {wind_direction} or wind strength: {wind_strength} or runways: {runways}.'
            print(f'   >No wind direction {wind_direction} or wind_strength {wind_strength} or runways {runways} found')

        # Update the GUI input field
        if (expect_runway != '' and expect_runway is not None):
            # Set new runway
            runwayField.value = expect_runway
            # Change color
            # runwayField.style.backgroundColor = "#e6f0ff";
            # metarText.value = js.window.messages;
            # Update runway properties
            js.window.setRunwaySurface(fname)
            js.window.displayRunwayMain(fname)

        # Return
        print(f'   >Predicted runway: {expect_runway}')
        return expect_runway

    def runway_headwind(wind_direction, wind_strength, runway_direction):
        """Compute whether the input runway number has headwind.

        Parameters
        ----------
        wind_direction : int[0-360]
            The wind direction in degrees.
        wind_strength : float
            The strenght of the wind.
        runway_direction : String or integer
            The runway direction in degrees but in 2 decimals '24' or '06' etc.
        """
        if (wind_direction is None) or not is_numeric(wind_direction) or (wind_strength is None) or (runway_direction is None):
            return None

        runway_direction = js.window.correctRunwayNumber(runway_direction)
        if not isinstance(runway_direction, (int, float)):
            return None

        cos_result = js.window.headwindCalc(wind_direction, wind_strength, runway_direction)

        if cos_result > 0:
            return True
        else:
            return False

    # ================================================
    # WIND HELPERS
    # ================================================

    def variable_wind_range(wind_vrb):
        # Input looks like: '190-350' or '340-40'
        if isinstance(wind_vrb, list): wind_vrb = wind_vrb[0]
        if wind_vrb == '' or wind_vrb is None:
            return None
        total_range = None
        # Split
        wind_vrb = np.array(wind_vrb.split('-'))
        # Check numeric
        wind_vrb = wind_vrb[np.array(list(map(is_numeric, wind_vrb)))]
        # Continue
        if len(wind_vrb) > 0:
            # Make int
            wind_vrb = list(map(int, wind_vrb))
            # Always make a list of 2
            if len(wind_vrb) >= 2:
                start, end = wind_vrb[0], wind_vrb[-1]
            else:
                start, end = wind_vrb[0], wind_vrb[0]

            # Compute range
            if start <= end:
                total_range = np.array(list(range(start, end + 1, 10)))
            else:
                total_range = np.array(list(range(start, 360, 10)) + list(range(0, end + 1, 10)))
        # Total range
        return total_range


    def is_numeric(value):
        """
        Check whether the input string is a numerical value.

        Parameters
        ----------
        value : str
            The input string to be checked.

        Returns
        -------
        bool
            True if the input string is a numerical value, False otherwise.

        Example
        -------
        >>> is_numeric("-2.9")
        >>> True
        >>> is_numeric("2.33")
        >>> True
        >>> is_numeric("22272")
        >>> True
        >>> is_numeric("0.003")
        >>> True
        >>> is_numeric("-0.003")
        >>> True
        >>> is_numeric("abc")
        >>> False
        >>> is_numeric("1.2.3")
        >>> False
        >>> is_numeric("1B")
        >>> False

        """
        # Check if the string is empty
        if (isinstance(value, str) and value == ''):
            return False
        if isinstance(value, (float, int)):
            return True
        if value is None:
            return False
        if isinstance(value, str):
            value = value.strip()

        # Allow negative numbers (starting with '-' at the beginning)
        if value[0] == '-':
            value = value[1:]

        # Allow decimal points in the string
        parts = value.split('.')
        if len(parts) <= 2 and all(part.isnumeric() for part in parts):
            return True

        return False

    # ================================================
    # FLIGHTPLAN HELPERS
    # ================================================

    async def create_new_flightplan():
        """Initialize new flightplan - returns current datetime for UI"""
        print("üÜï Creating new flightplan...")

        # Reset flight plan data
        js.window.flight_plan_data = {
            'DEPARTURE_LATLON': [None, None],
            'ARRIVAL_LATLON': [None, None],
            'DEPARTURE_COUNTRY': '',
            'ARRIVAL_COUNTRY': '',
        }
        # Clear fields
        await clear_general_fields()
        await clear_aerodrome_fields('DEPARTURE')
        await clear_aerodrome_fields('ARRIVAL')
        await clear_enroute_fields()

        # Populate with default items
        checklist_clean(verbose='silent')
        aircraft_clean(verbose='silent')

        select = js.document.getElementById('DEPARTURE_ICAO_CITY')
        select.innerHTML = '<option value="">Select ICAO</option>'
        select = js.document.getElementById('ARRIVAL_ICAO_CITY')
        select.innerHTML = '<option value="">Select ICAO</option>'

        js.window.AERODROME_DEPARTURE_DATA = {}
        js.window.AERODROME_ARRIVAL_DATA = {}
        js.window.AERODROME_DATA = {}
        js.window.airspaces = {}
        js.window.waypoints = []
        js.window.leginfo = {}
        js.window.RUNWAY = {}
        js.window.METAR_DEPARTURE = ''
        js.window.METAR_ARRIVAL = ''

        js.document.getElementById("CALLSIGN_LABEL").textContent = 'REGISTRATION'
        js.document.getElementById('DEPARTURE_clockField').value = '00:00'
        js.document.getElementById('ARRIVAL_clockField').value = '00:00'   # Default is '00:00'
        js.document.getElementById('DEPARTURE_FLIGHT_DISTANCE_INFO').textContent = 'Departure'
        js.document.getElementById('ARRIVAL_FLIGHT_DISTANCE_INFO').textContent = '- km, - min.'
        js.document.getElementById('distance-km').textContent = '0'
        js.document.getElementById('flying-minutes').textContent = '0'
        js.document.getElementById('departure-time').textContent = ''
        js.document.getElementById('arrival-time').textContent = ''

        # Clean flashcards
        js.window.flashcardClean('DEPARTURE')
        js.window.flashcardClean('ARRIVAL')

        # A new flightplan gets a new date
        js.window.flight_plan_data['DATETIME_CREATION'] = 'FLIGHT PLAN'

        print("‚úÖ New flightplan initialized - all fields cleared")
        # return current_time


    async def delete_flightplan():
        """Delete selected flightplan from localStorage"""
        plan_name = js.document.getElementById('plan_spinner').value

        if not plan_name or plan_name == "":
            print("‚ö†Ô∏è No flightplan selected")
            return

        # Confirm deletion
        if not js.window.confirm(f"Are you sure you want to delete '{plan_name}'?"):
            print("‚ùå Deletion cancelled")
            return

        # Delete from localStorage
        storage_key = f"FLIGHTPLAN_{plan_name}"
        js.localStorage.removeItem(storage_key)
        print(f"‚úÖ Flightplan '{plan_name}' deleted")

        # Clear the dropdown selection
        js.document.getElementById('plan_spinner').value = ""

        # Update the flightplan list
        update_dropdown('plan_spinner', cacheName='FLIGHTPLAN', keepSelection=False, elementId2='FLIGHTPLAN')

        """Create new flightplan with current timestamp"""
        await clear_general_fields()
        await clear_aerodrome_fields('DEPARTURE')
        await clear_aerodrome_fields('ARRIVAL')
        await clear_enroute_fields()

        # Set defaults checklist and reset GUI fields
        checklist_clean(verbose='silent')

        # Set defaults aircraft and reset GUI fields
        js.window.aircraft_clean(verbose='silent')

        # Clean flashcards
        js.window.flashcardClean('DEPARTURE')
        js.window.flashcardClean('ARRIVAL')

        # Clean flag
        # updateFlag('DEPARTURE', 'remove')
        # updateFlag('ARRIVAL', 'remove')


    async def delete_item_from_spinner(spinner_name, cacheName, elementId2=None):
        """Delete selected dropdown item in local cache"""
        # Get dropdown selection
        user_selection = js.document.getElementById(spinner_name).value

        if not user_selection or user_selection == "":
            print(f"‚ö†Ô∏è No {cacheName} in {spinner_name} selected")
            return

        # Confirm deletion
        if not js.window.confirm(f"Are you sure you want to delete '{user_selection}'?"):
            print("‚ùå Deletion cancelled")
            return

        # Create cache key
        cache_key = f"{cacheName}_{user_selection}"

        # Delete from localStorage
        js.localStorage.removeItem(cache_key)
        print(f"‚úÖ {cacheName} '{user_selection}' deleted")

        # Clear the GUI dropdown selection
        js.document.getElementById(spinner_name).value = ""

        # Clear the GUI fields
        if spinner_name == 'fic_spinner':
            js.document.getElementById('FIC_NAME').value = ''
            js.document.getElementById('FIC_FREQUENCY').value = ''
            js.document.getElementById('OVERHEAD').value = ''
            js.document.getElementById('SQUAWK').value = ''
        elif spinner_name == 'fic_spinner2':
            js.document.getElementById('FIC_NAME2').value = ''
            js.document.getElementById('FIC_FREQUENCY2').value = ''
            js.document.getElementById('OVERHEAD2').value = ''
            js.document.getElementById('SQUAWK2').value = ''
        elif spinner_name == 'aircraft_spinner':
            aircraft_clean(verbose='silent')

        if elementId2 is not None:
            js.document.getElementById(elementId2).value = ''

        # Update the spinner-dropdown list
        if spinner_name == 'fic_spinner' or spinner_name == 'fic_spinner2':
            update_dropdown('fic_spinner', cacheName='enroute', keepSelection=False)
            update_dropdown('fic_spinner2', cacheName='enroute', keepSelection=False)
        elif spinner_name == 'checklist_spinner':
            update_dropdown(spinner_name, cacheName=cacheName, keepSelection=False)
            # Set the default checklist
            checklist_clean(verbose='silent')
        else:
            update_dropdown(spinner_name, cacheName=cacheName, keepSelection=False)


    async def load_enroute_fic(spinner_name):
        """Load selected FIC from localStorage"""
        print(f'> func: load_enroute_fic({spinner_name})')

        # Get the user selection from the spinner element
        user_selection = js.document.getElementById(spinner_name).value

        if not user_selection or user_selection == "":
            print("   >‚ö†Ô∏è No Enroute FIC selected")
            return

        print(f"   >üìÇ Loading Enroute: {user_selection}")

        # Clear relevant fields based on spinner
        if spinner_name == 'fic_spinner':
            js.document.getElementById('FIC_NAME').value = ''
            js.document.getElementById('FIC_FREQUENCY').value = ''
            js.document.getElementById('OVERHEAD').value = ''
            js.document.getElementById('SQUAWK').value = ''
        elif spinner_name == 'fic_spinner2':
            js.document.getElementById('FIC_NAME2').value = ''
            js.document.getElementById('FIC_FREQUENCY2').value = ''
            js.document.getElementById('OVERHEAD2').value = ''
            js.document.getElementById('SQUAWK2').value = ''

        print(f"   >üìÇ Loading Enroute: {user_selection}")

        # Load from cache (localStorage)
        storage_key = f"ENROUTE_{user_selection}"
        json_data = js.localStorage.getItem(storage_key)

        if not json_data:
            print(f"   >‚ö†Ô∏è ENROUTE not found: {user_selection}")
            js.window.alert(f"‚ö†Ô∏è ENROUTE '{user_selection}' was not found.")
            return

        # Parse JSON
        try:
            enroute_dict = json.loads(json_data)
            print(f"   >‚úÖ Loaded ENROUTE: {len(enroute_dict)} fields for {spinner_name}")

            # Update the keys in enroute_dict in case of fic_spinner2
            if spinner_name == 'fic_spinner2':
                enroute_dict['FIC_NAME2'] = enroute_dict.pop('FIC_NAME', None)
                enroute_dict['FIC_FREQUENCY2'] = enroute_dict.pop('FIC_FREQUENCY', None)
                enroute_dict['OVERHEAD2'] = enroute_dict.pop('OVERHEAD', None)
                enroute_dict['SQUAWK2'] = enroute_dict.pop('SQUAWK', None)

            # Fill the flight_plan_data dictionary
            for key, value in enroute_dict.items():
                print(f"   >ENROUTE Key: {key}, Value: {value}")
                js.window.flight_plan_data[key] = value if value not in ('', None, 'None', 'nan') else ''

            # Update GUI FIELDS
            update_enroute_gui_fields(enroute_dict, spinner_name)
            # Update missing fields colors
            js.window.highlightMissingFields()


            print(f"   >‚úÖ Flightplan '{user_selection}' loaded successfully")
        except Exception as e:
            print(f"   >‚ö†Ô∏è Error loading flightplan: {e}")
            js.window.alert(f"‚ùó Error loading flight plan: {e}")


    async def load_flightplan():
        """Load flightplan from localStorage"""
        print(f"> func: load_flightplan()")

        plan_name = js.document.getElementById('plan_spinner').value

        if not plan_name or plan_name == "":
            print("‚ö†Ô∏è No flightplan selected")
            return

        # Remove flashcards
        js.window.flashcardClean('DEPARTURE')
        js.window.flashcardClean('ARRIVAL')

        # Remove METAR widget
        remove_metar_widget('DEPARTURE')
        remove_metar_widget('ARRIVAL')

        # remove wind envelope plot
        js.window.cleanWindEnvelopeFields('DEPARTURE', 'empty')
        js.window.cleanWindEnvelopeFields('ARRIVAL', 'empty')
        # Clean Weigth&Balance
        js.window.cleanWeightBalanceFields('DEPARTURE', 'empty');
        js.window.cleanWeightBalanceFields('ARRIVAL', 'empty');

        # Set default values for dropdown elements
        select = js.document.getElementById('DEPARTURE_ICAO_CITY')
        select.innerHTML = '<option value="">Select ICAO</option>'
        select = js.document.getElementById('ARRIVAL_ICAO_CITY')
        select.innerHTML = '<option value="">Select ICAO</option>'

        # Load from localStorage
        storage_key = f"FLIGHTPLAN_{plan_name}"
        json_data = js.localStorage.getItem(storage_key)

        if not json_data:
            print(f"   >‚ö†Ô∏è Flightplan not found: {plan_name}")
            js.window.alert(f"‚ö†Ô∏è Flightplan '{plan_name}' not found.")
            return

        # Parse JSON
        try:
            # Load json data file
            flight_plan_dict = json.loads(json_data)
            print(f"   >‚úÖ Loaded {len(flight_plan_dict)} fields")

            # Initialize empty waypoints array
            js.window.waypoints = []
            js.window.leginfo = {}
            js.window.RUNWAY = {}

            # Fill the flight_plan_data dictionary from the loaded JSON data
            for key, value in flight_plan_dict.items():
                js.window.flight_plan_data[key] = value

            # Update GUI FIELDS
            update_general_gui_fields(flight_plan_dict)
            update_aerodrome_gui_fields('DEPARTURE')
            update_aerodrome_gui_fields('ARRIVAL')

            # Update IMAGES
            await update_aerodrome_image('DEPARTURE')
            await update_aerodrome_image('ARRIVAL')

            # Clear Flag
            js.window.updateFlag('DEPARTURE', 'remove')
            js.window.updateFlag('ARRIVAL', 'remove')

            # Cleanly initialize new runway plot
            js.window.cleanRunwayFields('DEPARTURE', 'empty')
            js.window.cleanRunwayFields('ARRIVAL', 'empty')

            # Update VFR icon
            js.window.updateFlightCatagoryIcon('DEPARTURE', remove=True)
            js.window.updateFlightCatagoryIcon('ARRIVAL', remove=True)

            # Add data to javascript global cache. This is needed for the aerodrome selection and plotting on the map
            if flight_plan_dict['DEPARTURE_COUNTRY'] != '':
                await import_country_selected('DEPARTURE', flight_plan_dict['DEPARTURE_COUNTRY'], window.UNZIPK)
                # Update spinner
                element = js.document.getElementById('DEPARTURE_ICAO_CITY')
                element.value = flight_plan_dict['DEPARTURE_ICAO_CITY']

            if flight_plan_dict['ARRIVAL_COUNTRY'] != '':
                await import_country_selected('ARRIVAL', flight_plan_dict['ARRIVAL_COUNTRY'], window.UNZIPK)
                # Update spinner
                element = js.document.getElementById('ARRIVAL_ICAO_CITY')
                element.value = flight_plan_dict['ARRIVAL_ICAO_CITY']

            # Populate checklist
            checklist_populate()
            # Populate aircraft settings
            js.window.aircraft_populate_js(False)
            # Update METAR
            js.window.retrieve_metar('DEPARTURE', verbose='silent')
            js.window.retrieve_metar('ARRIVAL', verbose='silent')
            # Update weight and balance
            js.window.WeightBalanceMain('SETTINGS')
            js.window.WeightBalanceMain('DEPARTURE')
            js.window.WeightBalanceMain('ARRIVAL')
            # Compute Runway stats
            js.window.displayRunwayMain("DEPARTURE");
            js.window.displayRunwayMain("ARRIVAL");
            # Update flightinfo
            js.window.waypoints = to_js(window.flight_plan_data["WAYPOINTS"])
            js.window.leginfo = to_js(window.flight_plan_data["LEGINFO"])
            time_dep = js.document.getElementById('DEPARTURE_clockField').value
            js.window.UpdateFlightInfoFields(time_dep, True, True)

            print(f"   >‚úÖ Flightplan '{plan_name}' loaded successfully")
        except Exception as e:
            print(f"   >‚ùó Error loading flightplan: {e}")
            js.window.alert(f"‚ùó Error loading flight plan: {e}")


    def store_field(element_id=None):
        js.window.flight_plan_data[element_id] = js.document.getElementById(element_id).value

    def save_flightplan(to_cache=True, verbose=True):
        """Save current flightplan data to localStorage"""
        print(f"> func: save_flightplan()")

        # STORE FIELDS FROM GENERAL IN FLIGHTPLAN
        js.window.flight_plan_data["CALLSIGN_SHORT"] = js.window.create_callsign_short(js.document.getElementById('CALLSIGN').value);
        general_fields = ["FLIGHTPLAN", "POB", "FLIGHT_RULES", "AIRCRAFT_TYPE", "CALLSIGN"]
        for field in general_fields:
            store_field(field)

        # STORE FIELDS FROM ENROUTE IN FLIGHTPLAN
        enroute_fields = ["FIC_NAME", "FIC_FREQUENCY", "OVERHEAD", "SQUAWK", "FIC_NAME2", "FIC_FREQUENCY2", "OVERHEAD2", "SQUAWK2"]
        for field in enroute_fields:
            store_field(field)

        # STORE ROUTE AND POSITION FIELDS IN FLIGHTPLAN
        route_fields = ["DEPARTURE_ROUTE_NAME", "DEPARTURE_POSITION", "ARRIVAL_ROUTE_NAME", "ARRIVAL_POSITION"]
        for field in route_fields:
            store_field(field)

        # STORE WEIGHT AND BALANCE
        weight_fields = ["WEIGHT_FUEL_LITERS", "WEIGHT_PILOT", "WEIGHT_COPILOT", "WEIGHT_REAR_LEFT", "WEIGHT_REAR_RIGHT", "WEIGHT_BAGAGE"]
        fnames = ['DEPARTURE', 'ARRIVAL']
        for fname in fnames:
            for field in weight_fields:
                key = f"{fname}_{field}"
                store_field(key)

        # Set datetime creation
        js.window.flight_plan_data['DATETIME_CREATION'] = 'FLIGHT PLAN (' + str(datetime.now().strftime('%d-%m-%Y %H:%M')) + ')'
        js.document.getElementById('DATETIME_CREATION').textContent = js.window.flight_plan_data["DATETIME_CREATION"]

        # STORE WAYPOINTS
        js.window.flight_plan_data['WAYPOINTS'] = js.window.waypoints;
        js.window.flight_plan_data['LEGINFO'] = js.window.leginfo;

        # ALL OTHER FIELDS SHOULD BE STORE ALREADY IN THE FLIGHTPLAN DATA

        # GET FLIGHTPLAN NAME
        flightplan_name = js.window.flight_plan_data["FLIGHTPLAN"]

        # print('HERE')
        # print(js.window.flight_plan_data)

        if (flightplan_name is None or flightplan_name == ''):
            if verbose:
                js.window.alert("‚ÑπÔ∏è Please enter a flight plan name before saving.")
            return False

        # Print the saved variables array
        print("   > -------------SAVE FLIGHTPLAN DATA TO DICT-------------")
        print(f"  > Save: {flightplan_name}")

        # Convert flight_plan_data to JSON string
        flight_plan_dict = {}
        keys = get_default_data()
        for key in keys:
            try:
                value = js.window.flight_plan_data.get(key)
                # Convert JavaScript objects to Python objects
                if hasattr(value, 'to_py'):
                    value = value.to_py()
                flight_plan_dict[key] = value
            except Exception as e:
                print(f"   >‚ö†Ô∏è Failed to save {key}: {e}")

        # Print Data
        if verbose:
            for key, value in flight_plan_dict.items():
                if value != '' and value != None and value != {} and value != []:
                    print(f"     >{key}: '{value}'")

        # Save to cache
        if to_cache and flightplan_name and flightplan_name != "":
            print("   >-------------SAVE FLIGHTPLAN DATA TO CACHE-------------")

            # Convert to JSON string
            json_data = json.dumps(flight_plan_dict)

            # Save to localStorage with key "FLIGHTPLAN_"
            storage_key = f"FLIGHTPLAN_{flightplan_name}"
            js.localStorage.setItem(storage_key, json_data)

            # Get localStorage info
            # print_local_storage()

            # Update the list of saved flightplans
            update_dropdown('plan_spinner', 'FLIGHTPLAN', keepSelection=True, elementId2='FLIGHTPLAN')
            # Update the enroute list
            update_dropdown('fic_spinner', 'enroute', keepSelection=True)
            update_dropdown('fic_spinner2', 'enroute', keepSelection=True)

            print("   >---------------DATA SAVED-------------------")
            if verbose:
                js.window.alert("‚úÖ Flight plan saved successfully!");

            # Return
            return True


    async def load_aerodrome_from_json(fname, elementId=None, icao=None, verbose='info'):
        # Load aerodrome data for departure or arrival from localStorage.
        print(f'> func: load_aerodrome_from_json({fname})')

        # Get element ID for ICAO
        if elementId is None: elementId = f'{fname}_ICAO'
        element = js.document.getElementById(elementId)
        icaoName = element.value.strip().upper() or ''

        if icao is not None:
            #icaoName = extract_icao_from_string(icaoName)
            icaoName = re.search(r'\(([^)]+)\)', icao).group(1)

        # Get cached aerodrome data
        cache_key = fname + '_' + icaoName
        json_data = js.localStorage.getItem(cache_key)

        # Check whether the cached data for the other (departure or arrival) aerdrome exists
        if not json_data:
            fname_opposite = 'DEPARTURE' if fname == 'ARRIVAL' else 'ARRIVAL'
            json_data = js.localStorage.getItem(fname_opposite + '_' + icaoName)
            if json_data:
                # This is a hack where I need to replace the name of DEPARTURE into ARRIVAL or the otherway arround. The reason is that I want to re-use departure and arrival aerodromes for each other if none exists.
                json_data = json_data.replace(fname_opposite, fname)

        if json_data:
            # Use the user saved aerodrome data
            pass
        elif not json_data and js.window.flight_plan_data[f'{fname}_ICAO_CITY'] == '':
            # No saved aerodrome but also nothing selected
            # Clean all GUI fields
            message = f"‚ÑπÔ∏è Please select and save the {icaoName} aerodrome in the {fname.lower()} tab or add your custom aerodrome information and save it."
            print(message)
            # Add icon below ICAO on the GENERAL TAB
            js.document.getElementById(f'{fname}_CITY').textContent = f'‚ö†Ô∏è {fname}'
            # Remove flag
            js.window.updateFlag(fname, 'remove')

            # if verbose == 'info': js.window.alert(message)
            return False
        else:
            # Aerodrome ICAO is unknown. Return without clearning all fields.
            message = f"‚ÑπÔ∏è Please select and save the {icaoName} aerodrome in the {fname.lower()} tab or add your custom aerodrome information and save it."
            print(message)
            # if verbose == 'info': js.window.alert(message)
            # Add icon below ICAO on the GENERAL TAB
            js.document.getElementById(f'{fname}_CITY').textContent = f'‚ö†Ô∏è {fname}'

            # Get the original selected ICAO
            icaoSelected = js.document.getElementById(f'{fname}_ICAO_CITY')

            # Extract the string that is between parentheses in the alert message (e.g. the ICAO) and set it as the spinner value
            icao_value = extract_icao_from_string(icaoSelected.value)

            # Store previous value back elements and flight plan
            if icao_value != '':
                js.document.getElementById(f'{fname}_ICAO').value = icao_value

            # Update missing fields colors
            js.window.highlightMissingFields()
            js.window.highlightDropdownMenus()

            # Remove flag
            # js.window.updateFlag(fname, 'remove')

            # Return
            return False


        # Parse JSON
        fname_dict = json.loads(json_data)
        fname_dict[f'{fname}_RUNWAY_NR'] = ''

        print(f"   >‚úÖ Loaded {len(fname_dict)} fields")

        # Clear aerodrome fields but not the aircraft fields
        await clear_aerodrome_fields(fname, clearAircraftFields=False)

        # Overwrite the keys in the flight_plan_data dictionary from the loaded JSON data
        for key, value in fname_dict.items():
            # print(f"Key: {key}, Value: {value}")
            js.window.flight_plan_data[key] = value

        # Update GUI fields
        update_aerodrome_gui_fields(fname, updateAircraftFields=False)

        # Update aerodrome image
        await update_aerodrome_image(fname)

        # Update spinners
        if fname_dict[f'{fname}_COUNTRY'] != '':
            # Update the country and load into memory
            await import_country_selected(fname, fname_dict[f'{fname}_COUNTRY'], window.UNZIPK)
            # Get the ICAO CITY name
            element = js.document.getElementById(f'{fname}_ICAO_CITY')
            # Set the ICAO spinner
            element.value = fname_dict[f'{fname}_ICAO_CITY']

        # Remove METAR widget
        remove_metar_widget(fname)
        # Remove wind envelope
        js.window.cleanWindEnvelopeFields(fname, 'empty')
        # Clean Weigth&Balance
        js.window.cleanWeightBalanceFields(fname, 'empty');
        # Remove runway plot (initialize newly)
        js.window.cleanRunwayFields(fname, 'empty')

        # Retrieve METAR data during loading of the aerodrome
        await js.window.retrieve_metar(fname, verbose=verbose)

        # Initialize the waypoints when both Departure and arrival location are set.
        icao_dep = js.document.getElementById('DEPARTURE_ICAO')
        icao_arr = js.document.getElementById('ARRIVAL_ICAO')
        time_dep = js.document.getElementById('DEPARTURE_clockField')

        js.window.waypoints = to_js([])
        js.window.leginfo = to_js({})
        js.window.RUNWAY = to_js({})

        if icao_dep.value != '':
            js.window.addWaypoints([to_js(js.window.flight_plan_data['DEPARTURE_LATLON'])])
        if icao_arr.value != '':
            js.window.addWaypoints([to_js(js.window.flight_plan_data['ARRIVAL_LATLON'])])
        if icao_dep.value != '' and icao_arr.value != '':
            js.window.addWaypoints(to_js([js.window.flight_plan_data['DEPARTURE_LATLON'], js.window.flight_plan_data['ARRIVAL_LATLON']]))
            js.window.UpdateFlightInfoFields(time_dep.value, True, True)

        #js.window.alert('Here after loading or selecting icao from cache')
        # Update weight and balance
        js.window.WeightBalanceMain(fname)
        # Compute Runway stats
        js.window.displayRunwayMain(fname);
        # Update missing fields colors
        js.window.highlightMissingFields()
        js.window.highlightDropdownMenus()

        print(f"   >‚úÖ Aerodrome {icaoName} successfully loaded from cache: {fname.lower()}")
        return True

    def extract_icao_from_string(icao_string):
        if not icao_string:
            return ''

        match = re.search(r'\(([^)]+)\)', icao_string)
        return match.group(1) if match else ''

    def save_aerodrome_to_json(fname, verbose='info'):
        """Save custom aerodrome data (ICAO) to localStorage

        Saves data for either departure/arrival aerodrome data to browser's localStorage.
        For departure/arrival, saves relevant fields starting with that prefix.
        For enroute, saves specific enroute-related fields.
        All fields are saved but not all are loaded in load_aerodrome_from_json such as RUNWAY since they depend on weather conditions.

        Args:
            fname (str): Either 'DEPARTURE', 'ARRIVAL' to indicate what data to save

        The data is saved with a key format of:
        - For departure/arrival: [DEPARTURE|ARRIVAL]_[ICAO]

        Example:
            save_aerodrome_to_json('DEPARTURE')
            save_aerodrome_to_json('ARRIVAL')
        """
        print(f'> func: save_aerodrome_to_json({fname})')
        dict_fname = {}

        # Get flightplan data from dictionary
        flight_data = js.window.flight_plan_data

        # Store all fname_ except for the weights
        for key, item in flight_data.items():
            if key.startswith(fname) and not key.startswith(f"{fname}_WEIGHT"):
                dict_fname[key] = item

        # Collect all information from the GUI-fields and update the dictionary
        for key in dict_fname.keys():
            # Do not store RUNWAY keys because runways are determined by the weather conditions
            element = js.document.getElementById(key)
            if element and hasattr(element, 'value'):
                field_value = element.value
                if field_value and str(field_value) not in ('nan', 'None', ''):
                    dict_fname[key] = field_value

        # Create Cache key
        cache_key = fname + '_' + dict_fname[f"{fname}_ICAO"]
        print(f'   >CACHE KEY: {cache_key}')

        # Save to cache
        message = f"‚úÖ Custom {fname.lower()} field information for {flight_data.get(f'{fname}_ICAO', '')} is saved."
        print(f'   >{message}')
        if verbose=='info':
            window.alert(message)

        # Convert to JSON string
        json_data = json.dumps(dict_fname)
        # Save to cache
        js.localStorage.setItem(cache_key, json_data)


    def save_enroute_to_json(prefix):
        """Save custom enroute data to localStorage.

        Args:
            prefix (str): 'ENROUTE1', 'ENROUTE2'
        """
        print(f'> func: save_enroute_to_json({prefix})')

        # Create empty dict
        dict_enroute = {}

        # Store the FIC to localStorage
        if prefix == 'ENROUTE1':
            # Create cache key
            listname = js.document.getElementById('FIC_NAME').value
            cache_key = 'ENROUTE_' + listname.upper().strip()

            enroute_fields = {
                'FIC_NAME': js.document.getElementById('FIC_NAME').value,
                'FIC_FREQUENCY': js.document.getElementById('FIC_FREQUENCY').value,
                'OVERHEAD': js.document.getElementById('OVERHEAD').value,
                'SQUAWK': js.document.getElementById('SQUAWK').value,
            }
        elif prefix == 'ENROUTE2':
            # Create cache key
            listname = js.document.getElementById('FIC_NAME2').value
            cache_key = 'ENROUTE_' + listname.upper().strip()

            enroute_fields = {
                'FIC_NAME': js.document.getElementById('FIC_NAME2').value,
                'FIC_FREQUENCY': js.document.getElementById('FIC_FREQUENCY2').value,
                'OVERHEAD': js.document.getElementById('OVERHEAD2').value,
                'SQUAWK': js.document.getElementById('SQUAWK2').value
            }
        else:
            print(f'   >Invalid prefix: {prefix}')
            return

        if not listname or listname == '':
            return

        # Only store non-empty values
        for key, value in enroute_fields.items():
            if value and str(value) not in ('nan', 'None', ''):
                dict_enroute[key] = value
            else:
                dict_enroute[key] = ''

        # Save to cache
        print(f'   >{prefix} SAVED: {cache_key}')
        # Convert to JSON string
        json_data = json.dumps(dict_enroute)
        # Save to cache
        js.localStorage.setItem(cache_key, json_data)
        # Update the enroute list
        update_dropdown('fic_spinner', 'enroute', keepSelection=True, elementId2='FIC_NAME')
        update_dropdown('fic_spinner2', 'enroute', keepSelection=True, elementId2='FIC_NAME2')
        print(f"   >‚úÖ FIC data saved and dropdown updated")


    def print_local_storage():
        # Get localStorage info

        print(f"   >üíæ Saved to localStorage: {storage_key}")
        print(f"   Storage Type: Browser localStorage")
        print(f"   Storage Location: Browser's IndexedDB/localStorage database")
        print(f"   Key: {storage_key}")
        print(f"   Size: {len(json_data)} bytes")

        # Print browser-specific path hints
        print(f"   Browser localStorage is typically stored at:")
        if sys.platform == 'win32':
            print(f"   - Chrome: %LOCALAPPDATA%\\Google\\Chrome\\User Data\\Default\\Local Storage")
            print(f"   - Firefox: %APPDATA%\\Mozilla\\Firefox\\Profiles\\<profile>\\storage\\default")
            print(f"   - Edge: %LOCALAPPDATA%\\Microsoft\\Edge\\User Data\\Default\\Local Storage")
        elif sys.platform == 'darwin':
            print(f"   - Chrome: ~/Library/Application Support/Google/Chrome/Default/Local Storage")
            print(f"   - Firefox: ~/Library/Application Support/Firefox/Profiles/<profile>/storage/default")
            print(f"   - Safari: ~/Library/Safari/LocalStorage")
        else:
            print(f"   - Chrome: ~/.config/google-chrome/Default/Local Storage")
            print(f"   - Firefox: ~/.mozilla/firefox/<profile>/storage/default")


    # ================================================
    # ATC HELPERS
    # ================================================

    async def create_summary_atc(reverse_path=False):
        """Create ATC summary (placeholder function)"""
        print("Creating ATC summary...")
        # Generate HTML content
        html_content = await generate_summary_html(reverse_path=reverse_path)
        # Open in browser
        open_html(html_content)

    async def create_departure_atc(reverse_path=False):
        """Create ATC Departure (placeholder function)"""
        print("Creating Departure summary...")
        # Generate HTML content
        html_content = await generate_departure_html(reverse_path=reverse_path)
        # Open in browser
        open_html(html_content)

    async def create_arrival_atc(reverse_path=False):
        """Create ATC Arrival (placeholder function)"""
        print("Creating Arrival summary...")
        # Generate HTML content
        html_content = await generate_arrival_html(reverse_path=reverse_path)
        # Open in browser
        open_html(html_content)

    async def create_enroute_atc(reverse_path=False):
        """Create ATC Enroute (placeholder function)"""
        print("Creating Enroute summary...")
        # Generate HTML content
        html_content = await generate_enroute_html(reverse_path=reverse_path)
        # Open in browser
        open_html(html_content)


    async def generate_summary_html(reverse_path=False):
        """Generate HTML content for summary screen similar to ATC_SUMMARY."""
        flight_data = js.window.flight_plan_data

        try:
            # Set departure and arrival
            if reverse_path:
                DEPARTURE, ARRIVAL = 'ARRIVAL', 'DEPARTURE'
            else:
                DEPARTURE, ARRIVAL = 'DEPARTURE', 'ARRIVAL'

            # Prepare frequency and tower info
            ATC_FREQUENCIES = create_freq_list_combined([DEPARTURE, ARRIVAL])
            ATC_TOWER_FREQ_DEP, ATC_TOWER_NAME_DEP = get_ATC_TOWER(DEPARTURE)
            ATC_TOWER_FREQ_ARR, ATC_TOWER_NAME_ARR = get_ATC_TOWER(ARRIVAL)

            empty_field = '[ . . . . . . . . . ]'
            html_content = {
                'CALLSIGN': flight_data.get('CALLSIGN', '') or empty_field,
                'CALLSIGN_SHORT': flight_data.get('CALLSIGN_SHORT', '') or empty_field,
                'AIRCRAFT_TYPE': flight_data.get('AIRCRAFT_TYPE', '') or empty_field,
                'FLIGHT_RULES': flight_data.get('FLIGHT_RULES', '') or empty_field,
                'POB': flight_data.get('POB', '') or empty_field,

                'REQUEST_INFORMATION': '' if flight_data.get(f'{ARRIVAL}_CTR', False) else 'REQUEST AERODROME INFORMATION',
                'TEXT_INFORMATION_RECEIVED': TEXT_INFORMATION_RECEIVED() if flight_data.get(f'{ARRIVAL}_CTR', False) else '',
                'CTR_REGION_BOOL_DEPARTURE': 'true' if flight_data.get(f'{DEPARTURE}_CTR', False) else 'false',
                'CTR_REGION_BOOL_ARRIVAL': 'true' if flight_data.get(f'{ARRIVAL}_CTR', False) else 'false',

                'DEPARTURE_POSITION': flight_data.get(f'{DEPARTURE}_POSITION', '') or 'at the Apron',
                'DEPARTURE_RUNWAY_NR': flight_data.get(f'{DEPARTURE}_RUNWAY_NR', '') or empty_field,
                'DEPARTURE_NAME': flight_data.get(f'{DEPARTURE}_NAME', '') or empty_field,
                'DEPARTURE_ROUTE_NAME': flight_data.get(f'{DEPARTURE}_ROUTE_NAME', '') or empty_field,
                'DEPARTURE_ROUTE_ALTITUDE': flight_data.get(f'{DEPARTURE}_ROUTE_ALTITUDE', '') or empty_field,
                'DEPARTURE_ICAO': flight_data.get(f'{DEPARTURE}_ICAO', '') or empty_field,

                'FIC_NAME': flight_data.get('FIC_NAME', '') or empty_field,
                'FIC_FREQUENCY': flight_data.get('FIC_FREQUENCY', ''),
                'FIC_SQUAWK': flight_data.get('SQUAWK', ''),
                'OVERHEAD': flight_data.get('OVERHEAD', flight_data.get(f'{DEPARTURE}_ROUTE_NAME', '') or empty_field),
                'ATC_FREQUENCIES': ATC_FREQUENCIES,
                'ATC_ATIS_FREQ_DEP': flight_data.get(f'{DEPARTURE}_ATC_ATIS_FREQ', ''),
                'OVERHEAD2': flight_data.get('OVERHEAD2', ''),
                'FIC_SQUAWK2': flight_data.get('SQUAWK2', ''),

                'ATC_TOWER': ATC_TOWER_FREQ_DEP,
                'DELIVERY_OR_RADIO': ATC_TOWER_NAME_DEP if ATC_TOWER_NAME_DEP == 'RADIO' else 'DELIVERY',
                'ATC_GROUND': ATC_TOWER_FREQ_DEP if ATC_TOWER_NAME_DEP == 'RADIO' else flight_data.get(f'{DEPARTURE}_ATC_GROUND', ''),

                'ARRIVAL_ICAO': flight_data.get(f'{ARRIVAL}_ICAO', '') or empty_field,
                'ARRIVAL_ROUTE_ALTITUDE': flight_data.get(f'{ARRIVAL}_ROUTE_ALTITUDE', '') or empty_field,
                'ARRIVAL_NAME': flight_data.get(f'{ARRIVAL}_NAME', '') or empty_field,
                'ARRIVAL_ROUTE_NAME': flight_data.get(f'{ARRIVAL}_ROUTE_NAME', ''),
                'ATC_TOWER_ARR': ATC_TOWER_FREQ_ARR,
                'ATC_TOWER_NAME': ATC_TOWER_NAME_ARR,
                'ARRIVAL_RUNWAY_NR': flight_data.get(f'{ARRIVAL}_RUNWAY_NR', '') or empty_field,

                'GRID_COLUMNS': window.ATC_COLUMNS,
            }
            if reverse_path:
                html_content['FIC_NAME'] = flight_data.get('FIC_NAME2', '') or empty_field
                html_content['FIC_FREQUENCY'] = flight_data.get('FIC_FREQUENCY2', '')
                html_content['OVERHEAD'] = flight_data.get('OVERHEAD2', '')
                html_content['FIC_SQUAWK'] = flight_data.get('SQUAWK2', '')

            fontsizes = get_fontsizes(js.window.ATC_FONTSIZE)

            css_content = {
                'FONT_SIZE_TOWER': fontsizes.get('TOWER'),
                'FONT_SIZE_PILOT': fontsizes.get('PILOT'),
                'FONT_SIZE_TITLE': fontsizes.get('TITLE'),
                'FONT_SIZE_SUBTITLE': fontsizes.get('TITLE') - 2,
                'BACKGROUND_COLOR_TITLE': '#6b21a8',
            }
            html_string = await personalize_content(html_content, 'ATC_summary_template.html.j2')
            css_string = await personalize_content(css_content, 'style_template.css.j2')

            html_with_css = f"""
            <style>
            {css_string}
            </style>
            {html_string}
            """
            return html_with_css
        except Exception as e:
            return f"<p>Error generating Summary HTML: {str(e)}</p>"


    async def generate_departure_html(reverse_path=False):
        """Generate HTML content for departure screen similar to ATC_DEPARTURE. """
        flight_data = js.window.flight_plan_data

        try:
            # Set departure and arrival
            if reverse_path:
                DEPARTURE, ARRIVAL = 'ARRIVAL', 'DEPARTURE'
            else:
                DEPARTURE, ARRIVAL = 'DEPARTURE', 'ARRIVAL'

            # Create string of all Frequencies
            ATC_FREQUENCIES = create_freq_list_combined(DEPARTURE)
            ATC_TOWER_FREQ, ATC_TOWER_NAME = get_ATC_TOWER(DEPARTURE)

            # Prepare HTML content data
            empty_field = '[ . . . . . . . . . ]'
            html_content = {
                'CALLSIGN': flight_data.get('CALLSIGN', '') or empty_field,
                'CALLSIGN_SHORT': flight_data.get('CALLSIGN_SHORT', '') or empty_field,
                'AIRCRAFT_TYPE': flight_data.get('AIRCRAFT_TYPE', '') or empty_field,
                'FLIGHT_RULES': flight_data.get('FLIGHT_RULES', ''),
                'POB': flight_data.get('POB', '') or empty_field,

                'ARRIVAL_NAME': flight_data.get(f'{ARRIVAL}_NAME', '') or empty_field,
                'ARRIVAL_RUNWAY_NR': flight_data.get(f'{ARRIVAL}_RUNWAY_NR', '') or empty_field,
                'ARRIVAL_ROUTE_ALTITUDE': str(flight_data.get(f'{ARRIVAL}_ROUTE_ALTITUDE', '')) or empty_field,
                'ARRIVAL_ICAO': flight_data.get(f'{ARRIVAL}_ICAO', '') or empty_field,

                'CTR_REGION_BOOL': 'true' if flight_data.get(f'{DEPARTURE}_CTR', False) else 'false',
                'DEPARTURE_POSITION': flight_data.get(f'{DEPARTURE}_POSITION', '') or 'at the Apron',
                'DEPARTURE_RUNWAY_NR': flight_data.get(f'{DEPARTURE}_RUNWAY_NR', '') or empty_field,
                'DEPARTURE_NAME': flight_data.get(f'{DEPARTURE}_NAME', '') or empty_field,
                'DEPARTURE_ROUTE_NAME': flight_data.get(f'{DEPARTURE}_ROUTE_NAME', '') or empty_field,
                'DEPARTURE_ROUTE_ALTITUDE': flight_data.get(f'{DEPARTURE}_ROUTE_ALTITUDE', '') or empty_field,
                'DEPARTURE_CITY_ICAO': flight_data.get(f'{DEPARTURE}_NAME', '') or empty_field,
                'DEPARTURE_ICAO': flight_data.get(f'{DEPARTURE}_ICAO', '') or empty_field,

                'ATC_TOWER': ATC_TOWER_FREQ,
                'ATC_ATIS_FREQ_DEP': flight_data.get(f'{DEPARTURE}_ATC_ATIS_FREQ', ''),
                'DELIVERY_OR_RADIO': ATC_TOWER_NAME if ATC_TOWER_NAME == 'RADIO' else 'DELIVERY',
                'ATC_GROUND': ATC_TOWER_FREQ if ATC_TOWER_NAME == 'RADIO' else flight_data.get(f'{DEPARTURE}_ATC_GROUND', ''),
                'ATC_FREQUENCIES': ATC_FREQUENCIES,

                'GRID_COLUMNS': window.ATC_COLUMNS,
            }

            # Prepare CSS content
            fontsizes = get_fontsizes(js.window.ATC_FONTSIZE)
            css_content = {
                'FONT_SIZE_TOWER': fontsizes.get('TOWER'),
                'FONT_SIZE_PILOT': fontsizes.get('PILOT'),
                'FONT_SIZE_TITLE': fontsizes.get('TITLE'),
                'FONT_SIZE_SUBTITLE': fontsizes.get('TITLE') - 2,
                'BACKGROUND_COLOR_TITLE': '#4769b1',
            }

            html_string = await personalize_content(html_content, 'ATC_departure_template.html.j2')
            css_string = await personalize_content(css_content, 'style_template.css.j2')

            # Embed CSS in the HTML content
            html_with_css = f"""
            <style>
            {css_string}
            </style>
            {html_string}
            """

            return html_with_css

        except Exception as e:
            return f"<p>Error generating Deparature HTML: {str(e)}</p>"


    async def generate_arrival_html(reverse_path=False):
        """Generate HTML content for arrivak screen similar to ATC_ARRIVAL."""
        flight_data = js.window.flight_plan_data

        try:
            # Set departure and arrival
            if reverse_path:
                DEPARTURE, ARRIVAL = 'ARRIVAL', 'DEPARTURE'
            else:
                DEPARTURE, ARRIVAL = 'DEPARTURE', 'ARRIVAL'

            # Create string of all Frequencies
            ATC_FREQUENCIES = create_freq_list_combined(ARRIVAL)
            ATC_TOWER_FREQ, ATC_TOWER_NAME = get_ATC_TOWER(ARRIVAL)

            # Set the content to customize the html
            empty_field = '[ . . . . . . . . . ]'
            html_content = {
                'AIRCRAFT_TYPE': flight_data.get('AIRCRAFT_TYPE', '') or empty_field,
                'CALLSIGN': flight_data.get('CALLSIGN', '') or empty_field,
                'CALLSIGN_SHORT': flight_data.get('CALLSIGN_SHORT', '') or empty_field,
                'FLIGHT_RULES': flight_data.get('FLIGHT_RULES', '') or empty_field,
                'CIRCUIT_ALTITUDE': flight_data.get('CIRCUIT_ALTITUDE', '') or empty_field,
                'ARRIVAL_CITY_ICAO': flight_data.get(f'{ARRIVAL}_ICAO', '') or empty_field,
                'POB': flight_data.get('POB', '') or empty_field,

                'ARRIVAL_NAME': flight_data.get(f'{ARRIVAL}_NAME', '') or empty_field,
                'ARRIVAL_RUNWAY_NR': flight_data.get(f'{ARRIVAL}_RUNWAY_NR', '') or empty_field,
                'ARRIVAL_ROUTE_NAME': flight_data.get(f'{ARRIVAL}_ROUTE_NAME', '') or empty_field,
                'ARRIVAL_ROUTE_ALTITUDE': flight_data.get(f'{ARRIVAL}_ROUTE_ALTITUDE', '') or empty_field,

                'DEPARTURE_ICAO': flight_data.get(f'{DEPARTURE}_ICAO', '') or empty_field,
                'ARRIVAL_ICAO': flight_data.get(f'{ARRIVAL}_ICAO', '') or empty_field,

                'REQUEST_INFORMATION': '' if flight_data.get(f'{ARRIVAL}_CTR', False) else 'REQUEST AERODROME INFORMATION',
                'TEXT_INFORMATION_RECEIVED': TEXT_INFORMATION_RECEIVED() if flight_data.get(f'{ARRIVAL}_CTR', False) else '',

                'ATC_TOWER_NAME': ATC_TOWER_NAME,
                'ATC_TOWER': ATC_TOWER_FREQ,
                'ATC_FREQUENCIES': ATC_FREQUENCIES,
                'GRID_COLUMNS': window.ATC_COLUMNS,
            }

            # Prepare CSS content
            fontsizes = get_fontsizes(js.window.ATC_FONTSIZE)
            css_content = {
                'FONT_SIZE_TOWER': fontsizes.get('TOWER'),
                'FONT_SIZE_PILOT': fontsizes.get('PILOT'),
                'FONT_SIZE_TITLE': fontsizes.get('TITLE'),
                'FONT_SIZE_SUBTITLE': fontsizes.get('TITLE') - 2,
                'BACKGROUND_COLOR_TITLE': '#258f45',
            }

            # Personalize the html based on the departure and aircraft
            html_string = await personalize_content(html_content, 'ATC_arrival_template.html.j2')
            css_string = await personalize_content(css_content, 'style_template.css.j2')

            # Embed CSS in the HTML content
            html_with_css = f"""
            <style>
            {css_string}
            </style>
            {html_string}
            """

            return html_with_css

        except Exception as e:
            return f"<p>Error generating HTML: {str(e)}</p>"


    async def generate_enroute_html(reverse_path=False):
        """Generate HTML content for enroute screen similar to ATC_ENROUTE."""
        flight_data = js.window.flight_plan_data

        try:
            # Set departure and arrival
            if reverse_path:
                DEPARTURE, ARRIVAL = 'ARRIVAL', 'DEPARTURE'
            else:
                DEPARTURE, ARRIVAL = 'DEPARTURE', 'ARRIVAL'

            # Prepare HTML content data (adjust keys as needed)
            empty_field = '[ . . . . . . . . . ]'
            html_content = {
                'AIRCRAFT_TYPE': flight_data.get('AIRCRAFT_TYPE', '') or empty_field,
                'CALLSIGN': flight_data.get('CALLSIGN', '') or empty_field,
                'CALLSIGN_SHORT': flight_data.get('CALLSIGN_SHORT', '') or empty_field,

                'FIC_NAME': flight_data.get('FIC_NAME', '') or empty_field,
                'FIC_FREQUENCY': flight_data.get('FIC_FREQUENCY', ''),
                'FIC_SQUAWK': flight_data.get('SQUAWK', ''),
                'FIC_SQUAWK2': flight_data.get('SQUAWK2', ''),

                'OVERHEAD': flight_data.get('OVERHEAD', flight_data.get(f'{DEPARTURE}_ROUTE_NAME', '') or empty_field),
                'OVERHEAD2': flight_data.get('OVERHEAD2', '') or empty_field,
                'FLIGHT_RULES': flight_data.get('FLIGHT_RULES', ''),
                'POB': flight_data.get('POB', '') or empty_field,

                'DEPARTURE_ICAO': flight_data.get(f'{DEPARTURE}_ICAO', '') or empty_field,
                'DEPARTURE_NAME': flight_data.get(f'{DEPARTURE}_NAME', '') or empty_field,
                'DEPARTURE_ROUTE_ALTITUDE': flight_data.get(f'{DEPARTURE}_ROUTE_ALTITUDE', '') or empty_field,

                'ARRIVAL_ICAO': flight_data.get(f'{ARRIVAL}_ICAO', '') or empty_field,
                'ARRIVAL_NAME': flight_data.get(f'{ARRIVAL}_NAME', '') or empty_field,
                'ATC_FREQUENCIES': create_freq_list_combined([DEPARTURE, ARRIVAL]),
                'GRID_COLUMNS': window.ATC_COLUMNS,
            }

            if reverse_path:
                html_content['FIC_NAME'] = flight_data.get('FIC_NAME2', '') or empty_field
                html_content['FIC_FREQUENCY'] = flight_data.get('FIC_FREQUENCY2', '')
                html_content['OVERHEAD'] = flight_data.get('OVERHEAD2', '')
                html_content['FIC_SQUAWK'] = flight_data.get('SQUAWK2', '')

            fontsizes = get_fontsizes(js.window.ATC_FONTSIZE)
            css_content = {
                'FONT_SIZE_TOWER': fontsizes.get('TOWER'),
                'FONT_SIZE_PILOT': fontsizes.get('PILOT'),
                'FONT_SIZE_TITLE': fontsizes.get('TITLE'),
                'FONT_SIZE_SUBTITLE': fontsizes.get('TITLE') - 2,
                'BACKGROUND_COLOR_TITLE': '#ec7d15',
            }
            html_string = await personalize_content(html_content, 'ATC_enroute_template.html.j2')
            css_string = await personalize_content(css_content, 'style_template.css.j2')
            html_with_css = f"""
            <style>
            {css_string}
            </style>
            {html_string}
            """
            return html_with_css
        except Exception as e:
            return f"<p>Error generating HTML: {str(e)}</p>"


    def get_ATC_TOWER(fname):
        """Get ATC tower frequency and name for DEPARTURE or ARRIVAL from flight_plan_data."""
        data = js.window.flight_plan_data

        if fname=='DEPARTURE':
            ATC_TOWER_FREQ = data.get('DEPARTURE_ATC_TOWER', '')
            ATC_TOWER_FREQ = ATC_TOWER_FREQ if ATC_TOWER_FREQ not in (None, '') else '???.???'
            ATC_TOWER_NAME = 'TOWER' if data.get('DEPARTURE_CTR') else 'RADIO'
        elif fname=='ARRIVAL':
            ATC_TOWER_FREQ = data.get('ARRIVAL_ATC_TOWER', '')
            ATC_TOWER_FREQ = ATC_TOWER_FREQ if ATC_TOWER_FREQ not in (None, '') else '???.???'
            ATC_TOWER_NAME = 'TOWER' if data.get('ARRIVAL_CTR') else 'RADIO'

        return ATC_TOWER_FREQ, ATC_TOWER_NAME


    def get_fontsizes(ATC_FONTSIZE):
        # Change fontsize based on settings
        if 'small'==ATC_FONTSIZE.lower():
            fontsizes = {'TOWER': 12, 'PILOT': 14, 'TITLE': 14}
        elif 'medium'==ATC_FONTSIZE.lower():
            fontsizes = {'TOWER': 14, 'PILOT': 16, 'TITLE': 20}
        elif 'large'==ATC_FONTSIZE.lower():
            fontsizes = {'TOWER': 16, 'PILOT': 18, 'TITLE': 20}
        elif 'xl'==ATC_FONTSIZE.lower():
            fontsizes = {'TOWER': 18, 'PILOT': 20, 'TITLE': 22}
        elif 'xxl'==ATC_FONTSIZE.lower():
            fontsizes = {'TOWER': 20, 'PILOT': 22, 'TITLE': 24}

        return fontsizes

    async def load_template(template_source):
        """
        Load template from URL or local disk.
        Auto-detects based on http/https prefix.
        """

        template_name = os.path.basename(template_source)
        template_key = f"template_{template_name}"

        cached = js.localStorage.getItem(template_key)
        if cached:
            print("‚úÖ Loaded from cache")
            return cached

        try:
            # üåê URL
            if template_source.startswith(("http://", "https://")):
                response = await js.fetch(template_source)
                if not response.ok:
                    print(f"‚ùå Fetch failed: {response.status}")
                    return None
                content = await response.text()

            # üíæ Local file
            else:
                with open(template_source, "r", encoding="utf-8") as f:
                    content = f.read()

            js.localStorage.setItem(template_key, content)
            print(f"‚úÖ Template cached under key '{template_key}'")
            return content

        except Exception as e:
            print(f"‚ùå Error loading template: {e}")
            return None

    # async def load_template_from_url(template_name):
    #     """Fetch from URL, store in localStorage, and return text content."""
    #     template_key = f"template_{template_name}"

    #     base_url = js.window.URL_HTML_TEMPLATES
    #     url = os.path.join(base_url, template_name)

    #     # 1. Try cache
    #     cached = js.localStorage.getItem(template_key)
    #     if cached:
    #         print("‚úÖ Loaded from cache")
    #         return cached

    #     # 2. Fetch template using JS fetch
    #     print(f" Fetching from URL: {url}")

    #     try:
    #         response = await js.fetch(url)
    #         if response.ok:
    #             content = await response.text()  # get the text content
    #             js.localStorage.setItem(template_key, content)  # store content
    #             print(f"‚úÖ Template cached under key '{template_key}'")
    #             return content
    #         else:
    #             print(f"‚ùå Fetch failed: {response.status}")
    #             return None
    #     except Exception as e:
    #         print(f"‚ùå Error fetching template: {e}")
    #         return None


    async def personalize_content(content, template_name):
        # Load template
        # template_content = await load_template_from_url(template_name)
        load_template
        template_content = await load_template(template_name)

        # Use DictLoader to store template
        jinja_env = Environment(loader=DictLoader({template_name: template_content}))

        try:
            template = jinja_env.get_template(template_name)
            html_content = template.render(content)
            return html_content
        except Exception as e:
            return f"<p>Error generating HTML: {e}</p>"


    def open_html(html_content, pagename="_blank"):
        print('> func: open_html(html_content)')
        if html_content is None:
            return None

        # Inject viewport for mobile if not present
        if "<head>" in html_content and 'name="viewport"' not in html_content:
            html_content = html_content.replace(
                "<head>",
                '<head><meta name="viewport" content="width=device-width, initial-scale=1.0">'
            )
        elif "<head>" not in html_content:
            html_content = (
                '<meta name="viewport" content="width=device-width, initial-scale=1.0">'
                + html_content
            )

        # new_win = window.open("", "_blank")
        new_win = window.open("", pagename)
        if not new_win:
            # blocked
            window.alert("‚ö†Ô∏è Popup blocked. Please allow popups to view the ATC communication.")
            return
        new_win.document.write(html_content)
        new_win.document.close()

    def create_freq_list_combined(fname):
        """Create ATC frequency list for both DEPARTURE and ARRIVAL using flight_plan_data."""
        if isinstance(fname, str): fname = [fname]

        data = js.window.flight_plan_data
        html_string = ''

        def freq_block(freq, label, city):
            if freq:
                return f'''
                <div style="display: grid; grid-template-columns: 1.5fr 3.5fr;">
                    <p class="pilot_general"><strong>{freq}: </strong></p>
                    <p class="pilot_general">{city} {label}</p>
                </div>
                '''
            return ''

        # DEPARTURE frequencies
        if 'DEPARTURE' in fname:
            dep_city = data.get('DEPARTURE_NAME', '')
            html_string += freq_block(data.get('DEPARTURE_ATC_ATIS_FREQ', ''), 'ATIS', dep_city)
            html_string += freq_block(data.get('DEPARTURE_ATC_GROUND', ''), 'DELIVERY/GROUND', dep_city)
            html_string += freq_block(data.get('DEPARTURE_ATC_TOWER', ''), 'TOWER', dep_city)
            html_string += freq_block(data.get('DEPARTURE_ATC_APPROACH', ''), 'APPROACH', dep_city)
            html_string += freq_block(data.get('DEPARTURE_ATC_TELEPHONE', ''), 'TELEPHONE', dep_city)
            #html_string += freq_block(data.get('DELIVERY_OR_RADIO', ''), 'RADIO', dep_city)

        # Add a horizontal rule between departure and arrival
        if len(fname)>=2:
            html_string += '<hr>'

        # ARRIVAL frequencies
        if 'ARRIVAL' in fname:
            arr_city = data.get('ARRIVAL_NAME', '')
            html_string += freq_block(data.get('ARRIVAL_ATC_ATIS_FREQ', ''), 'ATIS', arr_city)
            html_string += freq_block(data.get('ARRIVAL_ATC_GROUND', ''), 'DELIVERY/GROUND', arr_city)
            html_string += freq_block(data.get('ARRIVAL_ATC_TOWER', ''), 'TOWER', arr_city)
            html_string += freq_block(data.get('ARRIVAL_ATC_APPROACH', ''), 'APPROACH', arr_city)
            html_string += freq_block(data.get('ARRIVAL_ATC_TELEPHONE', ''), 'TELEPHONE', arr_city)
            #html_string += freq_block(data.get('DELIVERY_OR_RADIO_ARR', ''), 'RADIO', arr_city)

        html_string += '<hr>'
        SQUAWK = f": {data.get('SQUAWK', '')}" if data.get('SQUAWK', '') else ''
        SQUAWK2 = f": {data.get('SQUAWK2', '')}" if data.get('SQUAWK2', '') else ''
        html_string += freq_block(data.get('FIC_FREQUENCY', '') , data.get('FIC_NAME', '') + SQUAWK, '')
        html_string += freq_block(data.get('FIC_FREQUENCY2', '') , data.get('FIC_NAME2', '') + SQUAWK2, '')

        return html_string

    # =================================================================
    # HELPERS FOR AIRSPACE PROCESSING
    # =================================================================

    def read_file_from_url(url, verbose=3):
        """Read a text file from a given URL and load it into memory."""
        if verbose>=3: print('>Function: read_file_from_url()')
        lines_in_file = []

        if url == '': return None

        try:
            # Get url
            response = requests.get(url)
            if response.status_code == 200 or response.status_code == 502:
                # Open content in memory
                zfs = zipfile.ZipFile(BytesIO(response.content))
                # Assuming there's only one text file in the zip archive
                with zfs.open(zfs.infolist()[0], mode='r') as file:
                    for line in file:
                        # Decode each line from bytes to string, strip whitespace
                        processed_line = line.decode('utf-8').strip()
                        # Process the line as needed (e.g., further parsing or validation)
                        lines_in_file.append(processed_line)

                    # Show succes message
                    logger.info(f'   > File read and processed successfully from URL.')
            else:
                lines_in_file = None
        except Exception as e:
            if verbose>=1: print(f'[Error]> Failed to read file from URL: {str(e)}')
            lines_in_file = None

        # Return
        return lines_in_file


    def import_airspaces(country):
        # URL
        url = f'{js.window.URL_AIRSPACES}{country}.zip'

        # Read airspace file from URL
        lines_in_file = read_file_from_url(url, verbose=3)

        # Return if nothing is available
        if lines_in_file is None:
            return {}

        airspaces = {}
        current_airspace = None
        counter = 0

        for line in lines_in_file:
            line = line.strip()

            if ('Start of airspace' in line) or len(line) < 3:
                # Skip each line until start of airsprace is found
                if counter == 0: counter = counter + 1
                # print(line)

            elif line.startswith('*'):
                # This is a new area so create new key
                # line ='* Danger Area/DANGER//O/C'
                counter += 1
                airspaces[counter] = {'area_type': '', 'area_type_general': '', 'AC': '', 'AN': '', 'AL': '', 'AH': '', 'DP': '', 'coordinates': None}
                airspaces[counter]['area_type'] = line.split(maxsplit=1)[1]
                line = line[1:].split('/', maxsplit=1)
                airspaces[counter]['area_type_general'] = line[0].strip()
            elif line.startswith('AC'):
                airspaces[counter]['type'] = line.split()[1]
            elif line.startswith('AN'):
                airspaces[counter]['name'] = line.split(maxsplit=1)[1]
            elif line.startswith('AL'):
                airspaces[counter]['altitude_lower'] = line.split()[1]
            elif line.startswith('AH'):
                airspaces[counter]['altitude_higher'] = line.split()[1]
            elif line.startswith('DP'):
                # Get the coordinates
                if airspaces[counter].get('coordinates') is None:
                    airspaces[counter]['coordinates'] = []
                lat_lon = line.split(maxsplit=1)[1:]
                lat_lon = extract_lat_lon(lat_lon)
                # Remove None values from latlon
                if lat_lon['latlon'] is not None:
                    lat_lon = [item for item in lat_lon['latlon'] if item is not None]
                    # Store
                    if len(lat_lon) > 0:
                        airspaces[counter]['coordinates'].append(lat_lon)

            elif line.startswith('V'):
                if not airspaces[counter].get('coordinates'):
                    airspaces[counter]['coordinates'] = []

                lat_lon = line.split('X=')[1:]
                lat_lon = extract_lat_lon(lat_lon)

                # Remove None values from latlon
                if lat_lon['latlon'] is not None:
                    lat_lon = [item for item in lat_lon['latlon'] if item is not None]
                    # Store
                    if len(lat_lon) > 0:
                        airspaces[counter]['coordinates'].append(lat_lon)

        # Only keep airspaces with coordinates
        airspaces = {key: value for key, value in airspaces.items() if value['coordinates'] is not None}

        # Sort airspaces by number of latlon coordinates
        # airspaces = dict(sorted(airspaces.items(), key=lambda x: len(x[1]['coordinates']), reverse=True))

        # Combine multiple airspace entries that contain the given keyword in their name
        # if country == 'Netherlands':
        #    airspaces = combine_airspace_by_keyword(airspaces, 'schiphol ctr')

        # Convert the dictionary to a JSON string
        # airspaces_json = json.dumps(airspaces, indent=4)
        return airspaces


    def combine_airspace_by_keyword(airspaces, keyword):
        """Combine multiple airspace entries that contain the given keyword in their name.

        Args:
            airspaces (dict): Dictionary of airspace data
            keyword (str): Keyword to search for in airspace names (case insensitive)

        Returns:
            dict: Updated airspaces dictionary with combined entries
        """
        matching_keys = []
        combined_coords = []

        # Find all keys containing the keyword
        for key, value in airspaces.items():
            if 'name' in value and keyword.lower() in value['name'].lower():
                matching_keys.append(key)
                if value.get('coordinates'):
                    combined_coords.extend(value['coordinates'])

        # If we found multiple matching entries, combine them
        if len(matching_keys) > 1:
            # Keep the first key and update its coordinates
            main_key = matching_keys[0]
            airspaces[main_key]['coordinates'] = combined_coords

            # Remove other matching entries
            for key in matching_keys[1:]:
                airspaces.pop(key, None)

            print(f"‚úÖ Combined {len(matching_keys)} entries containing '{keyword}' into single entry")

        return airspaces


    # Function to extract latitude and longitude from the string
    def extract_lat_lon(string, method=None):
        # string = "52¬∞ 28' 12.00\" N"
        # string = '52:11:08 N 005:12:30 E'
        # string = 'n52 18.84 / e4 48.18'
        # latlon = extract_lat_lon('52:11:08 N 005:12:30 E')
        # latlon = extract_lat_lon('n52 18.84 / e4 48.18')

        if method == 4:
            if len(string.split('/')) > 1:
                s = string.split('/')
                if 'n' in s[0].strip().lower() or 's' in s[0].strip().lower():
                    lat = s[0].strip().replace(' ', ':').replace('.', ':')
                    lat = lat[1:] + ' ' + lat[0].upper()
                if 'e' in s[1].strip().lower() or 'w' in s[1].strip().lower():
                    lon = s[1].strip().replace(' ', ':').replace('.', ':')
                    lon = lon[1:] + ' ' + lon[0].upper()
                string = lat + ' ' + lon


        coord = {'name': None, 'latlon': None}

        if string is None or string == '' or string == []:
            return coord

        if isinstance(string, list): string = string[0]

        # Pattern 1: Extract the desired part of the string
        pattern1 = r"\d+¬∞\d+'\d+\.\d+\"[NS]\s+\d+¬∞\d+'\d+\.\d+\"[EW]"
        matches1 = re.findall(pattern1, string)

        if matches1:
            # Extract name
            start_index = string.index(matches1[0])
            # end_index = string.rindex(matches1[-1]) + len(matches1[-1])
            coord['name'] = string[0:start_index].replace('\xa0', ' ').strip()
            latlon = matches1

            lat_decimal, lon_decimal = [], []
            for lat_lon in latlon:
                # Extract degrees, minutes, and seconds for latitude
                lat_parts = re.findall(r'\d+', lat_lon.split()[0])
                lat_deg = float(lat_parts[0])
                lat_min = float(lat_parts[1])
                lat_sec = float(lat_parts[2] + '.' + lat_parts[3])

                # Extract degrees, minutes, and seconds for longitude
                lon_parts = re.findall(r'\d+', lat_lon.split()[1])
                lon_deg = float(lon_parts[0])
                lon_min = float(lon_parts[1])
                lon_sec = float(lon_parts[2] + '.' + lon_parts[3])

                # Convert DMS to decimal degrees
                lat_dec = dms_to_decimal(lat_deg, lat_min, lat_sec)
                lon_dec = dms_to_decimal(lon_deg, lon_min, lon_sec)

                lat_decimal.append(lat_dec)
                lon_decimal.append(lon_dec)

            coord['latlon'] = np.c_[lat_decimal, lon_decimal]
            if coord['latlon'].shape[0] > 1 and coord['name']=='':
                coord['name']='unknown'

            # Return
            return coord

        # latlon Pattern 2
        pattern2 = r'(\d{6}[NS])\s+(\d{7}[EW])'
        matches2 = re.findall(pattern2, string)

        if matches2:
            lat_decimal, lon_decimal = [], []
            for lat, lon in matches2:
                lat_deg, lat_min, lat_sec = lat[:2], lat[2:4], lat[4:-1]
                lon_deg, lon_min, lon_sec = lon[:3], lon[3:5], lon[5:-1]
                lat_dec = dms_to_decimal(lat_deg, lat_min, lat_sec)
                lon_dec = dms_to_decimal(lon_deg, lon_min, lon_sec)

                if lat[-1] == 'S':
                    lat_dec *= -1
                if lon[-1] == 'W':
                    lon_dec *= -1

                lat_decimal.append(lat_dec)
                lon_decimal.append(lon_dec)

            start_index = string.index(matches2[0][0])
            coord['name'] = string[0:start_index].replace('\xa0', ' ').strip()
            coord['latlon'] = np.c_[lat_decimal, lon_decimal]
            if coord['latlon'].shape[0] > 1 and coord['name']=='':
                coord['name']='unknown'

            # Return
            return coord

        # latlon Pattern 3
        # string = "52¬∞ 28' 12.00\" N"
        pattern3 = r'(\d+)¬∞ (\d+)\' (\d+\.\d+)" ([NSEW])'
        matches3 = re.search(pattern3, string)

        if matches3:
            ldeg = float(matches3.group(1))
            lmin = float(matches3.group(2))
            lsec = float(matches3.group(3))

            # Convert DMS to decimal degrees
            ldec = dms_to_decimal(ldeg, lmin, lsec)

            if matches3.group(4) == 'S':
                ldec *= -1
            if matches3.group(4) == 'W':
                ldec *= -1

            coord = {'name': string, 'latlon': ldec}
            # Return
            return coord

        # latlon Pattern 4
        # '52:11:08 N 005:12:30 E'
        pattern = r'(\d+:\d+:\d+) ([NS]) (\d+:\d+:\d+) ([EW])'
        matches = re.search(pattern, string)
        if matches:
            # Conert latitude to decimals
            degrees, minutes, seconds = matches.group(1).split(':')
            lat_decimal = dms_to_decimal(degrees, minutes, seconds, matches.group(2))
            # Conert longitude to decimals
            degrees, minutes, seconds = matches.group(3).split(':')
            lon_decimal = dms_to_decimal(degrees, minutes, seconds, matches.group(4))
            # Create coordinates
            coord = {'name': matches.group(1) + ' ' + matches.group(2) + ' ' + matches.group(3) + ' ' + matches.group(4) , 'latlon':  [lat_decimal, lon_decimal]}
            # Return
            return coord


        # latlon Pattern 5
        # string = "5342N00629E002"
        # string = '5255N00454E001'
        pattern = r'(\d{2})(\d{2})([NS])(\d{3})(\d{2})([EW])\d{3}'
        # 51.44161977603219, 3.5849333938063817
        match = re.search(pattern, string)
        if match:
            # Extract degrees, minutes, and seconds for latitude and longitude
            lat_degrees = int(match.group(1))
            lat_minutes = int(match.group(2))
            lat_direction = match.group(3)
            # lat_decimal = lat_degrees + (lat_minutes/100)
            # if lat_direction == 'S': lat_decimal *= -1

            lon_degrees = int(match.group(4))
            lon_minutes = int(match.group(5))
            lon_direction = match.group(6)
            # lon_decimal = lon_degrees + (lon_minutes/100)
            # if lon_direction == 'W': lon_decimal *= -1

            # Convert degrees and minutes to decimal
            lat_decimal = dms_to_decimal(lat_degrees, lat_minutes, 0, direction=lat_direction)
            lon_decimal = dms_to_decimal(lon_degrees, lon_minutes, 0, direction=lon_direction)

            # Create dict.
            coord = {'name': match.group(1) + ' ' + match.group(2) + ' ' + match.group(4) + ' ' + match.group(5) , 'latlon': [lat_decimal, lon_decimal]}

            # Return
            return coord


    def dms_to_decimal(degrees, minutes, seconds, direction=None):
        dec = float(degrees) + (float(minutes) / 60) + (float(seconds) / 3600)
        if direction == 'S':
            dec *= -1
        if direction == 'W':
            dec *= -1
        return dec


    def clean_altitude(altitude):
        # print(altitude)
        altitude = str(altitude).upper().replace("`",'').strip()
        altitude = altitude.split('/')[-1]

        if altitude is None or altitude=='' or altitude == 'NONE':
            pass
        elif 'AFL' in altitude:
            # likely stands for "500 feet Above Field Level.
            altitude = altitude.replace('AFL','')
        elif 'ALT' in altitude:
            altitude = altitude.replace('ALT','')
        elif 'AGL' in altitude:
            altitude = altitude.replace('AGL','')
        elif 'MSL' in altitude:
            altitude = altitude.replace('MSL','')
        elif 'UNL' in altitude:
            # unlimited, to the sky
            altitude = None
        elif 'SFC' in altitude:
            # surface is from the floor
            altitude = None
        elif 'FT' in altitude:
            altitude = altitude.replace('FT','')
        elif altitude[0:2] == 'FL':
            altitude = altitude.replace('FL','')
            if altitude == '': altitude = 0
            altitude = int(altitude) * 100
        elif 'FO' in altitude:
            altitude = altitude.replace('FO','')
            if altitude == '': altitude = 0
            altitude = int(altitude) * 100
        elif altitude[-1] == 'M':
            altitude = int(altitude[:-1]) * 3.28084
        elif altitude[-1] == 'A':
            # above ground level, it means an altitude of 500 feet above the terrain or surface beneath the aircraft.
            altitude = int(altitude[:-1])
        elif altitude[-1] == 'F':
            altitude = altitude.replace('F','')

        if altitude == '' or altitude is None or altitude == 'NONE':
            altitude = None
        else:
            altitude = int(altitude)

        return altitude


    def altitude_restriction(AL, AH, max_altitude):
        # If the altitude is 0. Always return True
        if max_altitude == 0:
            return True, None

        in_airspace = False
        loc_airspace = ''

        # Set the altitude
        if AH is None and AL is None:
            # print("Both upper and lower limits of the airspace are not defined.")
            loc_airspace = None

        if AH is not None and AL is not None:
            if AL <= max_altitude <= AH:
                in_airspace = True
                loc_airspace = 'in'
            elif max_altitude < AL:
                loc_airspace = 'below'
            elif max_altitude > AH:
                loc_airspace = 'above'
        elif AH is None and AL is not None:
            if max_altitude >= AL:
                loc_airspace = 'in'
                in_airspace = True
            else:
                loc_airspace = 'below'
        elif AH is not None and AL is None:
            if max_altitude <= AH:
                loc_airspace = 'in'
                in_airspace = True
            else:
                loc_airspace = 'above'

        # if loc_airspace == 'in':
        #     print('Flight is in airspace')
        return in_airspace, loc_airspace



    # =================================================================
    # PYTHON TO JAVASCRIPT PORTAL
    # =================================================================

    js.window.create_new_flightplan = create_new_flightplan
    js.window.load_flightplan = load_flightplan
    js.window.delete_flightplan = delete_flightplan
    js.window.save_flightplan = save_flightplan

    js.window.load_enroute_fic = load_enroute_fic
    js.window.delete_item_from_spinner = delete_item_from_spinner
    js.window.save_enroute_to_json = save_enroute_to_json

    js.window.save_aerodrome_to_json = save_aerodrome_to_json
    js.window.load_aerodrome_from_json = load_aerodrome_from_json

    js.window.clear_cache = clear_cache
    js.window.get_top_metar_stations = get_top_metar_stations
    js.window.update_dropdown = update_dropdown

    # CHECKLIST
    js.window.checklist_clean = checklist_clean
    js.window.check_items_complete = check_items_complete
    js.window.checklist_print = checklist_print
    js.window.checklist_populate = checklist_populate
    js.window.get_default_checklist = get_default_checklist
    js.window.checklist_update_catagories = checklist_update_catagories

    # AIRCRAFT
    js.window.aircraft_clean = aircraft_clean
    js.window.get_default_aircraft = get_default_aircraft
    js.window.save_to_json = save_to_json
    js.window.aircraft_matching_pairs = aircraft_matching_pairs

    # GENERAL
    js.window.load_spinner_selection = load_spinner_selection
    js.window.extract_icao_from_string = extract_icao_from_string

    # FLAG
    # js.window.retrieve_flag = retrieve_flag
    # js.window.updateFlag = updateFlag;

    # ATC
    js.window.create_summary_atc = create_proxy(create_summary_atc)
    js.window.create_departure_atc = create_proxy(create_departure_atc)
    js.window.create_arrival_atc = create_proxy(create_arrival_atc)
    js.window.create_enroute_atc = create_proxy(create_enroute_atc)

    # HELPERS
    js.window.create_callsign_short = create_proxy(create_callsign_short)
    js.window.import_country_selected = create_proxy(import_country_selected)
    js.window.generate_summary_html = create_proxy(generate_summary_html)
    js.window.get_fontsizes = create_proxy(get_fontsizes)

    # GENERAL TAB
    js.window.clear_general_fields = clear_general_fields

    # DEPARTURE/ARRIVAL TAB
    js.window.populate_aerodrome_fields_from_icao = create_proxy(populate_aerodrome_fields_from_icao)
    js.window.update_aerodrome_gui_fields = update_aerodrome_gui_fields
    js.window.update_general_gui_fields = update_general_gui_fields
    js.window.update_enroute_gui_fields = update_enroute_gui_fields
    js.window.update_aerodrome_image = update_aerodrome_image

    # CLEAR FIELDS
    js.window.clear_aerodrome_fields = clear_aerodrome_fields
    js.window.clear_enroute_fields = clear_enroute_fields
    js.window.cache_and_display_image = cache_and_display_image

    # DATA FUNCTIONS
    js.window.get_default_data = get_default_data

    # AIRSPACE
    js.window.import_airspaces = import_airspaces
    js.window.altitude_restriction = altitude_restriction
    js.window.clean_altitude = clean_altitude
    js.window.altitude_restriction = altitude_restriction

    # METAR HELPERS
    js.window.predict_runway_number = predict_runway_number
    js.window.compute_wind_envelope = compute_wind_envelope
    js.window.get_top_metar_stations = get_top_metar_stations

  </script>


  <!-- Vanilla JS for tabs and flightplan buttons -->
  <script>
    const tabButtons = document.querySelectorAll(".tablinks");
    const tabContents = document.querySelectorAll(".tabcontent");

    // Function to replace INFORMATION with INFO in input fields
    function updateEnrouteFields() {
        document.querySelectorAll('.REPLACE_INFO').forEach(input => {
            if (input.value) {
                input.value = input.value.toUpperCase().replace(/INFORMATION/g, 'INFO');
            }
        });
    }

    tabButtons.forEach(btn => {
      btn.addEventListener("click", async () => {
        // This listeren is tab switch/ swith tabs
        // Get the tab we're switching TO
        const targetTab = btn.getAttribute("data-tab").toUpperCase();
        // Get the CURRENT active tab (before switching)
        const elementActiveTab = document.querySelector(".tablinks.active");
        const currentTab = elementActiveTab ? elementActiveTab.getAttribute("data-tab").toUpperCase() : null;

        console.log(`>Tab switch from: ${currentTab}, to ${targetTab}`)

        // SAVE ON TAB CHANGE SWITCHING TO ATC. THIS IS NEEDED BECAUSE THE DATA IS GATHERED FROM FLIGHTPLAN DICT.
        if (pyscriptReady) {
            window.save_flightplan(true, false);
        }

        // Calculate Weight and Balance and Departure tab
        if (targetTab === 'DEPARTURE') {
          // Sync checkboxes and fields on startup
           syncWeightCheckboxesAndFields(`ARRIVAL_WEIGHT_CHECKBOX`);
           // window.WeightBalanceMain(targetTab);
        }
        // Calculate Weight and Balance and Departure tab
        if (targetTab === 'ARRIVAL') {
          // Sync checkboxes and fields on startup
           syncWeightCheckboxesAndFields(`DEPARTURE_WEIGHT_CHECKBOX`);
           // window.WeightBalanceMain(targetTab);
        }

        // WHEN THE TAB MAP IS CLICKED, UPDATE THE MAP WITH THE ROUTE AND FILL WINDOW.WAYPOINTS
        if (targetTab === "MAP") {
          initRouteMap(true);
          updateRoute(true); // Add all waypoints
        }
        //  CHECKLIST TAB: UPDATE CHECKLISTS
        if (targetTab === "CHECKLIST") {
          checklist_populate()
        }

        // REPLACE INFORMATION with "INFO" in the ENROUTE TAB.
        updateEnrouteFields();
        // CHECK MISSING FIELDS AFTER TAB SWITCH AND HIGHLIGHT
        highlightMissingFields();
        highlightDropdownMenus();

        // // Stop animation when leaving Departure tab
        // if (currentTab !== targetTab && currentTab === 'Departure'){
        //   window.animations('DEPARTURE', 'stop');
        // }
        // // Stop animation when leaving Arrival tab
        // if (currentTab !== targetTab && currentTab === 'Arrival'){
        //   window.animations('ARRIVAL', 'stop');
        // }
        // // Stop animation when leaving General tab
        // if (currentTab !== targetTab && currentTab === 'General'){
        //   animateCloud('SKYWALK_LOGO', process = "stop");
        //   animateSnow('SKYWALK_LOGO', process ='stop');
        // }

        // Switch tabs
        tabButtons.forEach(b => b.classList.remove("active"));
        tabContents.forEach(c => c.style.display = "none");
        btn.classList.add("active");
        document.getElementById(btn.getAttribute("data-tab")).style.display = "block";

      });
    });

    // Flightplan elements
    const CALLSIGN = document.getElementById('CALLSIGN');
    const AIRCRAFT_TYPE = document.getElementById('AIRCRAFT_TYPE');
    const POB = document.getElementById('POB');
    const FLIGHTPLAN = document.getElementById('FLIGHTPLAN');
    const FLIGHT_RULES = document.getElementById('FLIGHT_RULES');
    const DATETIME_CREATION = document.getElementById('DATETIME_CREATION');

    // Create buttons at the START page
    const new_plan_btn = document.getElementById('new_plan_btn');
    const delete_btn = document.getElementById('delete_btn');
    const fic_delete_btn = document.getElementById('fic_delete_btn');
    const fic_save_btn = document.getElementById('fic_save_btn');
    const fic_save_btn2 = document.getElementById('fic_save_btn2');

    // Create buttons to generate ATC at the ATC page
    const BTN_HTML_SUMMARY = document.getElementById('BTN_HTML_SUMMARY');
    const BTN_HTML_SUMMARY_REV = document.getElementById('BTN_HTML_SUMMARY_REV');
    const BTN_HTML_DEPARTURE = document.getElementById('BTN_HTML_DEPARTURE');
    const BTN_HTML_DEPARTURE_REV = document.getElementById('BTN_HTML_DEPARTURE_REV');
    const BTN_HTML_ARRIVAL = document.getElementById('BTN_HTML_ARRIVAL');
    const BTN_HTML_ARRIVAL_REV = document.getElementById('BTN_HTML_ARRIVAL_REV');
    const BTN_HTML_ENROUTE = document.getElementById('BTN_HTML_ENROUTE');
    const BTN_HTML_ENROUTE_REV = document.getElementById('BTN_HTML_ENROUTE_REV');

    // Missing labels
    const missing_label = document.getElementById('missing_label');

    // Uppercase for all fields with class="UPPERCASE_input"
    document.querySelectorAll('.UPPERCASE_input').forEach(input => {
    input.addEventListener('input', () => {
        input.value = input.value.toUpperCase();
        });
    });

    document.querySelectorAll('.REPLACE_INFO').forEach(input => {
        input.addEventListener('input', () => {
            input.value = input.value.toUpperCase().replace(/INFORMATION/g, 'INFO');
            highlightMissingFields();
        });
    });


    // Initial calls to handle any existing values
    updateEnrouteFields();
    highlightMissingFields();

    // Wait for PyScript to be ready
    let pyscriptReady = false;

    function restoreSettingsFromCache() {
      /**
       * Restores user interface settings from browser localStorage if they exist
       * and updates font sizes accordingly.
       *
       * Specifically:
       * - Restores atc_fontsize setting from localStorage
       * - Restores ATC_COLUMNS setting from localStorage
       * - Updates corresponding UI elements with restored values
       * - Updates font sizes based on restored settings
       *
       * If settings don't exist in localStorage, default values will be used.
       * Any errors during restoration are caught and logged to console.
       */
        try {
            // Restore settings from localStorage if they exist
            const savedUsageType = localStorage.getItem('ATC_FONTSIZE');
            const savedColumns = localStorage.getItem('ATC_COLUMNS');

            if (savedUsageType) {
                window.ATC_FONTSIZE = savedUsageType;
                const usageTypeElement = document.getElementById('ATC_FONTSIZE');
                if (usageTypeElement) {
                    usageTypeElement.value = savedUsageType;
                }
            }
            if (savedColumns) {
                window.ATC_COLUMNS = savedColumns;
                const columnsElement = document.getElementById('ATC_COLUMNS');
                if (columnsElement) {
                    columnsElement.value = savedColumns;
                }
            }

            console.log("   >Custom User settings are restored from cache.");

        } catch (error) {
            console.error('Error restoring settings:', error);
        }
    }

    // INITIALIZATION WHEN PYSCRIPT IS READY
    function checkPyScriptReady() {
      /**
       * Checks if PyScript is finished loading by testing if key functions are available.
       * Also initializes default flight plan data and settings if PyScript is ready.
       *
       * Key initializations:
       * - Sets window.flight_plan_data with default values
       * - Restores cached display settings
       * - Hides loading spinner once complete
       *
       * Keywords: Startup, loading, app start, start app, load app, startup app, bootup
       */
      if (typeof window.create_new_flightplan === 'function') {
        pyscriptReady = true;
        console.log("> func: checkPyScriptReady()");
        console.log("   >Default data is initialized.");

        // global dictionaries
        window.METAR_DEPARTURE = '';
        window.METAR_ARRIVAL = '';
        window.waypoints = [];
        window.leginfo = {};
        window.RUNWAY = {};

        // Get default flight plan data
        window.flight_plan_data = window.get_default_data();

        // Restore settings from cache
        restoreSettingsFromCache();

        // Populate the plan_spinner with FLIGHTPLAN_ keys on startup
        update_dropdown('plan_spinner', 'FLIGHTPLAN', keepSelection=false);
        update_dropdown('fic_spinner', cacheName='enroute', keepSelection=false);
        update_dropdown('fic_spinner2', cacheName='enroute', keepSelection=false);
        update_dropdown('checklist_spinner', 'CHECKLIST', keepSelection=false, elementId2='checklist_field');
        update_dropdown('aircraft_spinner', 'AIRCRAFT', keepSelection=false, elementId2='aircraft_field');
        // Set clock to default
        document.getElementById('DEPARTURE_clockField').value = '00:00'
        document.getElementById('ARRIVAL_clockField').value = '00:00'

        // Clear the Flags
        updateFlag('DEPARTURE', 'remove');
        updateFlag('ARRIVAL', 'remove');
        // Clear the VFR icon
        updateFlightCatagoryIcon('DEPARTURE', true);
        updateFlightCatagoryIcon('ARRIVAL', true);
        // Remove the wind envelope plot
        cleanWindEnvelopeFields('DEPARTURE', 'empty');
        cleanWindEnvelopeFields('ARRIVAL', 'empty');
        // Clean Weigth&Balance
        cleanWeightBalanceFields('DEPARTURE', 'empty');
        cleanWeightBalanceFields('ARRIVAL', 'empty');
        // Clean runway plot
        cleanRunwayFields('DEPARTURE', 'empty')
        cleanRunwayFields('ARRIVAL', 'empty')
        // Clean flashcards
        flashcardClean('DEPARTURE')
        flashcardClean('ARRIVAL')

        // Run the animation for the skywalk logo
        animateCloud('SKYWALK_LOGO', process = "start", density=8, speed=0.3, direction='right', color='dark');
        // animateRain('SKYWALK_LOGO', process = "start", intensity = "light");
        // animateSnow('SKYWALK_LOGO', process ='start', intensity = "medium", speed = 0.3);
        // animateFog('SKYWALK_LOGO', process = "start", intensity = "light");
        // animateFlare('SKYWALK_LOGO', "start", null, null, null, intensity=2, pulseSpeed = 0.2, size = 1.1);
        // animateDark('SKYWALK_LOGO', "start", "center", "night");

        // Populate checklist catagories
        populateChecklistCatagories()
        // Create lookup tables for countries
        CreateLookupTableCountries();
        // Populate the multipdropbox in the config screen
        populateAvailableCountries()
        // Load from previously stored countries from cache
        const uniqueCountries = LoadCountriesOfInterest();
        // Set the multibox items
        moveCountries('available-countries', 'selected-countries', 'initialize', uniqueCountries)

        // Hide loading spinner once everything is ready
        // document.getElementById('loading-spinner').style.display = 'none';
        // All env. variables are initialized
        console.log("   >Environmental variables are initialized.");

      }
    }

    // Check periodically for PyScript
    const checkInterval = setInterval(() => {
      checkPyScriptReady();
      if (pyscriptReady) {
        clearInterval(checkInterval);
      }
    }, 100);

    // Connect PyScript functions to button clicks
    new_plan_btn.onclick = async () => {
      try {
        // Check if PyScript is ready
        if (!pyscriptReady) return alert("‚ö†Ô∏è Please wait, SkyWalk is initializing...");

        // Uncheck the airspace toggle
        const airspaceToggle = document.getElementById('airspace-toggle');
        if (airspaceToggle) {
          airspaceToggle.checked = false;
          // Trigger the change event to ensure the map updates
          airspaceToggle.dispatchEvent(new Event('change'));
        }
        // Ask user for confirmation before clearing
        if (!confirm("Are you sure you want to clear and create a new flight plan? This will erase all current data.")) {
          return;
        }
        // Create new flightplan
        await window.create_new_flightplan();
        // Set datetime
        DATETIME_CREATION.textContent = window.flight_plan_data['DATETIME_CREATION'];
        // Store default flight plan data
        window.flight_plan_data = await window.get_default_data();
        // Clear plan spinner selection
        document.getElementById('plan_spinner').value = "";
        document.getElementById('fic_spinner').value = "";
        document.getElementById('fic_spinner2').value = "";
        // Update missing fields
        highlightMissingFields();
        highlightDropdownMenus(); // doet niks?

        // Show success message to user
        alert("‚úÖ All fields have been cleared and reset to their default values!");

      } catch (error) {
        console.error("‚ö†Ô∏è Error creating new flightplan:", error);
        alert("‚ö†Ô∏è An error occurred while creating the flight plan. Please try again.");
      }
    };

    // Auto-load functionality moved to plan_spinner onChange event
    document.getElementById('plan_spinner').addEventListener('change', async (e) => {
      if (e.target.value && pyscriptReady && window.load_flightplan) {
        try {
          await window.load_flightplan();
          console.log("‚úÖ Flightplan loaded successfully");
          // Update missing fields after loading
          highlightMissingFields();
        } catch (error) {
          console.error("‚ö†Ô∏è Error loading flightplan:", error);
          alert("‚ö†Ô∏è Error loading flight plan: " + error);
        }
      }
    });

    delete_btn.onclick = async () => {
      if (pyscriptReady && window.delete_flightplan) {
        await window.delete_flightplan();
      }
    };

    document.getElementById('fic_delete_btn')?.addEventListener('click', async () => {
      if (pyscriptReady && window.delete_item_from_spinner) {
        await window.delete_item_from_spinner('fic_spinner', 'ENROUTE');
      }
    });

    document.getElementById('fic_delete_btn2')?.addEventListener('click', async () => {
      if (pyscriptReady && window.delete_item_from_spinner) {
        await window.delete_item_from_spinner('fic_spinner2', 'ENROUTE');
      }
    });

    // Add save button functionality
    document.getElementById('fic_save_btn')?.addEventListener('click', () => {
      try {
          // Save FIC data to JSON files
          window.save_enroute_to_json('ENROUTE1');
          window.alert("‚úÖ Flight Information Center (FIC) data saved successfully!");
      } catch (error) {
        console.error("‚ö†Ô∏è Error saving Flight Information Center (FIC) data:", error);
      }
    });

    // Add save button functionality
    document.getElementById('fic_save_btn2')?.addEventListener('click', () => {
        try {
            // Save FIC data to JSON files
            window.save_enroute_to_json('ENROUTE2');
            window.alert("‚úÖ Flight Information Center (FIC) data saved successfully!");
        } catch (error) {
          console.error("‚ö†Ô∏è Error saving Flight Information Center (FIC) data:", error);
        }
    });

    document.getElementById('BTN_HTML_SUMMARY')?.addEventListener('click', () => {
      if (window.create_summary_atc) {
        window.create_summary_atc();
      }
    });
    document.getElementById('BTN_HTML_SUMMARY_REV')?.addEventListener('click', () => {
      if (window.create_summary_atc) {
        window.create_summary_atc({ reverse_path: true, verbose: false });
      }
    });

    document.getElementById('BTN_HTML_DEPARTURE')?.addEventListener('click', () => {
      if (window.create_departure_atc) {
        window.create_departure_atc();
      }
    });
    document.getElementById('BTN_HTML_DEPARTURE_REV')?.addEventListener('click', () => {
      if (window.create_departure_atc) {
        window.create_departure_atc({ reverse_path: true });
      }
    });

    document.getElementById('BTN_HTML_ARRIVAL')?.addEventListener('click', () => {
      if (window.create_arrival_atc) {
        window.create_arrival_atc();
      }
    });
    document.getElementById('BTN_HTML_ARRIVAL_REV')?.addEventListener('click', () => {
      if (window.create_arrival_atc) {
        window.create_arrival_atc({ reverse_path: true });
      }
    });

    document.getElementById('BTN_HTML_ENROUTE')?.addEventListener('click', () => {
      if (window.create_enroute_atc) {
        window.create_enroute_atc();
      }
    });

    document.getElementById('BTN_HTML_EN_REV')?.addEventListener('click', () => {
      if (window.create_enroute_atc) {
        window.create_enroute_atc({ reverse_path: true });
      }
    });

    ['DEPARTURE_WEIGHT_CHECKBOX', 'ARRIVAL_WEIGHT_CHECKBOX'].forEach(btnId => {
      const element = document.getElementById(btnId);
      if (!element) return;
      element.addEventListener('click', field => {
        const id = field?.currentTarget?.id ?? btnId;
        const prefix = id.startsWith('DEPARTURE') ? 'DEPARTURE' : 'ARRIVAL';
        // Pass the triggering checkbox id to the sync function
        syncWeightCheckboxesAndFields(id);
        // Update weight and balance plot
        WeightBalanceMain(prefix);
      });
    });


    ['DEPARTURE_ANIMATION_START', 'ARRIVAL_ANIMATION_START'].forEach(btnId => {
      const el = document.getElementById(btnId);
      if (!el) return;
      el.addEventListener('click', e => {
        // Prefer the event's currentTarget id (safe even if a child element was clicked)
        const id = e?.currentTarget?.id ?? btnId;
        const prefix = id.startsWith('DEPARTURE') ? 'DEPARTURE' : 'ARRIVAL';
        // Start animations
        animations(prefix, "start");
        // createCloudPlot(prefix, "show", true);
      });
    });

    ['DEPARTURE_ANIMATION_STOP', 'ARRIVAL_ANIMATION_STOP'].forEach(btnId => {
      const el = document.getElementById(btnId);
      if (!el) return;
      el.addEventListener('click', e => {
        // Prefer the event's currentTarget id (safe even if a child element was clicked)
        const id = e?.currentTarget?.id ?? btnId;
        const prefix = id.startsWith('DEPARTURE') ? 'DEPARTURE' : 'ARRIVAL';
        // Stop animations
        animations(prefix, "stop");
        // createCloudPlot(prefix, "show", false);
      });
    });

      // Update the wind envelope directly after chaning the inputfields
    ['ARRIVAL_WIND_VARIATION', 'DEPARTURE_WIND_VARIATION', 'ARRIVAL_WIND_GUST', 'DEPARTURE_WIND_GUST', 'DEPARTURE_WIND_STRENGTH', 'DEPARTURE_WIND_DIRECTION', 'ARRIVAL_WIND_STRENGTH', 'ARRIVAL_WIND_DIRECTION'].forEach(id => {
      document.getElementById(id)?.addEventListener('change', e => {
        const num = Number(String(e?.target?.value ?? '').trim());
        if (!Number.isFinite(num)) return;
        // Get prefix
        const prefix = id.startsWith('DEPARTURE') ? 'DEPARTURE' : 'ARRIVAL';
        // Update the windEnvelope
        window.windEnvelopeMain(prefix);
      });
    });

    // Update departure clock and compute distance/time/arrival
    ['DEPARTURE_clockField', 'ARRIVAL_clockField'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', element => {
            const prefix = id.startsWith('DEPARTURE') ? 'DEPARTURE' : 'ARRIVAL';
            // const timeValue = element.target.value; // "HH:MM" string
            let timeValue = element ? element.target.value : null;
            if (timeValue === "--:--") {
              timeValue = null;
            }
            // Update only the flight info when departure time is changed
            if (prefix === 'DEPARTURE') {
                // Update the flightinfo fields
                UpdateFlightInfoFields(timeValue, true, true)  // initialize=true, adjustZoom=true
            }
        });
    });

    function actionOnRunwayChange(elementOrEvent) {
      console.log('> func: updateRunwayGUIfields()')
      // Determine prefix based on the field's id
      let element = elementOrEvent?.target || elementOrEvent;
      let prefix = element.id.startsWith('DEPARTURE') ? 'DEPARTURE' : 'ARRIVAL';
      setRunwaySurface(prefix);
      windEnvelopeMain(prefix);
      displayRunwayMain(prefix);
    }

    // Setup event listeners for RUNWAY fields
    ['DEPARTURE_RUNWAY_NR', 'ARRIVAL_RUNWAY_NR'].forEach(id => {
        const field = document.getElementById(id);
        if (!field) return;

        // Trigger on blur
        field.addEventListener("blur", actionOnRunwayChange);
        // Trigger on Enter key
        field.addEventListener('keydown', fieldEvent => {
            if (fieldEvent.key === 'Enter') {
                actionOnRunwayChange(fieldEvent);
            }
        });
    });

    // Generic ICAO validation and loading function
    function validateAndLoadICAO(elementOrEvent, forceLoad = false) {
        const element = elementOrEvent?.target || elementOrEvent;
        if (!element?.id) return false;

        const prefix = element.id.startsWith('DEPARTURE') ? 'DEPARTURE' : 'ARRIVAL';
        const value = String(element.value || '').trim();

        // Return if no icoa name is available
        if (value === '' && !forceLoad) return true;

        // Show warning if icoa length is incorrect
        if (value.length > 0 && value.length < 4) {
            window.alert(`ICAO for ${prefix.toLowerCase()} requires exactly 4 characters.`);
            window.clear_aerodrome_fields(prefix);
            document.getElementById(`${prefix}_CITY`).textContent = `‚ö†Ô∏è ${prefix}`;
            return false;
        }

        // If the length of ICAO is correct
        if (value.length === 4) {
            // later, anywhere:
            const ICAO = getIcaoInformation(element.value)
            // Load ICAO data
            if (ICAO) {
              // Download the country and populate the selectionboxes
              import_country_selected(prefix, ICAO.country, UNZIPK)
              // Set the selection to the country
              select = document.getElementById(`${prefix}_COUNTRY`);
              for (let i = 0; i < select.options.length; i++) {
                  if (select.options[i].value === ICAO.country) {
                      select.selectedIndex = i;
                      break;
                  }
              }

              // Download and populate the ICAO information
              populate_aerodrome_fields_from_icao(prefix, ICAO.city_icao)
              // Set the selection to the country
              select = document.getElementById(`${prefix}_ICAO_CITY`);
              for (let i = 0; i < select.options.length; i++) {
                  console.log(select.options[i].value)
                  if (select.options[i].value === ICAO.city_icao) {
                      select.selectedIndex = i;
                      break;
                  }
              }
            }
            // Load aerodrome from json
            window.load_aerodrome_from_json(prefix, element.id);
        }

        return true;
    }

    // Setup event listeners for ICAO fields
    ['DEPARTURE_ICAO', 'ARRIVAL_ICAO'].forEach(id => {
        const field = document.getElementById(id);
        if (!field) return;

        // Trigger on blur
        field.addEventListener("blur", validateAndLoadICAO);
        // Trigger on Enter key
        field.addEventListener('keydown', field => {
            if (field.key === 'Enter') {
                validateAndLoadICAO(field);
            }
        });
    });

    // Refactored handlePlaneClick
    function handlePlaneClick() {
        console.log("> func: handlePlaneClick()");
        const element_dep = document.getElementById('DEPARTURE_ICAO');
        const element_arr = document.getElementById('ARRIVAL_ICAO');

        for (const element of [element_dep, element_arr]) {
            if (!element) continue;

            // Use the generic function with forceLoad = true to check non-empty fields
            const value = element.value.trim();
            if (value !== '') {
                const isValid = validateAndLoadICAO(element, true);
                if (!isValid) return;
            }
        }
    }


    // Update the aerodrome only when the load buttons/icons are clicked (do NOT trigger on clicking the ICAO text fields)
    ['DEPARTURE_LOAD_ICAO', 'ARRIVAL_LOAD_ICAO'].forEach(id => {
      const e = document.getElementById(id);
      if (!e) return;
      e.addEventListener('click', ev => {
        // Prefer the event's currentTarget id (safe even if a child element was clicked)
        const fieldId = ev?.currentTarget?.id ?? id;
        const prefix = fieldId.startsWith('DEPARTURE') ? 'DEPARTURE' : 'ARRIVAL';
        const icaoSelected = document.getElementById(`${prefix}_ICAO_CITY`).value;

        // At least 4 chars is required for the icao
        const element = document.getElementById(`${prefix}_ICAO`);
        const icao = String(element?.value ?? '').trim();

        // FIX: Check if ICAO is empty
        if (!icao || icao.length === 0) {
          alert(`‚ö†Ô∏è Please select or enter the ${prefix.toLowerCase()} ICAO code first.`);
          return;
        }

        // Too short ‚Äî do nothing
        if (icao.length >= 1 && icao.length < 4) {
          alert(`‚ö†Ô∏è The ICAO code must be at least 4 characters (${prefix.toLowerCase()})`);
          return;
        }
        // Ask user for confirmation before continuing
        if (!confirm(`Are you sure you want to load the selected aerodrome for ${prefix.toLowerCase()}? This will overwrite any unsaved changes in the current fields.`)) {
          return;
        }

        // Clean the aerodrome fields to avoid data leakage
        window.clear_aerodrome_fields(prefix);
        // Populate with default aerodrome data from the zip file
        populate_aerodrome_fields_from_icao(prefix, icaoSelected, false);
      });
    });

    // Update the aerodrome directly after clicking one the icon
    ['DEPARTURE_USE_CACHED', 'ARRIVAL_USE_CACHED'].forEach(id => {
      const e = document.getElementById(id);
      if (!e) return;
        e.addEventListener('click', e => {
        // Prefer the event's currentTarget id (safe even if a child element was clicked)
        const field = e?.currentTarget?.id ?? id;
        const prefix = field.startsWith('DEPARTURE') ? 'DEPARTURE' : 'ARRIVAL';
        const metarField = '';
        // Retrieve METAR based on the text input field
        window.retrieve_metar(prefix, 'info', metarField);
      });
    });


    // Update the aerodrome directly after clicking one the icon
    ['DEPARTURE_ANIMATION_METARTEXT', 'ARRIVAL_ANIMATION_METARTEXT'].forEach(id => {
      const e = document.getElementById(id);
      if (!e) return;
        e.addEventListener('click', e => {
        // Prefer the event's currentTarget id (safe even if a child element was clicked)
        const field = e?.currentTarget?.id ?? id;
        const prefix = field.startsWith('DEPARTURE') ? 'DEPARTURE' : 'ARRIVAL';
        // Get the METAR from the text field
        const metarField = document.getElementById(`METAR-FIELD-${prefix}`).value;
        // Retrieve METAR based on the text input field
        window.retrieve_metar(prefix, 'info', metarField);
      });
    });


    // Update the weight and balance directly after changing the value
    [
      'SETTINGS_WEIGHT_FUEL_LITERS', 'SETTINGS_WEIGHT_PILOT', 'SETTINGS_WEIGHT_COPILOT',
      'SETTINGS_WEIGHT_REAR_RIGHT', 'SETTINGS_WEIGHT_REAR_LEFT', 'SETTINGS_WEIGHT_BAGAGE',
      'DEPARTURE_WEIGHT_FUEL_LITERS', 'DEPARTURE_WEIGHT_PILOT', 'DEPARTURE_WEIGHT_COPILOT',
      'DEPARTURE_WEIGHT_REAR_RIGHT', 'DEPARTURE_WEIGHT_REAR_LEFT', 'DEPARTURE_WEIGHT_BAGAGE',
      'ARRIVAL_WEIGHT_FUEL_LITERS', 'ARRIVAL_WEIGHT_PILOT', 'ARRIVAL_WEIGHT_COPILOT',
      'ARRIVAL_WEIGHT_REAR_RIGHT', 'ARRIVAL_WEIGHT_REAR_LEFT', 'ARRIVAL_WEIGHT_BAGAGE',
      'aircraft_fuel_density', 'weight_empty', 'arm_empty', 'arm_pilot', 'arm_copilot',
      'arm_rl', 'arm_rr', 'arm_bagage', 'arm_fuel',
      'x1', 'y1', 'x2', 'y2', 'x3', 'y3', 'x4', 'y4', 'x5', 'y5'
    ].forEach(id => {
        const field = document.getElementById(id);
        if (!field) return;

        const handleWeightInput = (element) => {
            const fieldId = element?.currentTarget?.id ?? id;

            let prefix = 'SETTINGS';
            if (fieldId.startsWith('DEPARTURE')) prefix = 'DEPARTURE';
            if (fieldId.startsWith('ARRIVAL')) prefix = 'ARRIVAL';

            const input = element.currentTarget;
            let rawValue = parseFloat(input.value);

            // Ensure non-negative numeric value
            if (rawValue < 0 || !Number.isFinite(rawValue)) input.value = 0;
            // Compute Weight and Balance and update plot
            window.WeightBalanceMain(prefix);
        };
        // Trigger on blur
        field.addEventListener("blur", handleWeightInput);
        // Trigger on Enter key
        field.addEventListener('keydown', e => e.key === 'Enter' && handleWeightInput(e));
        // Trigger when value is increased/decreased using the button (arrow keys or spinner)
        field.addEventListener('input', handleWeightInput);
    });


    function update_aerodrome_weights_js(prefix) {
        console.log('> func: update_aerodrome_weights_js()');
        // Access the flight plan data
        const matching_pairs = aircraft_matching_pairs().toJs();

        for (const key in matching_pairs) {
            const [cat, item] = matching_pairs[key];
            if (cat === 'WEIGHT') {
                const keyTarget = `${key.replace('SETTINGS', prefix)}`;
                const value = window.flight_plan_data['AIRCRAFT'][cat][item];
                const element = document.getElementById(keyTarget);
                if (element) element.value = value;
                // console.log(`   >Populate GUI field: [${keyTarget}] <- ['AIRCRAFT'][${cat}][${item}]: ${window.flight_plan_data['AIRCRAFT'][cat][item]}`);
            }
        }
        // Calculate weight and balance
        window.WeightBalanceMain(prefix);
    }

    function handleRegistrationClick() {
        console.log("> func: handleRegistrationClick()");
        const callsignField = document.getElementById("CALLSIGN");
        const callsignLabel = document.getElementById("CALLSIGN_LABEL");
        const aircraftField = document.getElementById("AIRCRAFT_TYPE");
        const popField = document.getElementById("POB");

        if (!callsignField || !callsignLabel || !aircraftField) return;
        const callsignValue = String(callsignField.value ?? '').trim();

        if (!callsignValue) {
            callsignLabel.textContent = "REGISTRATION";
            return;
        }

        // Check whether stored aircraft with this callsign exists
        const cacheKey = `AIRCRAFT_${callsignValue}`; // e.g. AIRCRAFT_PH-SVU
        const jsonData = localStorage.getItem(cacheKey);

        if (jsonData) {
            callsignLabel.textContent = "‚úÖ REGISTRATION";

            try {
                const aircraftData = JSON.parse(jsonData);
                // Store aircraft data globally for PyScript
                window.flight_plan_data["AIRCRAFT"] = aircraftData;
                // Set the aircraft type
                if (aircraftData.TYPE !== '') aircraftField.value = aircraftData.TYPE;
                // Count POB
                let positiveCount = 0;
                ['pilot', 'copilot', 'passenger_left', 'passenger_right'].forEach(key => {
                    const val = window.flight_plan_data['AIRCRAFT']['WEIGHT']?.[key] ?? '';
                    const num = Number(String(val).trim());
                    if (Number.isFinite(num) && num > 0) positiveCount++;
                });
                popField.value = String(positiveCount);
                const time_dep_val = document.getElementById('DEPARTURE_clockField').value;

                // Populate aerodromes and aircraft settings
                aircraft_populate_js();
                update_aerodrome_weights_js("DEPARTURE");
                update_aerodrome_weights_js("ARRIVAL");
                // Update METAR
                retrieve_metar('DEPARTURE', verbose='silent')
                retrieve_metar('ARRIVAL', verbose='silent')
                // Compute Fuel per leg
                computeArrivalFuelPerLeg();
                UpdateFlightInfoFields(time_dep_val, false, false);
                // Compute Weight and Balance
                WeightBalanceMain('SETTINGS');
                WeightBalanceMain('DEPARTURE');
                WeightBalanceMain('ARRIVAL');
                // Compute Runway stats
                displayRunwayMain("DEPARTURE");
                displayRunwayMain("ARRIVAL");
                // Highlight any missing fields
                highlightMissingFields();

            } catch (err) {
                console.error("Invalid aircraft data in localStorage", err);
            }
        } else {
            callsignLabel.textContent = "‚ö† REGISTRATION";
            // aircraftField.value = '';
        }
    }

    const aircraftField = document.getElementById('aircraft_field');
    if (aircraftField) {
        const handleAircraftField = (e) => {
            const value = e?.target?.value ?? '';
            const callsignInput = document.getElementById('aircraft_callsign');
            if (callsignInput) callsignInput.value = value;
        };

        // Trigger on blur
        aircraftField.addEventListener('blur', handleAircraftField);
        // Trigger on Enter key
        aircraftField.addEventListener('keydown', e => e.key === 'Enter' && handleAircraftField(e));

    }

    // Add clear cache button handler
    document.getElementById('aircraft_save_btn')?.addEventListener('click', async () => {
      // Make sure the callsign matches the aircraft field
      document.getElementById('aircraft_callsign').value = document.getElementById('aircraft_field').value
      // Save
      window.save_to_json('aircraft_field', 'AIRCRAFT')
    });

    // Add clear cache button handler
    document.getElementById('clear_cache_btn')?.addEventListener('click', async () => {
      /**
      * Clears the browser's cached data and reloads the page.
      * Shows a confirmation dialog before clearing.
      * Displays a loading spinner while clearing.
      *
      * Steps:
      * 1. Shows confirmation dialog
      * 2. If confirmed:
      *   - Shows loading spinner
      *   - Calls window.clear_cache()
      *   - On success: Shows success message and reloads page
      *   - On error: Shows error message
      * 3. Always hides spinner when complete
      *
      */
        if (!confirm('This will clear all saved (cached) data. Are you sure?')) return;

        try {
            if (await window.clear_cache()) {
                alert('‚úÖ Cache cleared successfully! SkyWalk will now reload.');
                location.reload();
            } else { alert('‚ö†Ô∏è Error clearing the cache. Please try again.'); }
        } catch (error) {
            alert('‚ö†Ô∏è An error occurred while clearing the cache: ' + error);
        } finally {
            spinner.style.display = 'none';
        }
    });


    function getGUIfields() {
        GUIfields = {
          'FLIGHTPLAN': {
              element: document.getElementById('FLIGHTPLAN'),
              name: 'Flightplan Name',
              color_empty: '#ffeb3b',
              color_filled: 'transparent',
              required_atc_departure: false,
              required_atc_arrival: false,
              required_atc_enroute: false,
          },
          'CALLSIGN': {
                element: document.getElementById('CALLSIGN'),
                name: 'Callsign',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: true,
                required_atc_arrival: true,
                required_atc_enroute: true,
            },
            'AIRCRAFT_TYPE': {
                element: document.getElementById('AIRCRAFT_TYPE'),
                name: 'Aircraft Type',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: true,
                required_atc_arrival: true,
                required_atc_enroute: true,
            },
            'POB': {
                element: document.getElementById('POB'),
                name: 'Persons on Board',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: true,
                required_atc_arrival: true,
                required_atc_enroute: true,
            },
            'DEPARTURE_ATC_TOWER': {
                element: document.getElementById('DEPARTURE_ATC_TOWER'),
                name: 'Departure Tower Frequency',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: true,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'DEPARTURE_ATC_ATIS_FREQ': {
                element: document.getElementById('DEPARTURE_ATC_ATIS_FREQ'),
                name: 'Departure ATIS Frequency',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'DEPARTURE_ATC_GROUND': {
                element: document.getElementById('DEPARTURE_ATC_GROUND'),
                name: 'Departure Ground Frequency',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'DEPARTURE_ATC_APPROACH': {
                element: document.getElementById('DEPARTURE_ATC_APPROACH'),
                name: 'Departure Frequency Approach',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'DEPARTURE_ATC_TELEPHONE': {
                element: document.getElementById('DEPARTURE_ATC_TELEPHONE'),
                name: 'Departure Telephone Number',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'DEPARTURE_ROUTE_ALTITUDE': {
                element: document.getElementById('DEPARTURE_ROUTE_ALTITUDE'),
                name: 'Departure Route Altitude',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: true,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'DEPARTURE_ROUTE_NAME': {
                element: document.getElementById('DEPARTURE_ROUTE_NAME'),
                name: 'Departure Route Name',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: true,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'DEPARTURE_RUNWAY_NR': {
                element: document.getElementById('DEPARTURE_RUNWAY_NR'),
                name: 'Departure Runway',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: true,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'DEPARTURE_POSITION': {
                element: document.getElementById('DEPARTURE_POSITION'),
                name: 'Departure Position',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: true,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'DEPARTURE_NAME': {
                element: document.getElementById('DEPARTURE_NAME'),
                name: 'Departure Airport Name',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: true,
                required_atc_arrival: false,
                required_atc_enroute: true,
            },
            'DEPARTURE_ICAO': {
                element: document.getElementById('DEPARTURE_ICAO'),
                name: 'Departure ICAO',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: true,
                required_atc_arrival: false,
                required_atc_enroute: true,
            },
            'ARRIVAL_POSITION': {
                element: document.getElementById('ARRIVAL_POSITION'),
                name: 'Arrival Position',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'ARRIVAL_NAME': {
                element: document.getElementById('ARRIVAL_NAME'),
                name: 'Arrival Airport Name',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: true,
                required_atc_enroute: true,
            },
            'ARRIVAL_ICAO': {
                element: document.getElementById('ARRIVAL_ICAO'),
                name: 'Arrival ICAO',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: true,
                required_atc_enroute: true,
            },
            'ARRIVAL_RUNWAY_NR': {
                element: document.getElementById('ARRIVAL_RUNWAY_NR'),
                name: 'Arrival Runway',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: true,
                required_atc_enroute: false,
            },
            'ARRIVAL_ROUTE_NAME': {
                element: document.getElementById('ARRIVAL_ROUTE_NAME'),
                name: 'Arrival Route Name',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: true,
                required_atc_enroute: false,
            },
            'ARRIVAL_ROUTE_ALTITUDE': {
                element: document.getElementById('ARRIVAL_ROUTE_ALTITUDE'),
                name: 'Arrival Route Altitude',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: true,
                required_atc_enroute: false,
            },
            'ARRIVAL_CIRCUIT_ALTITUDE': {
                element: document.getElementById('ARRIVAL_CIRCUIT_ALTITUDE'),
                name: 'Arrival Circuit Altitude',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: true,
                required_atc_enroute: false,
            },
            'ARRIVAL_ATC_TOWER': {
                element: document.getElementById('ARRIVAL_ATC_TOWER'),
                name: 'Arrival Tower Frequency',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: true,
                required_atc_enroute: false,
            },
            'ARRIVAL_ATC_ATIS_FREQ': {
                element: document.getElementById('ARRIVAL_ATC_ATIS_FREQ'),
                name: 'Arrival ATIS Frequency',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'ARRIVAL_ATC_GROUND': {
                element: document.getElementById('ARRIVAL_ATC_GROUND'),
                name: 'Arrival Ground Frequency',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'ARRIVAL_ATC_APPROACH': {
                element: document.getElementById('ARRIVAL_ATC_APPROACH'),
                name: 'Arrival Frequency Approach',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'ARRIVAL_ATC_TELEPHONE': {
                element: document.getElementById('ARRIVAL_ATC_TELEPHONE'),
                name: 'Arrival Telephone Number',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },

            'FIC_NAME': {
                element: document.getElementById('FIC_NAME'),
                name: 'FIC Name',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: true,
            },
            'FIC_FREQUENCY': {
                element: document.getElementById('FIC_FREQUENCY'),
                name: 'FIC Frequency',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: true,
            },
            'OVERHEAD': {
                element: document.getElementById('OVERHEAD'),
                name: 'Overhead',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: true,
            },
            'SQUAWK': {
                element: document.getElementById('SQUAWK'),
                name: 'Squawk',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: true,
            },

            // THE RUNWAY FIELDS
            'DEPARTURE_RUNWAY_LENGTH': {
                element: document.getElementById('DEPARTURE_RUNWAY_LENGTH'),
                name: 'Runway Length (departure)',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },

            'DEPARTURE_RUNWAY_SLOPE': {
                element: document.getElementById('DEPARTURE_RUNWAY_SLOPE'),
                name: 'Runway Slope (departure)',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },

            'DEPARTURE_RUNWAY_SURFACE': {
                element: document.getElementById('DEPARTURE_RUNWAY_SURFACE'),
                name: 'Runway Surface (departure)',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },

            'DEPARTURERUNWAY_SLIPPERY': {
                element: document.getElementById('DEPARTURE_RUNWAY_SLIPPERY'),
                name: 'Runway Condition (departure)',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },

            'DEPARTURE_RUNWAY_SLIPPERY': {
                element: document.getElementById('DEPARTURE_RUNWAY_SLIPPERY'),
                name: 'Runway Condition (departure)',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },

            'DEPARTURE_ELEVATION': {
                element: document.getElementById('DEPARTURE_ELEVATION'),
                name: 'Runway Elevation (departure)',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },

            'DEPARTURE_CIRCUIT_ALTITUDE': {
                element: document.getElementById('DEPARTURE_CIRCUIT_ALTITUDE'),
                name: 'Departure Circuit Altitude',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },

            // THE RUNWAY FIELDS
            'ARRIVAL_RUNWAY_LENGTH': {
                element: document.getElementById('ARRIVAL_RUNWAY_LENGTH'),
                name: 'Runway Length (arrival)',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },

            'ARRIVAL_RUNWAY_SLOPE': {
                element: document.getElementById('ARRIVAL_RUNWAY_SLOPE'),
                name: 'Runway Slope (arrival)',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },

            'ARRIVAL_RUNWAY_SURFACE': {
                element: document.getElementById('ARRIVAL_RUNWAY_SURFACE'),
                name: 'Runway Surface (arrival)',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },

            'ARRIVAL_RUNWAY_SURFACE': {
                element: document.getElementById('ARRIVAL_RUNWAY_SURFACE'),
                name: 'Runway Condition (arrival)',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },

            'ARRIVAL_RUNWAY_SLIPPERY': {
                element: document.getElementById('ARRIVAL_RUNWAY_SLIPPERY'),
                name: 'Runway Condition (arrival)',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },

            'ARRIVAL_ELEVATION': {
                element: document.getElementById('ARRIVAL_ELEVATION'),
                name: 'Runway Elevation (arrival)',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },

            'ARRIVAL_ATC_APPROACH': {
                element: document.getElementById('ARRIVAL_ATC_APPROACH'),
                name: 'Arrival Frequency Approach',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'ARRIVAL_ATC_TELEPHONE': {
                element: document.getElementById('ARRIVAL_ATC_TELEPHONE'),
                name: 'Arrival Telephone Number',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            // DEPARTURE WIND
            'DEPARTURE_WIND_DIRECTION': {
                element: document.getElementById('DEPARTURE_WIND_DIRECTION'),
                name: 'Departure Wind Direction',
                color_empty: "#ffeb3b",
                color_filled: 'transparent',
                required_atc_departure: true,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'DEPARTURE_WIND_STRENGTH': {
                element: document.getElementById('DEPARTURE_WIND_STRENGTH'),
                name: 'Departure Wind Speed',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: true,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'DEPARTURE_WIND_GUST': {
                element: document.getElementById('DEPARTURE_WIND_GUST'),
                name: 'Departure Wind Gust',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'DEPARTURE_WIND_VARIATION': {
                element: document.getElementById('DEPARTURE_WIND_VARIATION'),
                name: 'Departure Wind Variation',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'DEPARTURE_TEMPERATURE': {
                element: document.getElementById('DEPARTURE_TEMPERATURE'),
                name: 'Departure Temperature',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'DEPARTURE_QNH': {
                element: document.getElementById('DEPARTURE_QNH'),
                name: 'Departure QNH',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            // ARRIVAL WIND
            'ARRIVAL_WIND_DIRECTION': {
                element: document.getElementById('ARRIVAL_WIND_DIRECTION'),
                name: 'Arrival Wind Direction',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: true,
                required_atc_enroute: false,
            },
            'ARRIVAL_WIND_STRENGTH': {
                element: document.getElementById('ARRIVAL_WIND_STRENGTH'),
                name: 'Arrival Wind Speed',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: true,
                required_atc_enroute: false,
            },
            'ARRIVAL_WIND_GUST': {
                element: document.getElementById('ARRIVAL_WIND_GUST'),
                name: 'Arrival Wind Gust',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'ARRIVAL_WIND_VARIATION': {
                element: document.getElementById('ARRIVAL_WIND_VARIATION'),
                name: 'Arrival Wind Variation',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'ARRIVAL_TEMPERATURE': {
                element: document.getElementById('ARRIVAL_TEMPERATURE'),
                name: 'Arrival Temperature',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'ARRIVAL_QNH': {
                element: document.getElementById('ARRIVAL_QNH'),
                name: 'Arrival QNH',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            //ENROUTE FIELDS
            'FIC_NAME2': {
                element: document.getElementById('FIC_NAME2'),
                name: 'FIC2 Name',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'FIC_FREQUENCY2': {
                element: document.getElementById('FIC_FREQUENCY2'),
                name: 'FIC2 Frequency',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'OVERHEAD2': {
                element: document.getElementById('OVERHEAD2'),
                name: 'Overhead (second)',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
            'SQUAWK2': {
                element: document.getElementById('SQUAWK2'),
                name: 'Squawk (second)',
                color_empty: '',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: false,
                required_atc_enroute: false,
            },
        };

        // UPDATE THE EXCEPTIONS WHEN CTR IS USED
        if (DEPARTURE_CTR.value === 'CTR') {
            GUIfields.DEPARTURE_ATC_ATIS_FREQ = {
                element: document.getElementById('DEPARTURE_ATC_ATIS_FREQ'),
                name: 'Departure ATIS Frequency',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: true,
                required_atc_arrival: false,
                required_atc_enroute: false,
            };
            GUIfields.DEPARTURE_ATC_GROUND = {
                element: document.getElementById('DEPARTURE_ATC_GROUND'),
                name: 'Departure Ground Frequency',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: true,
                required_atc_arrival: false,
                required_atc_enroute: false,
            };
        }
        if (ARRIVAL_CTR.value === 'CTR') {
            GUIfields.ARRIVAL_ATC_ATIS_FREQ = {
                element: document.getElementById('ARRIVAL_ATC_ATIS_FREQ'),
                name: 'Arrival ATIS Frequency',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: true,
                required_atc_enroute: false,
            };
            GUIfields.ARRIVAL_ATC_GROUND = {
                element: document.getElementById('ARRIVAL_ATC_GROUND'),
                name: 'Arrival Ground Frequency',
                color_empty: '#ffeb3b',
                color_filled: 'transparent',
                required_atc_departure: false,
                required_atc_arrival: true,
                required_atc_enroute: false,
            };
        }

        return GUIfields
    }

    const inputs = getGUIfields();
    let missing = [];

    function addTextMissingFields(missing) {
        // Create one big string with all missing labels that is shown in TAB of ATC
        missing_label.textContent = missing.length ? 'Missing: ' + missing.join(', ') : 'All fields are OK! Create your ATC now.';
        if (!missing.length) {
          missing_label.style.fontSize = '12px';
          missing_label.style.color = 'green';
        } else {
          missing_label.style.fontSize = '';
          missing_label.style.color = '';
        }
    }

    function updateGUIField(item, missing) {
        // Update the GUI field with color and add missing label when required for ATC fields
        if (!item.element.value) {

            // If any of the required ATC fields are empty, add the label to the missing array
            if (item.required_atc_departure || item.required_atc_arrival || item.required_atc_enroute) {
              // Only add unique names to avoid duplicates
              if (!missing.includes(item.name)) {
                  missing.push(item.name);
              }
            }
            item.element.style.backgroundColor = item.color_empty;
            // Color the drop-down menu in case fields are missing
        } else {
            item.element.style.backgroundColor = item.color_filled;
        }

    }

    // Catch each keystroke and analyze it
    Object.values(inputs).forEach(item => {
        item.element.addEventListener('input', () => {
            // Update the GUI field
            updateGUIField(item, missing);
            // Add missing label when required for ATC fields
            addTextMissingFields(missing)
        });
    });


    // Update dropdown menu colors based on required fields
    window.highlightDropdownMenus = (function() {
        const aerodromeFieldIds = [
            'DEPARTURE_NAME', 'DEPARTURE_POSITION', 'DEPARTURE_RUNWAY_NR', 'DEPARTURE_ROUTE_NAME', 'DEPARTURE_ROUTE_ALTITUDE',
            'ARRIVAL_NAME', 'ARRIVAL_POSITION', 'ARRIVAL_RUNWAY_NR', 'ARRIVAL_ROUTE_NAME', 'ARRIVAL_ROUTE_ALTITUDE'
        ];

        const contactFieldIds = [
            'DEPARTURE_ATC_TOWER', 'DEPARTURE_ATC_GROUND', 'DEPARTURE_ATC_ATIS_FREQ',
            'ARRIVAL_ATC_TOWER', 'ARRIVAL_ATC_GROUND', 'ARRIVAL_ATC_ATIS_FREQ',
        ];

        const metarFieldIds = [
            'DEPARTURE_WIND_DIRECTION', 'DEPARTURE_WIND_DIRECTION',
            'ARRIVAL_WIND_DIRECTION', 'ARRIVAL_WIND_DIRECTION',
        ];

        const highlightDropdownMenu = (prefix) => {
            const elementAerodrome = document.getElementById(`${prefix}_AERODROME_MENU_TOP`);
            if (!elementAerodrome) {
                console.warn(`Missing AERODROME_MENU element for ${prefix}`);
                return;
            }

            const elementName = document.getElementById(`${prefix}_NAME`);
            const elementPosition = document.getElementById(`${prefix}_POSITION`);
            const elementRunway = document.getElementById(`${prefix}_RUNWAY_NR`);
            const elementRoute = document.getElementById(`${prefix}_ROUTE_NAME`);
            const elementAltitude = document.getElementById(`${prefix}_ROUTE_ALTITUDE`);

            const nameVal = elementName?.value ?? '';
            const posVal = elementPosition?.value ?? '';
            const rwyVal = elementRunway?.value ?? '';
            const routeVal = elementRoute?.value ?? '';
            const altVal = elementAltitude?.value ?? '';

            let allFilled;
            if (prefix === 'ARRIVAL') {
                allFilled = nameVal !== '' && rwyVal !== '' && routeVal !== '' && altVal !== '';
            } else {
                allFilled = nameVal !== '' && posVal !== '' && rwyVal !== '' && routeVal !== '' && altVal !== '';
            }

            let TopMenuColor = window.DEFAULTCOLOR
            if (prefix === "DEPARTURE") {
              metarObject = window.METAR_DEPARTURE;
            } else {
              metarObject = window.METAR_ARRIVAL;
            }
            if (metarObject) TopMenuColor = metarObject.color;

            elementAerodrome.style.backgroundColor = allFilled ? TopMenuColor : window.EMPTYCOLOR;
            elementAerodrome.textContent = allFilled ? "‚úÖ AERODROME" : "‚ö†Ô∏è AERODROME";
        };

        const updateContactColor = (prefix) => {
            const elementContact = document.getElementById(`${prefix}_CONTACT_MENU`);
            if (!elementContact) {
                console.warn(`Missing CONTACT_MENU element for ${prefix}`);
                return;
            }

            const elementCTR = document.getElementById(`${prefix}_CTR`);
            const elementTower = document.getElementById(`${prefix}_ATC_TOWER`);
            const elementGround = document.getElementById(`${prefix}_ATC_GROUND`);
            const elementATIS = document.getElementById(`${prefix}_ATC_ATIS_FREQ`);

            const towerVal = elementTower?.value ?? '';
            const groundVal = elementGround?.value ?? '';
            const atisVal = elementATIS?.value ?? '';
            const ctrValue = elementCTR?.value ?? '';

            let allFilled;
            if ((prefix === 'DEPARTURE' || prefix === 'ARRIVAL') && ctrValue === 'CTR') {
                allFilled = towerVal !== '' && groundVal !== '' && atisVal !== '';
            } else if (ctrValue !== 'CTR') {
                allFilled = towerVal !== '';
            } else {
                allFilled = false;
            }

            let TopMenuColor = window.DEFAULTCOLOR
            if (prefix === "DEPARTURE") {
              metarObject = window.METAR_DEPARTURE;
            } else {
              metarObject = window.METAR_ARRIVAL;
            }
            if (metarObject) TopMenuColor = metarObject.color;

            elementContact.style.backgroundColor = allFilled ? TopMenuColor : window.EMPTYCOLOR;
            elementContact.textContent = allFilled ? "‚úÖ CONTACT" : "‚ö†Ô∏è CONTACT";
        };

        const updateMetarColor = (prefix) => {
            const elementContact = document.getElementById(`${prefix}_METARMENU_TOP`);
            if (!elementContact) {
                console.warn(`Missing _METARMENU_TOP element for ${prefix}`);
                return;
            }

            const element1 = document.getElementById(`${prefix}_WIND_DIRECTION`);
            const element2 = document.getElementById(`${prefix}_WIND_STRENGTH`);

            const windDirection = element1?.value ?? '';
            const windStrength = element2?.value ?? '';
            const allFilled = windDirection !== '' && windStrength !== '';

            let TopMenuColor = window.DEFAULTCOLOR;
            let metarObject;
            if (prefix === "DEPARTURE") {
              metarObject = window.METAR_DEPARTURE;
            } else {
              metarObject = window.METAR_ARRIVAL;
            }
            if (metarObject) {
              TopMenuColor = metarObject.color;
            }
            // if (metarObject) {
            //   TopMenuColor = metarObject.color;
            //   const metarTime = metarObject.dateTime.date;
            //   const maxMinutes = 60;
            //   // Parse the NOW date parts
            //   const now = nowtime(false);
            //   const currenTime = createTimeObject(now);
            //   const diff = Math.abs(currenTime - metarTime);
            //   const isOld = diff > maxMinutes * 60 * 1000; // 35 minutes in milliseconds
            //   const minutesOld = Math.round(diff / 1000 / 60);
            //   // Create text content
            //   elementContact.textContent = `‚ö†Ô∏è METAR - ${minutesOld} min.`;
            // } else {
            //   elementContact.textContent = allFilled ? "‚úÖ METAR" : "‚ö†Ô∏è METAR";
            // }
            elementContact.style.backgroundColor = allFilled ? TopMenuColor : window.EMPTYCOLOR;

        };

        const handleAerodromeEvent = (e) => {
            const targetId = e.target.id;
            const prefix = targetId.startsWith('DEPARTURE') ? 'DEPARTURE' : 'ARRIVAL';
            highlightDropdownMenu(prefix);
        };

        const handleContactEvent = (e) => {
            const targetId = e.target.id;
            const prefix = targetId.startsWith('DEPARTURE') ? 'DEPARTURE' : 'ARRIVAL';
            updateContactColor(prefix);
        };

        const handleMetarEvent = (e) => {
            const targetId = e.target.id;
            const prefix = targetId.startsWith('DEPARTURE') ? 'DEPARTURE' : 'ARRIVAL';
            updateMetarColor(prefix);
        };

        // Attach listeners for aerodrome fields
        aerodromeFieldIds.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('input', handleAerodromeEvent);
            el.addEventListener('keydown', handleAerodromeEvent);
            el.addEventListener('change', handleAerodromeEvent);
        });

        // Attach listeners for contact fields
        contactFieldIds.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('input', handleContactEvent);
            el.addEventListener('keydown', handleContactEvent);
            el.addEventListener('change', handleContactEvent);
        });

        // Attach listeners for contact fields
        metarFieldIds.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('input', handleMetarEvent);
            el.addEventListener('keydown', handleMetarEvent);
            el.addEventListener('change', handleMetarEvent);
        });

        // Return a public function to manually trigger updates
        return function(prefix = null) {
            const prefixes = prefix ? [prefix] : ['DEPARTURE', 'ARRIVAL'];
            prefixes.forEach(p => {
                highlightDropdownMenu(p);
                updateContactColor(p);
                updateMetarColor(p);
            });
        };
    })();



    // Function to check for missing fields and update highlighting
    function highlightMissingFields() {
      console.log("> func: highlightMissingFields()");
        const inputs = getGUIfields();
        const missing = [];
        // Loop through and highlight empty fields
        Object.entries(inputs).forEach(([key, item]) => {
          // Update the GUI field
            updateGUIField(item, missing);
        });
        // Add missing label when required for ATC fields
        addTextMissingFields(missing);
    }

  </script>

</body>
</html>




<script>

  // Populate during startup: available-countries select from COUNTRIES_DATA
  // window.addEventListener('DOMContentLoaded', () => {
  //   // Create lookup tables for countries
  //   CreateLookupTableCountries();
  //   // Populate the multipdropbox in the config screen
  //   populateAvailableCountries()
  //   // Load from previously stored countries from cache
  //   const uniqueCountries = LoadCountriesOfInterest();
  //   // Set the multibox items
  //   console.log(uniqueCountries)
  //   moveCountries('available-countries', 'selected-countries', 'initialize', uniqueCountries)
  // });

</script>

<script>
const spinner = document.getElementById("import_aircraft_spinner");

// Populate on first open, so AIRCRAFT_LIST is guaranteed to exist by then
spinner.addEventListener("mousedown", () => {
    if (spinner.dataset.populated) return;
    spinner.dataset.populated = "1";
    (window.AIRCRAFT_LIST || []).forEach(ac => {
        const opt = document.createElement("option");
        opt.value = ac.url;
        opt.textContent = ac.label;
        spinner.appendChild(opt);
    });
}, { once: false });

document.getElementById("import_and_save_btn").addEventListener("click", async () => {
    const url = spinner.value;
    if (!url) return alert("Please select an aircraft first.");
    const btn = document.getElementById("import_and_save_btn");
    btn.textContent = "‚è≥";
    try {
        await importCacheEntryFromUrl(url);
        btn.textContent = "‚úÖ";
        setTimeout(() => btn.textContent = "üì•", 2000);
        updateDropdown('aircraft_spinner', 'AIRCRAFT', false);
        alert("Aircraft is imported and can now be used.");
    } catch (err) {
        btn.textContent = "‚ùå";
        setTimeout(() => btn.textContent = "üì•", 2000);
        alert(err.message);
    }
});

document.getElementById("aircraft_download_btn").addEventListener("click", () => {
    // Cache key
    const cacheKey = "AIRCRAFT_" + document.getElementById("aircraft_spinner").value;
    // Get from local storage
    const data = localStorage.getItem(cacheKey);
    if (!data) return alert(`No cached data found for ${cacheKey}`);
    // Download json file
    downloadCacheEntry(cacheKey)
});

</script>





<script>

    function initializeAerodromeFields(fname) {
        // Download the aerodrome data when the country changes
        document.getElementById(`${fname}_COUNTRY`).addEventListener('change', async function() {
            const country = this.value;
            if (country) {
                document.body.style.cursor = 'wait';
                document.body.style.overflow = 'hidden';  // Prevent scrolling while loading
                try {
                    await window.import_country_selected(fname, country, UNZIPK);
                } catch (error) {
                    console.error("‚ö†Ô∏è Error importing aerodrome data:", error);
                    alert("‚ö†Ô∏è Error loading aerodrome data. Please try again.");
                } finally {
                    // spinner.style.display = 'none';
                    document.body.style.cursor = '';
                    document.body.style.overflow = '';  // Restore scrolling
                }
            }
        });

        // populate fields when ICAO city is selected. searchwords: icao selection, icao dropbox, icao spinner
        document.getElementById(`${fname}_ICAO_CITY`).addEventListener('change', async function() {
            // Get ICAO
            const city_icao = this.value;
            // Clear all aerodrome fields first to prevent data leakage
            await window.clear_aerodrome_fields(fname, false);
            // Clear all enroute fields first to prevent data leakage
            if (fname === 'DEPARTURE') {
                await window.clear_enroute_fields();
            }

            if (city_icao) {
                // Call PyScript function to populate fields
                await window.populate_aerodrome_fields_from_icao(fname, city_icao);
                // Update missing fields
                // highlightMissingFields();
                // highlightDropdownMenus();
            }
        });

        // Auto-save aerodrome data when fields change
        const fields = [
            `${fname}_COUNTRY`,
            `${fname}_ICAO_CITY`,
            `${fname}_CITY`,
            `${fname}_CTR`,
            `${fname}_NAME`,
            `${fname}_ICAO`,
            `${fname}_POSITION`,
            `${fname}_RUNWAY_NR`,
            `${fname}_RUNWAY_LENGTH`,
            `${fname}_RUNWAY_SLOPE`,
            `${fname}_RUNWAY_SURFACE`,
            `${fname}_RUNWAY_CONDITION`,
            `${fname}_RUNWAY_SLIPPERY`,
            `${fname}_ELEVATION`,
            `${fname}_ROUTE_NAME`,
            `${fname}_ROUTE_ALTITUDE`,
            `${fname}_CIRCUIT_ALTITUDE`,
            `${fname}_ATC_TOWER`,
            `${fname}_ATC_APPROACH`,
            `${fname}_ATC_ATIS_FREQ`,
            `${fname}_ATC_GROUND`,
            `${fname}_ATC_TELEPHONE`
        ];

        fields.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element) {
                element.addEventListener('change', () => {
                    if (window.flight_plan_data) {
                        window.flight_plan_data[fieldId] = element.value;
                        console.log(`Updated ${fieldId}:`, element.value);
                    }
                    if (
                        fieldId.endsWith('_ROUTE_NAME') ||
                        fieldId.endsWith('_ROUTE_ALTITUDE') ||
                        fieldId.endsWith('_CIRCUIT_ALTITUDE')
                    ) {
                      // alert('update cloud plot');
                      createCloudPlot(fname, "show", true)
                    }
                });
            }
        });
    }

    // Initialize with DEPARTURE
    initializeAerodromeFields('DEPARTURE');
    initializeAerodromeFields('ARRIVAL');

</script>
